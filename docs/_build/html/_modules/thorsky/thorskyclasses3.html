
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>thorsky.thorskyclasses3 &#8212; thorsky 0.0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">thorsky 0.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for thorsky.thorskyclasses3</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;thorskyclasses.py -- classes used for observational</span>
<span class="sd">   circumstances.  </span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="k">import</span> <span class="n">SkyCoord</span><span class="p">,</span> <span class="n">Angle</span><span class="p">,</span> <span class="n">EarthLocation</span><span class="p">,</span> <span class="n">CartesianRepresentation</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="k">import</span> <span class="n">FK5</span><span class="p">,</span> <span class="n">PrecessedGeocentric</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="k">import</span> <span class="n">solar_system_ephemeris</span><span class="p">,</span> <span class="n">get_body_barycentric</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="k">import</span> <span class="n">get_body</span><span class="p">,</span> <span class="n">get_moon</span><span class="p">,</span> <span class="n">get_sun</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="k">import</span> <span class="n">Time</span><span class="p">,</span> <span class="n">TimeDelta</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pytz</span> <span class="k">import</span> <span class="n">timezone</span>
<span class="kn">import</span> <span class="nn">pytz</span>

<span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">ttime</span>  
<span class="kn">import</span> <span class="nn">dateutil.parser</span>

<span class="kn">from</span> <span class="nn">thorsky.thorskyutil</span> <span class="k">import</span> <span class="n">altazparang</span><span class="p">,</span><span class="n">lpsidereal</span><span class="p">,</span><span class="n">lpmoon</span><span class="p">,</span><span class="n">lpsun</span><span class="p">,</span><span class="n">accumoon</span><span class="p">,</span><span class="n">min_max_alt</span><span class="p">,</span><span class="n">phase_descr</span>
<span class="kn">from</span> <span class="nn">thorsky.thorskyutil</span> <span class="k">import</span> <span class="n">ha_alt</span><span class="p">,</span> <span class="n">jd_sun_alt</span><span class="p">,</span> <span class="n">jd_moon_alt</span><span class="p">,</span> <span class="n">local_midnight_Time</span><span class="p">,</span> <span class="n">hrs_up</span>
<span class="kn">from</span> <span class="nn">thorsky.thorskyutil</span> <span class="k">import</span> <span class="n">ztwilight</span><span class="p">,</span> <span class="n">lunskybright</span><span class="p">,</span> <span class="n">true_airmass</span>
<span class="kn">from</span> <span class="nn">thorsky.thorskyutil</span> <span class="k">import</span> <span class="n">currentgeocentframe</span><span class="p">,</span> <span class="n">currentFK5frame</span><span class="p">,</span> <span class="n">thorconsts</span>
<span class="kn">from</span> <span class="nn">thorsky.thorskyutil</span> <span class="k">import</span> <span class="n">precessmatrix</span><span class="p">,</span> <span class="n">cel2localmatrix</span><span class="p">,</span> <span class="n">cel2xyz</span>
<span class="kn">from</span> <span class="nn">thorsky.thorskyutil</span> <span class="k">import</span> <span class="n">getbrightest</span><span class="p">,</span> <span class="n">skyproject</span><span class="p">,</span> <span class="n">angle_between</span>
<span class="kn">from</span> <span class="nn">thorsky.thorskyutil</span> <span class="k">import</span> <span class="n">time_rounded_to_minute</span>

<span class="c1"># import matplotlib.pyplot as plt   # for tests</span>
<span class="kn">import</span> <span class="nn">sys</span>  <span class="c1"># for tests</span>

<span class="kn">import</span> <span class="nn">pkgutil</span>   <span class="c1"># to get fixed data</span>

<span class="c1"># import warnings  # to filter ERFA warnings about dubious years </span>
<span class="c1"># Don&#39;t have this working.</span>

<span class="c1"># this is slightly modified cribbed code.</span>
   
<span class="c1">#def fxn():</span>
<span class="c1">#    warnings.warn(&quot;dubious&quot;, ErfaWarning)</span>

<span class="c1">#with warnings.catch_warnings():</span>
<span class="c1">#    warnings.simplefilter(&quot;ignore&quot;)</span>
<span class="c1">#    fxn()</span>

<div class="viewcode-block" id="obs_site"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyclasses3.obs_site">[docs]</a><span class="k">class</span> <span class="nc">obs_site</span> <span class="p">:</span>  <span class="c1"># defaults to MDM.  Arguments are all keyworded.</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Site from which observations are taken.</span>

<span class="sd">    This initializes by default to Kitt Peak.  In practice it is </span>
<span class="sd">    usually specified by using an abbreviation from the list of observatories</span>
<span class="sd">    distributed with the package, &#39;observatories_rev.dat&#39;.  </span>
<span class="sd">    Other arguments are keyworded.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    The core of this is an EarthLocation, but it also includes time zone </span>
<span class="sd">    information and a guess at the height of the observatory above surrounding</span>
<span class="sd">    terrain for adjusting rise and set times for the sun and moon.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;MDM Observatory [Kitt Peak]&quot;</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1996199.</span><span class="p">,</span> <span class="o">-</span><span class="mf">5037542.</span><span class="p">,</span> <span class="mf">3356753.</span><span class="p">),</span>
                 <span class="n">tzstr</span> <span class="o">=</span> <span class="s2">&quot;America/Phoenix&quot;</span><span class="p">,</span> <span class="n">tzstdabbr</span> <span class="o">=</span> <span class="s2">&quot;MST&quot;</span><span class="p">,</span> <span class="n">tzdayabbr</span> <span class="o">=</span> <span class="s2">&quot;MDT&quot;</span><span class="p">,</span>
                 <span class="n">westheight</span> <span class="o">=</span> <span class="mf">700.</span><span class="p">,</span> <span class="n">eastheight</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize an obs_site. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str, optional</span>
<span class="sd">             The full name of the observatory.  Defaults to &quot;MDM Observatory [Kitt Peak]&quot;</span>

<span class="sd">        loc : tuple or list </span>
<span class="sd">             Geocentric cartesian location, in meters.  Default (-1996199., -5037542., 3356753.)</span>
<span class="sd">             If you need to compute these for a new site, see the documentation for </span>
<span class="sd">             astropy.coordinates.EarthLocation, in particular the &quot;from_geodetic&quot; method.</span>

<span class="sd">        tzstr : str</span>
<span class="sd">             time zone name in format used by unix programs; default &quot;America/Phoenix&quot;.</span>

<span class="sd">        tzstdabbr, tzdayabbr : str</span>
<span class="sd">             abbreviations for standard and daylight time in this zone; defaults &quot;MST&quot;,&quot;MDT&quot;</span>

<span class="sd">        westheight, eastheight :</span>
<span class="sd">             rough height of observatory above surrounding terrain, in meters: defaults 700. and 0.</span>
<span class="sd">        </span>
<span class="sd">        Attributes: </span>
<span class="sd">        </span>
<span class="sd">        name : str</span>
<span class="sd">             Name of observatory.</span>

<span class="sd">        location : EarthLocation</span>
<span class="sd">             EarthLocation of the observation site.</span>

<span class="sd">        localtz : timezone</span>
<span class="sd">             Local time zone.</span>

<span class="sd">        localtzabbrev, localtzdayabbrev :</span>
<span class="sd">             Abbreviations for standard and daylight time.</span>

<span class="sd">        risealt, setalt : Angle</span>
<span class="sd">             elevations at which the sun/moon rises or sets.</span>

<span class="sd">        axisdist : Quantity in distance units</span>
<span class="sd">             distance of site from earth&#39;s rotation axis</span>

<span class="sd">        diurnalspeed : Quantity in velocity units</span>
<span class="sd">             speed of diurnal rotation at this site, for use in velocity corrections.</span>
<span class="sd">              </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">EarthLocation</span><span class="p">)</span> <span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">loc</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span><span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="p">:</span>  <span class="c1"># geocentric xyz</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">EarthLocation</span><span class="o">.</span><span class="n">from_geocentric</span><span class="p">(</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">loc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> 
              <span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>  <span class="c1"># MDM</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tzstr</span> <span class="o">=</span> <span class="n">tzstr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">localtz</span> <span class="o">=</span> <span class="n">timezone</span><span class="p">(</span><span class="n">tzstr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">localtzabbrev</span> <span class="o">=</span> <span class="n">tzstdabbr</span>   <span class="c1"># abbrevn for standard time zone</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">localtzdayabbrev</span> <span class="o">=</span> <span class="n">tzdayabbr</span>  <span class="c1"># abbrevn for daylight time zone</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">height_above_west</span> <span class="o">=</span> <span class="n">westheight</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span>    <span class="c1"># height of obs over its west horizon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height_above_east</span> <span class="o">=</span> <span class="n">eastheight</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span>    <span class="c1"># height of obs over its east horizon</span>

        <span class="c1"># compute the altitude at which sunrise and sunset occur, defined as the</span>
        <span class="c1"># top limb of the sun or moon coinciding with the horizon.  In the</span>
        <span class="c1"># absence of terrain effects, this is conventionally at zenith dist</span>
        <span class="c1"># 90 degrees 50 minutes.  In real life higher precision is not useful</span>
        <span class="c1"># because atmospheric refraction varies a great deal at such low</span>
        <span class="c1"># altitudes.  Include in the calculation the possibility that the </span>
        <span class="c1"># observatory is above or below the terrain that forms its horizon,</span>
        <span class="c1"># using a simple approximation for the depression of the horizon.</span>

        <span class="c1"># These altitudes also serve for the moon.  The angular diameter</span>
        <span class="c1"># variation is insignificant for this purpose, again because of </span>
        <span class="c1"># atmospheric refraction.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">risealt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setalt</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">west_depression</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">height_above_west</span><span class="p">)</span>
                            <span class="o">/</span> <span class="p">(</span><span class="n">thorconsts</span><span class="o">.</span><span class="n">EQUAT_RAD</span><span class="p">)))</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span>
<span class="c1">#        print &quot;west_depression&quot;,west_depression</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">height_above_west</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">setalt</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="o">-</span><span class="mf">0.833</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span> <span class="o">-</span> <span class="n">west_depression</span>
                              <span class="c1"># zd = 90 deg 50 arcmin</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">height_above_west</span> <span class="o">&lt;=</span> <span class="mf">0.</span> <span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">setalt</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="o">-</span><span class="mf">0.833</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span> <span class="o">+</span> <span class="n">west_depression</span>

        <span class="n">east_depression</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">height_above_east</span><span class="p">)</span>
                            <span class="o">/</span> <span class="p">(</span><span class="n">thorconsts</span><span class="o">.</span><span class="n">EQUAT_RAD</span><span class="p">)))</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span>
<span class="c1">#        print &quot;east_depression&quot;,east_depression</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">height_above_east</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">risealt</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="o">-</span><span class="mf">0.833</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span> <span class="o">-</span> <span class="n">east_depression</span>
                              <span class="c1"># zd = 90 deg 50 arcmin</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">height_above_east</span> <span class="o">&lt;=</span> <span class="mf">0.</span> <span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">risealt</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="o">-</span><span class="mf">0.833</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span> <span class="o">+</span> <span class="n">east_depression</span>
<span class="c1">#        print &quot;self.risealt = &quot;,self.risealt</span>

<span class="c1"># compute and store the speed of diurnal rotation at this site</span>
<span class="c1"># for later use in barycentric velocity correction.</span>

        <span class="n">axisdist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">y</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">axisdist</span> <span class="o">=</span> <span class="n">axisdist</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span>
        <span class="c1"># one sidereal day is about 86164.09 seconds.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diurnalspeed</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">axisdist</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">86164.09</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span> </div>

<div class="viewcode-block" id="get_sites"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyclasses3.get_sites">[docs]</a><span class="k">def</span> <span class="nf">get_sites</span><span class="p">()</span> <span class="p">:</span>  <span class="c1"># reads from a file of site names.</span>
    <span class="sd">&quot;&quot;&quot;Creates a dictionary of obs_site instances from the file of site parameters</span>
<span class="sd">    provided in the package.  Runs at import time and will probably never need to be</span>
<span class="sd">    called by a user</span>

<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#    inf = open(&quot;observatories_rev.dat&quot;)</span>
    <span class="c1"># use pkgutil since I&#39;m packaging this ... </span>
    <span class="c1">#  https://stackoverflow.com/questions/6028000/how-to-read-a-static-file-from-inside-a-python-package</span>
    <span class="c1"># print(&#39;package name:&#39;,__name__)   # was __package__, which broke in Python 3.</span>
    <span class="n">bytestr</span> <span class="o">=</span> <span class="n">pkgutil</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;observatories_rev.dat&#39;</span><span class="p">)</span> 
    <span class="c1"># this was just a file bu tis now a byte string containing the raw contents of the </span>
    <span class="c1"># file.  Turn it into ASCII and cut into lines, and it&#39;ll read as if it were a file.</span>
    <span class="n">inf</span> <span class="o">=</span> <span class="n">bytestr</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ASCII&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="n">sitedict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">inf</span> <span class="p">:</span>
        <span class="c1"># print(&quot;l = &quot;,l)  # diagnostic -- this took some doing!</span>
        <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;#&#39;</span> <span class="p">:</span>  <span class="c1"># allow commenting out of lines</span>
            <span class="k">try</span> <span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>  <span class="c1"># xyz coordinates in meters as characters</span>
                <span class="n">loc</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">sitedict</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">obs_site</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tzstr</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">tzstdabbr</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                    <span class="n">tzdayabbr</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">eastheight</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span> <span class="n">westheight</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">7</span><span class="p">]))</span>
            <span class="k">except</span> <span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bad input line in get_sites, may not be tab-separated:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sitedict</span></div>

<span class="n">sitedict</span> <span class="o">=</span> <span class="n">get_sites</span><span class="p">()</span>   <span class="c1"># reads site dictionary from package data file &#39;observatories_rev.dat&#39;</span>

<div class="viewcode-block" id="Observation"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyclasses3.Observation">[docs]</a><span class="k">class</span> <span class="nc">Observation</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Circumstances of an observation at a given SkyCoord, obs_site, and time.</span>

<span class="sd">    This is the main class, used to compute time-and-the-sky information.</span>

<span class="sd">    A minimal use example ::</span>
<span class="sd">       </span>
<span class="sd">       import astropy.units as u</span>
<span class="sd">       import thorsky.thorskyutil as tsu</span>
<span class="sd">       import thorsky.thorskyclasses3 as tsc3</span>

<span class="sd">       o = tsc3.Observation()      # defaults to zenith at default site at present moment</span>
<span class="sd">  </span>
<span class="sd">       o.computesky()              # hour angle, airmass, and more</span>
<span class="sd">       o.computesunmoon()          # note that the order in which these are called is important</span>
<span class="sd">       o.computequickbary()</span>
<span class="sd">       o.setnightevents()</span>
<span class="sd">       o.computeplanets()</span>

<span class="sd">       o.printnow()                # see what you have</span>
<span class="sd">       o.printnight() </span>


<span class="sd">    This class has a huge number of attributes.  To avoid unneeded computation,</span>
<span class="sd">    these are mostly left blank unless computed explicitly using the methods </span>
<span class="sd">    provided.</span>

<span class="sd">    The order in which you call the methods that compute results is important</span>
<span class="sd">    since results are cumulative:  In sum:</span>

<span class="sd">    * computesky needs to be first</span>
<span class="sd">    * computesunmoon, if needed, is second.</span>
<span class="sd">    * computequickbary depends on computesky but nothing else</span>
<span class="sd">    * setnightevents depends on both computesky and computesunmoon</span>
<span class="sd">    * hours_up depends on computesky, computesunmoon, and setnightevents</span>
<span class="sd">    * computeplanets depends on computsky and computesunmoon.</span>

<span class="sd">    These have been split out to save compute time.  For example, if you only </span>
<span class="sd">    need airmass, all you need to run is computesky, but if you want to know </span>
<span class="sd">    if the moon is up you need to run computesunmoon as well.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">celest</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">site</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">default_site</span> <span class="o">=</span> <span class="s1">&#39;mdm&#39;</span><span class="p">,</span> 
          <span class="n">use_local_time</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">ra_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">dec_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Parameters :</span>

<span class="sd">        celest : SkyCoord, or string, or list, or tuple; optional</span>
<span class="sd">            Celestial location of the observation.  Defaults to the zenith for the site and time.</span>
<span class="sd">            A wide variety of input formats are permissible; see &#39;setcelest&#39; below.</span>

<span class="sd">        t : astropy Time, or string, or tuple, or float; optional</span>
<span class="sd">            Instant at which observation occurs.  Default is time at which code is executed.</span>
<span class="sd">            Also accepts a wide variety of inputs.</span>

<span class="sd">        site : obs_site, or str; optional</span>
<span class="sd">            Site on earth from which observations are taken.  Usually passed as a key from</span>
<span class="sd">            the builtin dictionary of sites, but can be a obs_site instance.</span>
<span class="sd">            Default is &#39;mdm&#39;.</span>

<span class="sd">        use_local_time : boolean; optional</span>
<span class="sd">            Report results in local time; alternative is UT.  Default is True.</span>

<span class="sd">        ra_unit : astropy.unit; optional </span>
<span class="sd">            unit for ra input; default is u.hourangle, which I wish they&#39;d named something </span>
<span class="sd">            different since it&#39;s a term of art.   </span>

<span class="sd">        dec_unit : astropy.unit; optional</span>
<span class="sd">            unit for dec input; default is u.deg</span>

<span class="sd">        Attributes :</span>
<span class="sd">        </span>
<span class="sd">        site : obs_site </span>
<span class="sd">            The observer&#39;s site.</span>

<span class="sd">        celest : astropy SkyCoord </span>
<span class="sd">            celestial position observed.</span>

<span class="sd">        t : astropy Time </span>
<span class="sd">            instant in time of the observation.</span>

<span class="sd">        julyear : float </span>
<span class="sd">            julian year corresponding to t.</span>

<span class="sd">        lst : astropy Angle </span>
<span class="sd">            local sidereal time, computed to about 1 sec bypassing slow astropy routines.</span>

<span class="sd">        nowfr : astropy coordinate frame </span>
<span class="sd">            FK5 frame for equinox of obsevation (&#39;of date&#39;)</span>

<span class="sd">        hanow : astropy Angle </span>
<span class="sd">            hour angle (from meridian)</span>
<span class="sd">     </span>
<span class="sd">        airmass : float </span>
<span class="sd">            true airmass (not secant-z)</span>

<span class="sd">        cel_J2000 : astropy SkyCoord  </span>
<span class="sd">            celestial location for J2000.</span>

<span class="sd">        icrs2now : numpy array </span>
<span class="sd">            rotation matrix to transform cartesian icrs to present equinox</span>
<span class="sd">        </span>
<span class="sd">        current2topoxyz : numpy array </span>
<span class="sd">            rotation matrix to transform current equinox to topocentric XYZ</span>

<span class="sd">        icrs2topoxyz : numpy array</span>
<span class="sd">            matrix product of icrs2now and current2topoxyz; tranforms icrs to topocentric XYZ</span>

<span class="sd">        constel : string</span>
<span class="sd">            IAU abbreviation of the constellation, e.g. &#39;UMa&#39;</span>

<span class="sd">        previouslstmid : astropy Angle </span>
<span class="sd">            sidereal time of previous night&#39;s midnight </span>

<span class="sd">        moonpos : SkyCoord </span>
<span class="sd">            topocentric moon celestial position to about 10 arcsec precision in current equinox</span>

<span class="sd">        moonobjang : astropy Angle </span>
<span class="sd">            angle subtended by Observation&#39;s celest and the moon</span>

<span class="sd">        moonphasedescr : string </span>
<span class="sd">            human-readable description of the moon phase</span>

<span class="sd">        moonillumfrac : float </span>
<span class="sd">            fraction of moon&#39;s face that is illuminated (0. to 1.)</span>

<span class="sd">        moonaltit : astropy Angle </span>
<span class="sd">            elevation of moon above horizon</span>

<span class="sd">        lunskybrightness : float </span>
<span class="sd">            predicted sky brightness added by the moon in mag per square arcsec</span>

<span class="sd">        sunpos :  astropy SkyCoord </span>
<span class="sd">            sun position to about 0.01 degrees</span>

<span class="sd">        sunobjang : astropy Angle </span>
<span class="sd">            angle subtended by sun and moon</span>

<span class="sd">        sunaltit : astropy Angle </span>
<span class="sd">            elevation of sun center above horizon (no refraction)</span>

<span class="sd">        sunaz : astropy Angle </span>
<span class="sd">            azimuth of sun</span>

<span class="sd">        twi : float </span>
<span class="sd">            rough zenight twilight brightness in blue mag per square arcsec</span>

<span class="sd">        lstmid : astropy Angle </span>
<span class="sd">            local sidereal time at midnight</span>

<span class="sd">        tsunset, tsunrise : astropy Time </span>
<span class="sd">            times of sunset and sunrise on present night</span>

<span class="sd">        tevetwi, tmorntwi : astropy Time </span>
<span class="sd">            end and start of astronomical (18-degr) twilight </span>
<span class="sd">        </span>
<span class="sd">        teve12,tmorn12 : astropy Time </span>
<span class="sd">            end and start of nautical (12-degr) twilight</span>

<span class="sd">        tnightcenter : astropy Time </span>
<span class="sd">            time of lower culmination of the sun</span>

<span class="sd">        uptime30, uptime20, uptime15 : astropy TimeDelta </span>
<span class="sd">            How long object has &lt;3, &lt;2, and &lt;1.5 airmasses during night defined by 12-deg twilight.</span>

<span class="sd">        barytcorr : astropy TimeDelta </span>
<span class="sd">            Amount to add to Observation.t to get arrival time at barycenter</span>

<span class="sd">        baryvcorr : astropy Quantity </span>
<span class="sd">            velocity to add to shift velocity to solar system barycenter frame</span>

<span class="sd">        planetdict : Dictionary of astropy SkyCoords </span>
<span class="sd">            sky positions of planets, keyed by lowercase name</span>

<span class="sd">        planetmags : Dictionary of floats  </span>
<span class="sd">            apparent magnitudes of planets</span>

<span class="sd">        &quot;&quot;&quot;</span>
            <span class="c1"># set up the site.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setsite</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">default_site</span> <span class="o">=</span> <span class="n">default_site</span><span class="p">)</span> 

        <span class="c1"># set up the time.</span>

        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="kc">None</span> <span class="p">:</span>   <span class="c1"># set to system clock if no time specified.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">ttime</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;unix&#39;</span><span class="p">)</span>

        <span class="k">else</span> <span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">settime</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">use_local_time</span> <span class="o">=</span> <span class="n">use_local_time</span><span class="p">)</span>

        <span class="c1"># set up the celestial coordinates.</span>

        <span class="k">if</span> <span class="n">celest</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">celest</span> <span class="o">!=</span> <span class="s1">&#39;ZENITH&#39;</span> <span class="p">:</span>  
            <span class="bp">self</span><span class="o">.</span><span class="n">setcelest</span><span class="p">(</span><span class="n">celest</span><span class="p">)</span>    <span class="c1"># many legal formats -- see below. </span>
           
        <span class="k">else</span> <span class="p">:</span> <span class="c1"># default to zenith</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lst</span> <span class="o">=</span> <span class="n">lpsidereal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>    <span class="c1"># sidereal</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nowfr</span> <span class="o">=</span> <span class="n">currentFK5frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">celest</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lst</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span><span class="n">frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nowfr</span><span class="p">)</span>  <span class="c1"># zenith</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cel_J2000</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">celest</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="s1">&#39;icrs&#39;</span><span class="p">)</span>
        <span class="c1"># print(&quot;after xform, self.celest is&quot;,self.celest)</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">constel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">celest</span><span class="o">.</span><span class="n">get_constellation</span><span class="p">(</span><span class="n">short_name</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">previouslstmid</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">moonpos</span> <span class="o">=</span> <span class="kc">None</span>   <span class="c1"># SkyCoord of moon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moonobjang</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moonphasedescr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moonillumfrac</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moonaltit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moonaz</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lunskybright</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># approximate lunar contrib to sky </span>
                                  <span class="c1"># brightness at this location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sunpos</span> <span class="o">=</span>  <span class="kc">None</span>   <span class="c1"># SkyCoord of sun</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sunobjang</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sunaltit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sunaz</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">twi</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># rough magnitude difference between dark</span>
                <span class="c1"># night sky and present blue twilight contrib in zenith.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lstmid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsunset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tevetwi</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tnightcenter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmorntwi</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsunrise</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1">#        self.moonrise = None</span>
<span class="c1">#        self.sunrise = None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">barytcorr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baryvcorr</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">planetdict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dictionary of planet SkyCoords by name.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">planetmags</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dictionary of planet visual mags by name.</span>

<div class="viewcode-block" id="Observation.setsite"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyclasses3.Observation.setsite">[docs]</a>    <span class="k">def</span> <span class="nf">setsite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">default_site</span> <span class="o">=</span> <span class="s1">&#39;mdm&#39;</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set the site on earth of the observation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        site : obs_site instance or string</span>
<span class="sd">            if string, it is the key used for the site in the site dictionary.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">obs_site</span><span class="p">)</span> <span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">site</span> <span class="o">=</span> <span class="n">site</span>

        <span class="k">else</span> <span class="p">:</span> 
<span class="c1">#            sitedict = get_sites()</span>
            <span class="c1"># print &quot;got sites; &quot;,sitedict.keys()</span>
            <span class="k">if</span> <span class="n">site</span> <span class="o">==</span> <span class="kc">None</span> <span class="p">:</span>
                <span class="k">if</span> <span class="n">default_site</span> <span class="o">!=</span> <span class="kc">None</span> <span class="p">:</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">site</span> <span class="o">=</span> <span class="n">sitedict</span><span class="p">[</span><span class="n">default_site</span><span class="p">]</span>
                    <span class="c1"># &#39;backup default&#39; is mdm</span>
                <span class="k">else</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span> <span class="o">=</span> <span class="n">sitedict</span><span class="p">[</span><span class="s1">&#39;mdm&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">site</span> <span class="o">=</span> <span class="n">sitedict</span><span class="p">[</span><span class="n">site</span><span class="p">]</span></div>
    

<div class="viewcode-block" id="Observation.settime"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyclasses3.Observation.settime">[docs]</a>    <span class="k">def</span> <span class="nf">settime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">use_local_time</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;set Observation time t using the input &#39;t&#39; </span>

<span class="sd">        Note the instance variable &#39;t&#39; is always stored as </span>
<span class="sd">        in utc.  If use_local_time, then the input is assumed to be local</span>
<span class="sd">        zone time (though if t is already a Time instance this is ignored).</span>
<span class="sd">        Input t can be an ISO string, or a tuple of at least yr, month,</span>
<span class="sd">        day, hour, and minute.</span>

<span class="sd">        Note also that if use_local_time is True (default) and the site </span>
<span class="sd">        switches back and forth from standard to daylight saving time, then</span>
<span class="sd">        one hour of clock time gets repeated in the autumn, and an hour gets</span>
<span class="sd">        skipped in the spring, which is tricky if localtime is input.  For</span>
<span class="sd">        example, specifying 2:30 AM Eastern time on the &#39;spring forward&#39; night </span>
<span class="sd">        sets to 3:30 AM Eastern Daylight time; 2:30 AM Eastern Standard does</span>
<span class="sd">        not happen on that night.  When Daylight Saving ends, a time in the </span>
<span class="sd">        ambiguous hour reverts to standard, so there&#39;s an hour of time that </span>
<span class="sd">        you just can&#39;t specifiy using local time input.</span>
<span class="sd">  </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        t : a Time, or a string, or a tuple</span>
<span class="sd">            time to which to set Observation attribute t.  If not already a Time,</span>
<span class="sd">            </span>
<span class="sd">            * if a string, can be anything the dateutil parser accepts,e.g.&quot;2023-04-17 19:08:23&quot;</span>
<span class="sd">            * if a tuple, must be (year, month, day, hour, minute, [sec]) as ints; seconds are optional.</span>

<span class="sd">        use_local_time : boolean </span>
<span class="sd">            whether input time is interpreted as local or not; default True.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Time</span><span class="p">)</span> <span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="p">:</span>  <span class="c1"># generally an ISO string like &#39;2018-07-22 14:13:22&#39;</span>
            <span class="k">if</span> <span class="n">use_local_time</span> <span class="p">:</span> 
               <span class="n">localt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">localtz</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">((</span><span class="n">t</span><span class="p">)))</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">localt</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span> 
               <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="p">:</span> 
                <span class="n">dtin</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">dtin</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">use_local_time</span> <span class="p">:</span> 
               <span class="c1"># print &quot;using local&quot;</span>
               <span class="n">localt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">localtz</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">dtin</span><span class="p">)</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">localt</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span> 
               <span class="c1"># print &quot;not using local&quot;</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">dtin</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span><span class="p">)</span> 

        <span class="c1"># Keep a &#39;pure number&#39; version of the julian epoch.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">julyear</span> <span class="o">=</span> <span class="mf">2000.</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">-</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">J2000_Time</span><span class="p">)</span><span class="o">.</span><span class="n">jd</span> <span class="o">/</span> <span class="mf">365.25</span> </div>

<div class="viewcode-block" id="Observation.advancetime"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyclasses3.Observation.advancetime">[docs]</a>    <span class="k">def</span> <span class="nf">advancetime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">forward</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Advance Observation.t by the specified amount.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        delta : Amount to advance the time, as an astropy TimeDelta, or a string </span>
<span class="sd">               such as &quot;143 s&quot; or &quot;5 d&quot; (see below), or a float in sec.</span>
<span class="sd">        forward : boolean : if True, go forward; if False, go back.</span>
<span class="sd">        </span>
<span class="sd">        When specifying the interval with a string, the codes for units are</span>

<span class="sd">        * s - second</span>
<span class="sd">        * m - minute</span>
<span class="sd">        * h - hour</span>
<span class="sd">        * t - 1 sidereal day (transit-to-transit)</span>
<span class="sd">        * d - 1 solar day</span>
<span class="sd">        * w - one week of solar days</span>
<span class="sd">        * l - one lunation</span>
<span class="sd">        * y - one Julian year of 365.25 days</span>

<span class="sd">        &quot;&quot;&quot;</span>
            <span class="c1"># non-obvious: &#39;t&#39; for &#39;transit&#39; is 1 sidereal day, </span>
            <span class="c1"># &#39;w&#39; is a week, &#39;l&#39; is exactly 30 days -- a very rough &#39;lunation&#39; that </span>
            <span class="c1"># will land on the same time of night about one month later -- and</span>
            <span class="c1"># &#39;y&#39; is a 365-day &#39;year&#39;, again because it&#39;s more likely you want to</span>
            <span class="c1"># land on the same time of night next year than keep track over many years.</span>
 
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">TimeDelta</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span> <span class="n">forward</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="n">delta</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">-</span> <span class="n">delta</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="p">:</span>   <span class="c1"># e.g., &quot;123. or 2. d&quot;</span>

            <span class="c1"># codes for time delta intervals, and their values in seconds.</span>
            <span class="c1"># non-obvious: &#39;t&#39; for &#39;transit&#39; is 1 sidereal day, </span>
            <span class="c1"># &#39;w&#39; is a week, &#39;l&#39; is exactly 30 days -- a very rough &#39;lunation&#39; that </span>
            <span class="c1"># will land on the same time of night about one month later -- and</span>
            <span class="c1"># &#39;y&#39; is a 365-day &#39;year&#39;, again because it&#39;s more likely you want to</span>
            <span class="c1"># land on the same time of night next year than keep track over many years.</span>
            <span class="n">t_unit_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;s&#39;</span> <span class="p">:</span> <span class="mf">1.</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span> <span class="p">:</span> <span class="mf">60.</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span> <span class="p">:</span> <span class="mf">3600.</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span> <span class="p">:</span> <span class="mf">86164.0905352</span><span class="p">,</span> 
               <span class="s1">&#39;d&#39;</span> <span class="p">:</span> <span class="mi">86400</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span> <span class="p">:</span> <span class="mf">604800.</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span> <span class="p">:</span> <span class="mf">2592000.</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span> <span class="p">:</span> <span class="mf">31536000.</span><span class="p">}</span>
               
            
            <span class="n">x</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">try</span> <span class="p">:</span> 
                <span class="n">deltafloat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">:</span> 
                    <span class="n">deltafloat</span> <span class="o">=</span> <span class="n">deltafloat</span> <span class="o">*</span> <span class="n">t_unit_dict</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">dt</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="n">deltafloat</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;sec&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">forward</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="n">dt</span>
                <span class="k">else</span> <span class="p">:</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">-</span> <span class="n">dt</span>
            <span class="k">except</span> <span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bad time step string.&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="p">:</span>  <span class="c1"># float defaults to seconds.</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;sec&#39;</span><span class="p">)</span>  
            <span class="k">if</span> <span class="n">forward</span> <span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="n">dt</span>
            <span class="k">else</span> <span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">-</span> <span class="n">dt</span>

        <span class="k">else</span> <span class="p">:</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time step must be a float, an astropy TimeDelta or a string.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">julyear</span> <span class="o">=</span> <span class="mf">2000.</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">-</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">J2000_Time</span><span class="p">)</span><span class="o">.</span><span class="n">jd</span> <span class="o">/</span> <span class="mf">365.25</span> </div>
 
<div class="viewcode-block" id="Observation.setcelest"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyclasses3.Observation.setcelest">[docs]</a>    <span class="k">def</span> <span class="nf">setcelest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">celestin</span><span class="p">,</span><span class="n">ra_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">dec_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span> <span class="p">:</span>  
        <span class="sd">&quot;&quot;&quot;Sets the celestial coords.  </span>

<span class="sd">        Input can be a SkyCoord instance, a list or tuple of (ra,dec) or</span>
<span class="sd">        (ra,dec,equinox), or a character string.  </span>

<span class="sd">        Parameters </span>
<span class="sd">        ----------</span>

<span class="sd">        celestin : Skycoord, or list/tuple, or string. Celestial coordinates to set.  See below.</span>
<span class="sd">        ra_unit : astropy unit; input unit for RA, defaults to u.hourangle  (i.e, hrs min sec)</span>
<span class="sd">        dec_unit : astropy unit; input unit for dec, defaults to u.deg </span>

<span class="sd">        If celestin is a string, some permissible formats are </span>

<span class="sd">        * &#39;18:22:22.3  -0:18:33&#39;   (defaults to ICRS or basically J2000)</span>
<span class="sd">        * &#39;18:22:22.3  -0:18:33 2015&#39;</span>
<span class="sd">        * &#39;18 22 22.3  -0 18 33&#39;</span>
<span class="sd">        * &#39;18 22 22.3  -0 18 33 2015&#39;</span>

<span class="sd">        Input units only apply if celestin is not already a SkyCoord.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">celestin</span><span class="p">,</span> <span class="n">SkyCoord</span><span class="p">)</span> <span class="p">:</span>  <span class="c1"># if it&#39;s a SkyCoord, just copy it.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">celest</span> <span class="o">=</span> <span class="n">celestin</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">celestin</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">celestin</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="p">:</span>   <span class="c1"># </span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">celestin</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">celest</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">celestin</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">celestin</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">ra_unit</span><span class="p">,</span> <span class="n">dec_unit</span><span class="p">))</span>   <span class="c1"># parse a tuple</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">celestin</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">:</span>
               <span class="c1"># print(&quot;celestin[2] = &quot;,celestin[2])</span>
               <span class="n">eq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">celestin</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
               <span class="k">if</span> <span class="n">eq</span> <span class="o">==</span> <span class="mf">2000.</span> <span class="p">:</span> 
                   <span class="bp">self</span><span class="o">.</span><span class="n">celest</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">celestin</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">celestin</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">unit</span> <span class="o">=</span> <span class="p">(</span><span class="n">ra_unit</span><span class="p">,</span> <span class="n">dec_unit</span><span class="p">))</span>
               <span class="k">else</span> <span class="p">:</span> 
                   <span class="n">eq</span> <span class="o">=</span> <span class="s2">&quot;J</span><span class="si">%7.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">eq</span><span class="p">)</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">celest</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">celestin</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">celestin</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">unit</span> <span class="o">=</span> <span class="p">(</span><span class="n">ra_unit</span><span class="p">,</span> <span class="n">dec_unit</span><span class="p">),</span><span class="n">frame</span> <span class="o">=</span> <span class="n">FK5</span><span class="p">(</span><span class="n">equinox</span> <span class="o">=</span> <span class="n">eq</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">celestin</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="p">:</span>   <span class="c1"># str includes unicode in python3.</span>
            <span class="n">pieces</span> <span class="o">=</span> <span class="n">celestin</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> 
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pieces</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="p">:</span>  <span class="c1"># space-separated fields - glue back together.</span>
                <span class="n">rastr</span> <span class="o">=</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">decstr</span> <span class="o">=</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pieces</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span> <span class="p">:</span>   <span class="c1"># if there&#39;s an equinox ...</span>
                   <span class="n">eqstr</span> <span class="o">=</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                <span class="k">else</span> <span class="p">:</span> <span class="n">eqstr</span> <span class="o">=</span> <span class="s1">&#39;2000.&#39;</span>
            <span class="k">else</span> <span class="p">:</span>    <span class="c1"># e.g. 21:29:36.2   so split gets ra and dec separately</span>
                <span class="n">rastr</span> <span class="o">=</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
                <span class="n">decstr</span> <span class="o">=</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pieces</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">:</span> <span class="n">eqstr</span> <span class="o">=</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># if there&#39;s an equinox ...</span>
                <span class="k">else</span> <span class="p">:</span> <span class="n">eqstr</span> <span class="o">=</span> <span class="s1">&#39;2000.&#39;</span>
            <span class="c1"># print &quot;rastr decstr eqstr&quot;,rastr,decstr,eqstr</span>
            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">eqstr</span><span class="p">)</span> <span class="o">==</span> <span class="mf">2000.</span> <span class="p">:</span>  <span class="c1"># default to ICRS if 2000.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">celest</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">rastr</span><span class="p">,</span><span class="n">decstr</span><span class="p">,</span><span class="n">unit</span> <span class="o">=</span> <span class="p">(</span><span class="n">ra_unit</span><span class="p">,</span> <span class="n">dec_unit</span><span class="p">))</span>
            <span class="k">else</span> <span class="p">:</span>   <span class="c1"># or set in FK5 frame of date if not 2000.</span>
                <span class="n">eq</span> <span class="o">=</span> <span class="s2">&quot;J&quot;</span><span class="o">+</span><span class="n">eqstr</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">celest</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">rastr</span><span class="p">,</span><span class="n">decstr</span><span class="p">,</span><span class="n">unit</span> <span class="o">=</span> <span class="p">(</span><span class="n">ra_unit</span><span class="p">,</span> <span class="n">dec_unit</span><span class="p">),</span><span class="n">frame</span> <span class="o">=</span> <span class="n">FK5</span><span class="p">(</span><span class="n">equinox</span> <span class="o">=</span> <span class="n">eq</span><span class="p">))</span>

<span class="c1">#        print(&quot; ************ IN SETCELEST ************ &quot;)</span>
<span class="c1">#        print( &quot;self.celest:&quot;,self.celest)</span>
<span class="c1">#        print( &quot;frame.name:&quot;,self.celest.frame.name)</span>
                
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">celest</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;icrs&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">celest</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;gcrs&#39;</span> <span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">cel_J2000</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">celest</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">celest</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;precessedgeocentric&#39;</span> <span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">cel_J2000</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">celest</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="s1">&#39;gcrs&#39;</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cel_J2000</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">celest</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="s1">&#39;icrs&#39;</span><span class="p">)</span></div>

<span class="c1">#        print &quot;self.cel_J2000:&quot;,self.cel_J2000</span>

        
<div class="viewcode-block" id="Observation.computesky"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyclasses3.Observation.computesky">[docs]</a>    <span class="k">def</span> <span class="nf">computesky</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redo_coords</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="p">:</span>  
        <span class="sd">&quot;&quot;&quot;Compute basic observational circumstances.</span>

<span class="sd">        Quantities computed include lst, current-equinox coords, </span>
<span class="sd">        hour angle, alt, az, parallactic angle, midhight, LST mid,.  Precession to</span>
<span class="sd">        current equinox can be suppressed for speed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        redo_coords : boolean, defaults to true. If False, turns off precession.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># current equinox etc., useful for repeat calls tracing out a single</span>
        <span class="c1"># night</span>

        <span class="c1"># Also, if redo_coords is on, computes rotation matrices to </span>
        <span class="c1"># take celestial cartesian coords in ICRS directly into the </span>
        <span class="c1"># observer&#39;s topocentric frame.  This speeds up such things</span>
        <span class="c1"># as the star display by a large factor.</span>

<span class="c1">#        print(&quot;entering computesksy: self.celest = &quot;, self.celest)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lst</span> <span class="o">=</span> <span class="n">lpsidereal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>    <span class="c1"># sidereal</span>

        <span class="c1"># use these to test for &#39;this is the same night.&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">midnight</span> <span class="o">=</span> <span class="n">local_midnight_Time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">localtz</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">lstmid</span> <span class="o">=</span> <span class="n">lpsidereal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">midnight</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">redo_coords</span> <span class="p">:</span> 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">celest</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;gcrs&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">celest</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;precessedgeocentric&#39;</span> <span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">nowfr</span> <span class="o">=</span> <span class="n">currentgeocentframe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
 
            <span class="k">else</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nowfr</span> <span class="o">=</span> <span class="n">currentFK5frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>

<span class="c1">#        print(&quot;self.nowfr = &quot;,self.nowfr)</span>
        
            <span class="bp">self</span><span class="o">.</span><span class="n">celnow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">celest</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nowfr</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hanow</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lst</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">celnow</span><span class="o">.</span><span class="n">ra</span><span class="p">)</span><span class="o">.</span><span class="n">wrap_at</span><span class="p">(</span><span class="mf">12.</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>     <span class="c1"># hour angle</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">altit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">az</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parang</span><span class="p">)</span> <span class="o">=</span> <span class="n">altazparang</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">celnow</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hanow</span><span class="p">,</span> 
               <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">airmass</span> <span class="o">=</span> <span class="n">true_airmass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">altit</span><span class="p">)</span>  <span class="c1"># polynomial expansion.</span>

        <span class="k">if</span> <span class="n">redo_coords</span> <span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">constel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">celest</span><span class="o">.</span><span class="n">get_constellation</span><span class="p">(</span><span class="n">short_name</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

            <span class="c1"># compute some convenient rotation matrices:    </span>
    
            <span class="c1"># compute matrix for precession from J2000 (i.e., icrs almost exactly) </span>
            <span class="c1"># to now, for later use.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">icrs2now</span> <span class="o">=</span> <span class="n">precessmatrix</span><span class="p">(</span><span class="n">thorconsts</span><span class="o">.</span><span class="n">J2000_Time</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
            <span class="c1"># and matrix to rotate a current-equinox celestial xyz into topocentric</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current2topoxyz</span> <span class="o">=</span> <span class="n">cel2localmatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
            <span class="c1"># and matrix product to rotate icrs into topocentric xyz.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">icrs2topoxyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current2topoxyz</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">icrs2now</span><span class="p">)</span> <span class="c1"># matrix product </span>

            <span class="c1"># If we&#39;re in the south, rotate by 180 degrees around vertical axis</span>
            <span class="c1"># to invert display.  Simply negate top two rows of the matrix.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span> <span class="o">&lt;</span> <span class="mf">0.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span> <span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">icrs2topoxyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mi">1</span><span class="p">],[</span><span class="o">-</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">icrs2topoxyz</span></div>

<span class="c1">#        print(&quot;leaving computesksy: self.celest = &quot;, self.celest)</span>


<div class="viewcode-block" id="Observation.computebary"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyclasses3.Observation.computebary">[docs]</a>    <span class="k">def</span> <span class="nf">computebary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>  <span class="c1"># this is a bit expensive so split off.</span>
        <span class="sd">&quot;&quot;&quot;computes and set bary corrections using astropy routines.  Slow; nearly all users will want &#39;computequickbary&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baryvcorr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">celest</span><span class="o">.</span><span class="n">radial_velocity_correction</span><span class="p">(</span><span class="n">obstime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
            <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">)</span> 
<span class="c1">#        print &quot;baryvcorr: &quot;, self.baryvcorr.to(u.km/u.s)</span>
<span class="c1">#        print type(self.baryvcorr.to(u.km/u.s))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">barytcorr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">light_travel_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">celnow</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barycentric&#39;</span><span class="p">,</span>
           <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="n">ephemeris</span> <span class="o">=</span> <span class="s1">&#39;builtin&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tbary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">barytcorr</span></div>
<span class="c1">#        print &quot;barytcorr: &quot;, self.barytcorr.to(u.s)</span>
<span class="c1">#        print type(self.barytcorr.to(u.s))</span>

<div class="viewcode-block" id="Observation.computequickbary"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyclasses3.Observation.computequickbary">[docs]</a>    <span class="k">def</span> <span class="nf">computequickbary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>  
        <span class="sd">&quot;&quot;&quot;compute and set barycentric corrections to 0.1s and 10m/s. Reasonably fast.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># The call to computebary is very expensive in</span>
        <span class="c1"># order to get ultimate accuracy.  When less precision is </span>
        <span class="c1"># required it should  be possible to make it much faster by </span>
        <span class="c1"># computing the corrections directly.</span>

        <span class="c1"># The goal is to get something like 0.1 sec in light time, and </span>
        <span class="c1"># 10 meters per second in velocity.  </span>

        <span class="n">earthpos</span> <span class="o">=</span> <span class="n">get_body_barycentric</span><span class="p">(</span><span class="s1">&#39;earth&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># astropy doesn&#39;t seem to offer a velocity function.  </span>
        <span class="c1"># For moderate precision, the simplest numerical derivative works:</span>

        <span class="n">x1</span> <span class="o">=</span> <span class="n">get_body_barycentric</span><span class="p">(</span><span class="s1">&#39;earth&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">-</span> <span class="p">(</span><span class="mf">500.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">))</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="n">get_body_barycentric</span><span class="p">(</span><span class="s1">&#39;earth&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="p">(</span><span class="mf">500.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">))</span>

        <span class="n">earthvel</span> <span class="o">=</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1000.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>

        <span class="c1"># ignore geographic correction to light time delay -- it&#39;s</span>
        <span class="c1"># 21 msec for a source at the zenith.</span>

        <span class="c1"># nice to have a builtin dot product function for this!</span>
        <span class="n">extra</span> <span class="o">=</span> <span class="n">earthpos</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cel_J2000</span><span class="o">.</span><span class="n">cartesian</span><span class="p">)</span>  <span class="c1"># extra distance to barycenter</span>
        <span class="n">tcorr</span> <span class="o">=</span> <span class="n">extra</span> <span class="o">/</span> <span class="p">((</span><span class="mf">299792.458</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">barytcorr</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="n">tcorr</span><span class="p">)</span>   <span class="c1"># needs to be a TimeDelta</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tbary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">barytcorr</span>  <span class="c1"># this is the right sign!</span>
        
        <span class="c1">#  earth-rotation part of velocity correction </span>

        <span class="n">diurnalvel</span> <span class="o">=</span> <span class="n">CartesianRepresentation</span><span class="p">(</span>  
            <span class="o">-</span><span class="mf">1.</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">diurnalspeed</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lst</span><span class="p">),</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">diurnalspeed</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lst</span><span class="p">),</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">diurnalspeed</span> <span class="o">*</span> <span class="mf">0.</span><span class="p">)</span>

        <span class="c1"># totalvel should be earth orbit + earth rotation velocity wrt barycenter</span>
        
        <span class="n">totalvel</span> <span class="o">=</span> <span class="n">earthvel</span> <span class="o">+</span> <span class="n">diurnalvel</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">baryvcorr</span> <span class="o">=</span> <span class="n">totalvel</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">celest</span><span class="o">.</span><span class="n">cartesian</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span></div>

        <span class="c1"># print(&quot;self.barytcorr &quot;,self.barytcorr,&quot;self.baryvcorr&quot;,self.baryvcorr)</span>
 
<div class="viewcode-block" id="Observation.computesunmoon"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyclasses3.Observation.computesunmoon">[docs]</a>    <span class="k">def</span> <span class="nf">computesunmoon</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Compute and set the many moon and sun quantities.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lst</span> <span class="o">=</span> <span class="n">lpsidereal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moonpos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">moondist</span> <span class="o">=</span> <span class="n">accumoon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">moonha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lst</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">moonpos</span><span class="o">.</span><span class="n">ra</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moonaltit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">moonaz</span><span class="p">,</span> <span class="n">parang</span><span class="p">)</span> <span class="o">=</span> <span class="n">altazparang</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moonpos</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">moonha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sunpos</span> <span class="o">=</span> <span class="n">lpsun</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">sunha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lst</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sunpos</span><span class="o">.</span><span class="n">ra</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sunaltit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sunaz</span><span class="p">,</span> <span class="n">parang</span><span class="p">)</span> <span class="o">=</span> <span class="n">altazparang</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sunpos</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sunha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">twi</span> <span class="o">=</span> <span class="n">ztwilight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sunaltit</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sunmoonang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sunpos</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moonpos</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">moonillumfrac</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sunmoonang</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moonobjang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">celnow</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moonpos</span><span class="p">)</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moonphasedescr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lunage</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lunation</span><span class="p">)</span> <span class="o">=</span> <span class="n">phase_descr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">jd</span><span class="p">)</span>
        <span class="c1"># print &quot;age %f lunation %d&quot; % (self.lunage, self.lunation)</span>

<span class="c1">#        print &quot;moon illum frac:&quot;,self.moonillumfrac</span>
<span class="c1">#        print &quot;moon-obj ang:&quot;, self.moonobjang</span>
<span class="c1">#        print &quot;moon altit&quot;,self.moonaltit,&quot;obj altit&quot;,self.altit</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lunsky</span> <span class="o">=</span> <span class="n">lunskybright</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sunmoonang</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">moonobjang</span><span class="p">,</span><span class="n">thorconsts</span><span class="o">.</span><span class="n">KZEN</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">moonaltit</span><span class="p">,</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">altit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">moondist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sunaltit</span><span class="p">)</span></div>

<span class="c1">#        print &quot;lunsky: &quot;,self.lunsky</span>

<span class="c1">#        print &quot;lst&quot;,self.lst</span>
<span class="c1">#        print &quot;moon&quot;,self.moonpos</span>
<span class="c1">#        print &quot;moon ha, alt, az&quot;, self.moonha, self.moonaltit, self.moonaz</span>
<span class="c1">#        print &quot;sun&quot;,self.sunpos</span>
<span class="c1">#        print &quot;sun ha, alt, az&quot;, self.sunha, self.sunaltit, self.sunaz</span>
<span class="c1">#        print &quot;twilight diff: &quot; , self.twi</span>

<div class="viewcode-block" id="Observation.computeplanets"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyclasses3.Observation.computeplanets">[docs]</a>    <span class="k">def</span> <span class="nf">computeplanets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span> 
        <span class="sd">&quot;&quot;&quot;compute and store planetary positions and magnitudes.&quot;&quot;&quot;</span>

<span class="c1">#        print &quot;starting planets&quot;</span>
        <span class="n">planetlist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mercury&#39;</span><span class="p">,</span><span class="s1">&#39;venus&#39;</span><span class="p">,</span><span class="s1">&#39;mars&#39;</span><span class="p">,</span><span class="s1">&#39;jupiter&#39;</span><span class="p">,</span><span class="s1">&#39;saturn&#39;</span><span class="p">,</span><span class="s1">&#39;uranus&#39;</span><span class="p">,</span><span class="s1">&#39;neptune&#39;</span><span class="p">]</span>

        <span class="c1"># to get magnitudes need to get sun and earth positions too</span>

        <span class="n">sunbary</span> <span class="o">=</span> <span class="n">get_body_barycentric</span><span class="p">(</span><span class="s1">&#39;sun&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
<span class="c1">#        print &#39;sunbary:&#39; </span>
<span class="c1">#        print sunbary</span>
        <span class="n">earthbary</span> <span class="o">=</span> <span class="n">get_body_barycentric</span><span class="p">(</span><span class="s1">&#39;earth&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
<span class="c1">#        print &#39;earthbary:&#39;</span>
<span class="c1">#        print earthbary</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">planetlist</span> <span class="p">:</span> 
            <span class="c1"># get celestial position of planet</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">planetdict</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_body</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
        <span class="c1">#    print &quot;get_body gives&quot;,p, self.planetdict[p]</span>
        <span class="c1">#  This returns a position in &quot;GCRS: which is earth-centered.</span>

            <span class="c1"># now get sun-centered location (slightly different from bary) to get</span>
            <span class="c1"># magnitude.</span>

            <span class="n">pbary</span> <span class="o">=</span> <span class="n">get_body_barycentric</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
            <span class="n">psun</span> <span class="o">=</span>  <span class="n">sunbary</span> <span class="o">-</span> <span class="n">pbary</span> <span class="c1"># vector from sun to planet</span>
            <span class="n">psundist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">psun</span><span class="o">.</span><span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">psun</span><span class="o">.</span><span class="n">y</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">psun</span><span class="o">.</span><span class="n">z</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># modulus</span>

            <span class="n">pearth</span> <span class="o">=</span> <span class="n">earthbary</span> <span class="o">-</span> <span class="n">pbary</span>  <span class="c1"># vector from planet to earth</span>
            <span class="n">pearthdist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pearth</span><span class="o">.</span><span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pearth</span><span class="o">.</span><span class="n">y</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pearth</span><span class="o">.</span><span class="n">z</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
   
            <span class="c1"># for inner planets, use polynomials for the phase angle dependence,</span>
            <span class="c1"># which is not at all trivial.</span>

            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="s1">&#39;mercury&#39;</span> <span class="ow">or</span> <span class="n">p</span> <span class="o">==</span> <span class="s1">&#39;venus&#39;</span> <span class="ow">or</span> <span class="n">p</span> <span class="o">==</span> <span class="s1">&#39;mars&#39;</span> <span class="p">:</span> 
                <span class="c1"># angle between sun and earth as viewed from planet</span>
                <span class="n">phaseang</span> <span class="o">=</span> <span class="n">angle_between</span><span class="p">(</span><span class="n">psun</span><span class="p">,</span><span class="n">pearth</span><span class="p">)</span>
                <span class="c1"># print &quot;phaseang:&quot;,phaseang</span>
                <span class="n">phasefac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">thorconsts</span><span class="o">.</span><span class="n">PLANETPHASECOEFS</span><span class="p">[</span><span class="n">p</span><span class="p">],</span><span class="n">phaseang</span><span class="p">)</span>
                <span class="c1"># print &quot;phasefac:&quot;,phasefac</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">planetmags</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">phasefac</span> <span class="o">+</span> <span class="mf">5.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">psundist</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">AU</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">pearthdist</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">AU</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="c1"># print &quot;mag:&quot;,self.planetmags[p]</span>

            <span class="c1"># outer planets are close enough to phase zero all the time to ignore the phase angle.</span>
            <span class="k">else</span> <span class="p">:</span> 
                <span class="n">phasefac</span> <span class="o">=</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">PLANETPHASECOEFS</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">planetmags</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">phasefac</span> <span class="o">+</span> <span class="mf">5.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">psundist</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">AU</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">pearthdist</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">AU</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="c1"># print &quot;mag:&quot;,self.planetmags[p]</span>
            <span class="c1"># saturn will not be good because there&#39;s no ring-tilt dependence factored in.</span>
 
        <span class="n">fr</span> <span class="o">=</span> <span class="n">currentgeocentframe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
        <span class="c1">#print &quot;frame attributes:&quot;,fr.get_frame_attr_names()</span>
<span class="c1">#        print &quot;&quot;&quot;</span>
<span class="c1">#after transformation:</span>
<span class="c1">#   &quot;&quot;&quot;</span>

        <span class="c1"># we want these in equinox of date for plotting.  They&#39;ll be </span>
        <span class="c1"># converted back to J2000 for the table when the coordinates are loaded</span>
        <span class="c1"># into the observation instance.</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">planetlist</span> <span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">planetdict</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planetdict</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">fr</span><span class="p">)</span></div>
<span class="c1">#            print p, self.planetdict[p].to_string(&#39;hmsdms&#39;)</span>
<span class="c1">#        print &quot;ending planets&quot;</span>
        

<div class="viewcode-block" id="Observation.setnightevents"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyclasses3.Observation.setnightevents">[docs]</a>    <span class="k">def</span> <span class="nf">setnightevents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span> 
        <span class="sd">&quot;&quot;&quot;Compute the events (sunset etc) for a single night.  &quot;&quot;&quot;</span>

        <span class="c1"># self.midnight also computed in computesky, but it&#39;s cheap.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">midnight</span> <span class="o">=</span> <span class="n">local_midnight_Time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">localtz</span><span class="p">)</span> 
      
        <span class="bp">self</span><span class="o">.</span><span class="n">lstmid</span> <span class="o">=</span> <span class="n">lpsidereal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">midnight</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>

        <span class="c1"># if you&#39;re looking at the same night, from the same site,</span>
        <span class="c1"># lst mid will be the same.   Don&#39;t bother with the calculation</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">previouslstmid</span> <span class="o">!=</span> <span class="kc">None</span> <span class="p">:</span>
           <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previouslstmid</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstmid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.001</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span> <span class="p">:</span>
               <span class="c1"># print &quot;no night event calc&#39;n -- same.&quot;</span>
               <span class="k">return</span>

        <span class="n">sunmid</span> <span class="o">=</span> <span class="n">lpsun</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">midnight</span><span class="p">)</span> 
   
        <span class="c1"># sunrise and sunset altitudes are complicated and initialized</span>
        <span class="c1"># with the site for efficiency&#39;s sake.  Twilight altitude is</span>
        <span class="c1"># fixed at -18 degrees, so not costly to set it here.</span>
 
        <span class="n">twialt</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="o">-</span><span class="mf">18.</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>     
        <span class="n">twialt12</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="o">-</span><span class="mf">12.</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>

        <span class="c1"># Compute sunset, sunrise, and twilight times.</span>
        <span class="c1"># Start by computing the approximate hour angles at which these</span>
        <span class="c1"># occur, for the dec that the sun has at midnight.</span>

        <span class="c1"># for this purpose, wrap hour angles at noon so that all for a given night</span>
        <span class="c1"># are positive</span>

        <span class="c1"># Find hour angle at which the dec of the sun (evaluated at</span>
        <span class="c1"># local midnight) rises or sets</span>
        <span class="n">sunsetha</span> <span class="o">=</span> <span class="n">ha_alt</span><span class="p">(</span><span class="n">sunmid</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">setalt</span><span class="p">)</span>  
        <span class="c1"># If the dec of the sun never rises or sets -- possible in the arctic -- set </span>
        <span class="c1"># flags for later use; &quot;0&quot; is normal, it rises and sets, &quot;1&quot; is it&#39;s always</span>
        <span class="c1"># up (midnight sun) and &quot;-1&quot; is it never rises.</span>
        <span class="k">if</span> <span class="n">sunsetha</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">500.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span> <span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">sunsetflag</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># sun always up</span>
        <span class="k">elif</span> <span class="n">sunsetha</span> <span class="o">&lt;</span> <span class="p">(</span><span class="o">-</span><span class="mf">500.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sunsetflag</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>   <span class="c1"># sun never rises or sets </span>
        <span class="k">else</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sunsetflag</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="n">sunriseha</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span> <span class="o">-</span> <span class="n">ha_alt</span><span class="p">(</span><span class="n">sunmid</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">risealt</span><span class="p">)</span>  

        <span class="n">twilightha</span> <span class="o">=</span> <span class="n">ha_alt</span><span class="p">(</span><span class="n">sunmid</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span><span class="n">twialt</span><span class="p">)</span>  <span class="c1"># positive, correct for evening</span>
<span class="c1">#        print &quot;sunsetha, sunriseha, twilightha&quot;,sunsetha,sunriseha,twilightha</span>
        <span class="c1"># Again, set flag in case twilight never ends (high-latitude summer) or the sun doesn&#39;t get</span>
        <span class="c1"># higher than -18 degrees </span>
        <span class="k">if</span> <span class="n">twilightha</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">500.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span> <span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">twilightflag</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># never gets dark</span>
        <span class="k">elif</span> <span class="n">twilightha</span> <span class="o">&lt;</span> <span class="p">(</span><span class="o">-</span><span class="mf">500.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">twilightflag</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>   <span class="c1"># fully dark all night (only happens near pole and solstice)</span>
        <span class="k">else</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">twilightflag</span> <span class="o">=</span> <span class="mi">0</span> 

        <span class="c1"># do the same for 12-degree twilight; with the sun between 12 and 18 degrees below the horizon the</span>
        <span class="c1"># sky is fairly dark and one can work on brighter object, standard stars and so on.</span>

        <span class="n">twilight12ha</span> <span class="o">=</span> <span class="n">ha_alt</span><span class="p">(</span><span class="n">sunmid</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span><span class="n">twialt12</span><span class="p">)</span>  <span class="c1"># positive, correct for evening</span>
        <span class="k">if</span> <span class="n">twilight12ha</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">500.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span> <span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">twilight12flag</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># never gets dark</span>
        <span class="k">elif</span> <span class="n">twilight12ha</span> <span class="o">&lt;</span> <span class="p">(</span><span class="o">-</span><span class="mf">500.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">twilight12flag</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>   <span class="c1"># fully dark all night (only happens near pole and solstice)</span>
        <span class="k">else</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">twilight12flag</span> <span class="o">=</span> <span class="mi">0</span> 
 
        <span class="n">hasunmid</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lstmid</span> <span class="o">-</span> <span class="n">sunmid</span><span class="o">.</span><span class="n">ra</span><span class="p">)</span><span class="o">.</span><span class="n">wrap_at</span><span class="p">(</span><span class="mf">24.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
        <span class="c1">#print &quot;hasunmid:&quot;,hasunmid</span>
        <span class="c1">#print &quot;midnight&quot;,self.midnight</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tnightcenter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">midnight</span> <span class="o">-</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="n">hasunmid</span><span class="o">.</span><span class="n">hour</span> <span class="o">/</span> <span class="mf">24.</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span><span class="p">)</span>
        <span class="c1">#self.lstnightcenter = lpsidereal(self.tnightcenter,self.site.location)</span>

        <span class="c1">#print &#39;night center&#39;,self.nightcenter</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sunsetflag</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>  <span class="c1"># if dec of sun is such that sunset and sunrise occur</span>
            <span class="n">sunsetguess</span> <span class="o">=</span> <span class="n">hasunmid</span> <span class="o">-</span> <span class="n">sunsetha</span>    <span class="c1"># hour angle difference from sun&#39;s posn at midnight</span>
            <span class="n">sunriseguess</span> <span class="o">=</span>  <span class="n">sunriseha</span> <span class="o">-</span> <span class="n">hasunmid</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">twilightflag</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span> 
            <span class="n">evetwiguess</span> <span class="o">=</span> <span class="n">hasunmid</span> <span class="o">-</span> <span class="n">twilightha</span>
            <span class="n">morntwiguess</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span> <span class="o">-</span> <span class="n">twilightha</span> <span class="o">-</span> <span class="n">hasunmid</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">twilight12flag</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span> 
            <span class="n">evetwi12guess</span> <span class="o">=</span> <span class="n">hasunmid</span> <span class="o">-</span> <span class="n">twilight12ha</span>
            <span class="n">morntwi12guess</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span> <span class="o">-</span> <span class="n">twilight12ha</span> <span class="o">-</span> <span class="n">hasunmid</span>

        <span class="c1">#print &quot;sunsetguess, sunriseguess&quot;,sunsetguess,sunriseguess.hour</span>
        <span class="c1">#print &quot;eve, morn&quot;,evetwiguess,morntwiguess.hour</span>

        <span class="c1"># convert to time differences</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sunsetflag</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
            <span class="n">TDsunset</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="n">sunsetguess</span><span class="o">.</span><span class="n">hour</span> <span class="o">/</span> <span class="mf">24.</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span><span class="p">)</span>
            <span class="n">TDsunrise</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="n">sunriseguess</span><span class="o">.</span><span class="n">hour</span> <span class="o">/</span> <span class="mf">24.</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span><span class="p">)</span>

        <span class="c1">#print &quot;tdsunset, tdsunrise&quot;,TDsunset,TDsunrise</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">twilightflag</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
            <span class="n">TDevetwi</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="n">evetwiguess</span><span class="o">.</span><span class="n">hour</span> <span class="o">/</span> <span class="mf">24.</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span><span class="p">)</span>
            <span class="n">TDmorntwi</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="n">morntwiguess</span><span class="o">.</span><span class="n">hour</span> <span class="o">/</span> <span class="mf">24.</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span><span class="p">)</span>
        <span class="c1">#print &quot;TDeve, TDmorn&quot;,TDevetwi,TDmorntwi</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">twilight12flag</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
            <span class="n">TDevetwi12</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="n">evetwi12guess</span><span class="o">.</span><span class="n">hour</span> <span class="o">/</span> <span class="mf">24.</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span><span class="p">)</span>
            <span class="n">TDmorntwi12</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="n">morntwi12guess</span><span class="o">.</span><span class="n">hour</span> <span class="o">/</span> <span class="mf">24.</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span><span class="p">)</span>

        <span class="c1"># form into times and iterate to accurate answers.</span>
     
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sunsetflag</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsunset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">midnight</span> <span class="o">-</span> <span class="n">TDsunset</span>  <span class="c1"># first approx</span>
            <span class="c1">#print &quot;first approx&quot;,self.tsunset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsunset</span> <span class="o">=</span> <span class="n">jd_sun_alt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">setalt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsunset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
     
            <span class="bp">self</span><span class="o">.</span><span class="n">tsunrise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">midnight</span> <span class="o">+</span> <span class="n">TDsunrise</span>  <span class="c1"># first approx</span>
            <span class="c1">#print &quot;first approx&quot;,self.tsunrise</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsunrise</span> <span class="o">=</span> <span class="n">jd_sun_alt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">risealt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsunrise</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">twilightflag</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
     
            <span class="bp">self</span><span class="o">.</span><span class="n">tevetwi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">midnight</span> <span class="o">-</span> <span class="n">TDevetwi</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tevetwi</span> <span class="o">=</span> <span class="n">jd_sun_alt</span><span class="p">(</span><span class="n">twialt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tevetwi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
     
            <span class="bp">self</span><span class="o">.</span><span class="n">tmorntwi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">midnight</span> <span class="o">+</span> <span class="n">TDmorntwi</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmorntwi</span> <span class="o">=</span> <span class="n">jd_sun_alt</span><span class="p">(</span><span class="n">twialt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmorntwi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">twilight12flag</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
     
            <span class="bp">self</span><span class="o">.</span><span class="n">tevetwi12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">midnight</span> <span class="o">-</span> <span class="n">TDevetwi12</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tevetwi12</span> <span class="o">=</span> <span class="n">jd_sun_alt</span><span class="p">(</span><span class="n">twialt12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tevetwi12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
            <span class="c1">#self.lsteve12 = lpsidereal(self.tevetwi12,self.site.location)</span>
     
            <span class="bp">self</span><span class="o">.</span><span class="n">tmorntwi12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">midnight</span> <span class="o">+</span> <span class="n">TDmorntwi12</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmorntwi12</span> <span class="o">=</span> <span class="n">jd_sun_alt</span><span class="p">(</span><span class="n">twialt12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmorntwi12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
            <span class="c1">#self.lstmorn12 = lpsidereal(self.tmorntwi12,self.site.location)</span>

        <span class="c1"># and, moonrise and set times for that night.</span>

        <span class="n">moonmid</span> <span class="o">=</span> <span class="n">lpmoon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">midnight</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="n">hamoonmid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstmid</span> <span class="o">-</span> <span class="n">moonmid</span><span class="o">.</span><span class="n">ra</span>
        <span class="n">hamoonmid</span><span class="o">.</span><span class="n">wrap_at</span><span class="p">(</span><span class="mf">12.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1">#print &quot;moon at midnight&quot;,moonmid</span>
        <span class="c1">#print &quot;hamoonmid: &quot;,hamoonmid.hour, &#39;hr&#39;</span>

        <span class="n">roughlunarday</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="mf">1.0366</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span><span class="p">)</span>

        <span class="n">moonsetha</span> <span class="o">=</span> <span class="n">ha_alt</span><span class="p">(</span><span class="n">moonmid</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">setalt</span><span class="p">)</span>

        <span class="c1"># Using the midnight position of the moon to assess whether it actually</span>
        <span class="c1"># rises or sets in a 12-hour window around that time is problematic, </span>
        <span class="c1"># since the moon&#39;s dec can move pretty quickly.  This is a rare &#39;corner</span>
        <span class="c1"># case&#39; that only matters at very high latitudes so I&#39;m not going to worry </span>
        <span class="c1"># about it too much.  </span>
        <span class="k">if</span> <span class="n">moonsetha</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">500.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span> <span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">moonsetflag</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># moon always up </span>
        <span class="k">elif</span> <span class="n">moonsetha</span> <span class="o">&lt;</span> <span class="p">(</span><span class="o">-</span><span class="mf">500.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">moonsetflag</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>   <span class="c1"># moon always below horizon</span>
        <span class="k">else</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">moonsetflag</span> <span class="o">=</span> <span class="mi">0</span>  
 
        <span class="n">moonsetdiff</span> <span class="o">=</span> <span class="n">moonsetha</span> <span class="o">-</span> <span class="n">hamoonmid</span>   <span class="c1"># how far from setting at midnight</span>
        <span class="c1"># find nearest setting point </span>
        <span class="k">if</span> <span class="n">moonsetdiff</span><span class="o">.</span><span class="n">hour</span> <span class="o">&gt;=</span> <span class="mf">12.</span> <span class="p">:</span> <span class="n">moonsetdiff</span> <span class="o">=</span> <span class="n">moonsetdiff</span> <span class="o">-</span> <span class="n">Angle</span><span class="p">(</span><span class="mf">24.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">moonsetdiff</span><span class="o">.</span><span class="n">hour</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">12.</span> <span class="p">:</span> <span class="n">moonsetdiff</span> <span class="o">=</span> <span class="n">moonsetdiff</span> <span class="o">+</span> <span class="n">Angle</span><span class="p">(</span><span class="mf">24.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
        <span class="n">TDmoonset</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="n">moonsetdiff</span><span class="o">.</span><span class="n">hour</span> <span class="o">/</span> <span class="mf">24.</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmoonset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">midnight</span> <span class="o">+</span> <span class="n">TDmoonset</span>

        <span class="c1">#print &quot;moonset first approx:&quot;,self.tmoonset</span>
        <span class="c1">#print &quot;aiming for set alt = &quot;,self.site.setalt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmoonset</span> <span class="o">=</span> <span class="n">jd_moon_alt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">setalt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmoonset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="c1">#print &quot;moonset: &quot;,self.tmoonset # .to_datetime(timezone = localtzone)</span>

        <span class="n">moonriseha</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">ha_alt</span><span class="p">(</span><span class="n">moonmid</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">risealt</span><span class="p">)</span> <span class="c1"># signed </span>
        <span class="n">moonrisediff</span> <span class="o">=</span> <span class="n">moonriseha</span> <span class="o">-</span> <span class="n">hamoonmid</span>  <span class="c1"># how far from riseting point at midn.</span>
        <span class="c1"># find nearest riseing point </span>
        <span class="k">if</span> <span class="n">moonrisediff</span><span class="o">.</span><span class="n">hour</span> <span class="o">&gt;=</span> <span class="mf">12.</span> <span class="p">:</span> <span class="n">moonrisediff</span> <span class="o">=</span> <span class="n">moonrisediff</span> <span class="o">-</span> <span class="n">Angle</span><span class="p">(</span><span class="mf">24.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">moonrisediff</span><span class="o">.</span><span class="n">hour</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">12.</span> <span class="p">:</span> <span class="n">moonrisediff</span> <span class="o">=</span> <span class="n">moonrisediff</span> <span class="o">+</span> <span class="n">Angle</span><span class="p">(</span><span class="mf">24.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
        <span class="n">TDmoonrise</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="n">moonrisediff</span><span class="o">.</span><span class="n">hour</span> <span class="o">/</span> <span class="mf">24.</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmoonrise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">midnight</span> <span class="o">+</span> <span class="n">TDmoonrise</span>
        <span class="c1">#print &quot;moonrise first approx:&quot;,self.tmoonrise</span>
        <span class="c1">#print &quot;aiming for rise alt = &quot;,self.site.risealt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmoonrise</span> <span class="o">=</span> <span class="n">jd_moon_alt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">risealt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmoonrise</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="c1">#print &quot;moonrise: &quot;,self.tmoonrise # .to_datetime(timezone = localtzone)</span>

        <span class="c1"># Save this to avoid re-doing unnecessarily.  If lstmid is exactly the same,</span>
        <span class="c1"># then the night and location are almost certainly unchanged.</span>

        

        <span class="bp">self</span><span class="o">.</span><span class="n">previouslstmid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstmid</span></div>

<div class="viewcode-block" id="Observation.compute_hours_up"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyclasses3.Observation.compute_hours_up">[docs]</a>    <span class="k">def</span> <span class="nf">compute_hours_up</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="p">:</span> <span class="c1"># involves night events but is specific to this object.</span>
        <span class="sd">&quot;&quot;&quot;compute how long an object is up during the night, defined by</span>
<span class="sd">        12-degree (or nautical) twilight.  This requires setnightevents </span>
<span class="sd">        to have been run previously.  Computes how long the object is less</span>
<span class="sd">        that 3.0 airmass, 2.0 airmasses, and 1.5 airmasses.&quot;&quot;&quot;</span>

        <span class="c1"># this requires setnightevents to have been run for the same night.</span>

        <span class="n">minalt</span><span class="p">,</span> <span class="n">maxalt</span> <span class="o">=</span> <span class="n">min_max_alt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">celnow</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span> 

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">twilight12flag</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span> 

            <span class="bp">self</span><span class="o">.</span><span class="n">ha_mid</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lstmid</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">celnow</span><span class="o">.</span><span class="n">ra</span><span class="p">)</span><span class="o">.</span><span class="n">wrap_at</span><span class="p">(</span><span class="mf">12.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
            <span class="c1">#print(&quot;self.ha_mid.value&quot;,self.ha_mid.value)</span>
            <span class="c1">#print(&quot;self.ha_mid.hourangle&quot;,self.ha_mid.hourangle)</span>
            <span class="n">deltattran</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ha_mid</span><span class="o">.</span><span class="n">hourangle</span> <span class="o">/</span> <span class="mf">24.</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span><span class="p">)</span> <span class="o">/</span>  <span class="mf">1.0027379093</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ttransit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">midnight</span> <span class="o">-</span> <span class="n">deltattran</span>
            <span class="c1">#print(&quot;self.midnight = &quot;,self.midnight)</span>
            <span class="c1">#print(&quot;self.ttransit = &quot;,self.ttransit)</span>
            
            <span class="k">if</span> <span class="n">minalt</span> <span class="o">&lt;</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">ALT30</span> <span class="ow">and</span> <span class="n">maxalt</span> <span class="o">&gt;</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">ALT30</span> <span class="p">:</span>  
                <span class="c1"># if this dec passes through 3 airmasses</span>
                <span class="n">ha30</span> <span class="o">=</span> <span class="n">ha_alt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">celnow</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span><span class="n">thorconsts</span><span class="o">.</span><span class="n">ALT30</span><span class="p">)</span>
                <span class="n">dt30</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="n">ha30</span><span class="o">.</span><span class="n">hourangle</span> <span class="o">/</span> <span class="mf">24.</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1.0027379093</span>
                <span class="n">jd30_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttransit</span> <span class="o">-</span> <span class="n">dt30</span>   <span class="c1"># Time of rise through 3 airmasses</span>
                <span class="n">jd30_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttransit</span> <span class="o">+</span> <span class="n">dt30</span>   <span class="c1"># Time of set past 3 airmasses </span>
            <span class="c1">#    print(&quot;jd30_1 = &quot;,jd30_1)</span>
            <span class="c1">#    print(&quot;jd30_2 = &quot;,jd30_2)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uptime30</span> <span class="o">=</span> <span class="n">hrs_up</span><span class="p">(</span><span class="n">jd30_1</span><span class="p">,</span><span class="n">jd30_2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">tevetwi12</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">tmorntwi12</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">minalt</span> <span class="o">&gt;</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">ALT30</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uptime30</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmorntwi12</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tevetwi12</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">maxalt</span> <span class="o">&lt;</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">ALT30</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uptime30</span> <span class="o">=</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">ZERO_TIMEDELTA</span>
            <span class="c1">#print(&quot;time above 3 airm&quot;, self.uptime30)</span>

            <span class="k">if</span> <span class="n">minalt</span> <span class="o">&lt;</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">ALT20</span> <span class="ow">and</span> <span class="n">maxalt</span> <span class="o">&gt;</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">ALT20</span> <span class="p">:</span>  
                <span class="c1"># if it passes through 2 airmass </span>
                <span class="n">ha20</span> <span class="o">=</span> <span class="n">ha_alt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">celnow</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span><span class="n">thorconsts</span><span class="o">.</span><span class="n">ALT20</span><span class="p">)</span>
                <span class="n">dt20</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="n">ha20</span><span class="o">.</span><span class="n">hourangle</span> <span class="o">/</span> <span class="mf">24.</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1.0027379093</span>
                <span class="n">jd20_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttransit</span> <span class="o">-</span> <span class="n">dt20</span>
                <span class="n">jd20_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttransit</span> <span class="o">+</span> <span class="n">dt20</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uptime20</span> <span class="o">=</span> <span class="n">hrs_up</span><span class="p">(</span><span class="n">jd20_1</span><span class="p">,</span><span class="n">jd20_2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">tevetwi12</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">tmorntwi12</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">minalt</span> <span class="o">&gt;</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">ALT20</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uptime20</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmorntwi12</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tevetwi12</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">maxalt</span> <span class="o">&lt;</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">ALT20</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uptime20</span> <span class="o">=</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">ZERO_TIMEDELTA</span>
            <span class="c1">#print(&quot;time above 2 airm&quot;, self.uptime20)</span>
 

            <span class="k">if</span> <span class="n">minalt</span> <span class="o">&lt;</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">ALT15</span> <span class="ow">and</span> <span class="n">maxalt</span> <span class="o">&gt;</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">ALT15</span> <span class="p">:</span>  
                <span class="c1"># if it passes through 1.5 airmasses</span>
                <span class="n">ha15</span> <span class="o">=</span> <span class="n">ha_alt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">celnow</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span><span class="n">thorconsts</span><span class="o">.</span><span class="n">ALT15</span><span class="p">)</span>
                <span class="n">dt15</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="n">ha15</span><span class="o">.</span><span class="n">hourangle</span> <span class="o">/</span> <span class="mf">24.</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1.0027379093</span>
                <span class="n">jd15_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttransit</span> <span class="o">-</span> <span class="n">dt15</span>
                <span class="n">jd15_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttransit</span> <span class="o">+</span> <span class="n">dt15</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uptime15</span> <span class="o">=</span> <span class="n">hrs_up</span><span class="p">(</span><span class="n">jd15_1</span><span class="p">,</span><span class="n">jd15_2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">tevetwi12</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">tmorntwi12</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">minalt</span> <span class="o">&gt;</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">ALT15</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uptime15</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmorntwi12</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tevetwi12</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">maxalt</span> <span class="o">&lt;</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">ALT15</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uptime15</span> <span class="o">=</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">ZERO_TIMEDELTA</span></div>
            <span class="c1">#print(&quot;time above 1.5 airm&quot;, self.uptime15)</span>

<div class="viewcode-block" id="Observation.printnow"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyclasses3.Observation.printnow">[docs]</a>    <span class="k">def</span> <span class="nf">printnow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Compute the instantaneous circumstances to ensure they&#39;re current and </span>
<span class="sd">        print out a nicely formatted display.&quot;&quot;&quot;</span>

        <span class="c1"># first ensure that they&#39;re up to date ...</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">computesky</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computesunmoon</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computeplanets</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computebary</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Site : </span><span class="si">%s</span><span class="s2">;  E longit = </span><span class="si">%s</span><span class="s2">, lat = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">),</span> 
              <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     J2000:  </span><span class="si">%s</span><span class="s2">  </span><span class="si">%s</span><span class="s2">       (in </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> 
                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cel_J2000</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">,</span>
                 <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">pad</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">cel_J2000</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">precision</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pad</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">alwayssign</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">constel</span><span class="p">))</span>
        <span class="n">eqout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span>
        <span class="n">eqout</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s2">&quot;jyear_str&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> :  </span><span class="si">%s</span><span class="s2">  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">eqout</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">celnow</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">,</span>
                 <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">pad</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">celnow</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">precision</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                              <span class="n">pad</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">alwayssign</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="n">ut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">()</span>
        <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">timezone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">localtz</span><span class="p">)</span>
<span class="c1">#        localdow = dows[datetime.weekday()]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;UT date and time    : </span><span class="si">%s</span><span class="s2">    JD </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%a %Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">jd</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;local date and time : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">local</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%a %Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Local mean sidereal time: </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lst</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">,</span>
            <span class="n">precision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="n">parang_opposite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parang</span> <span class="o">+</span> <span class="n">Angle</span><span class="p">(</span><span class="mi">180</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span> 
        <span class="n">parang_opposite</span><span class="o">.</span><span class="n">wrap_at</span><span class="p">(</span><span class="mf">180.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hour angle: </span><span class="si">%s</span><span class="s2">  AltAz: </span><span class="si">%5.1f</span><span class="s2">, </span><span class="si">%6.1f</span><span class="s2">  Parallactic: </span><span class="si">%4.1f</span><span class="s2"> [</span><span class="si">%4.1f</span><span class="s2">]&quot;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hanow</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">precision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pad</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                         <span class="n">alwayssign</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">altit</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">az</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parang</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">parang_opposite</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">altit</span> <span class="o">&lt;</span> <span class="mf">0.</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Below horizon.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">airmass</span> <span class="o">&gt;</span> <span class="mf">10.</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Airmass &gt; 10.&quot;</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Airmass: </span><span class="si">%6.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">airmass</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Moon: </span><span class="si">%s</span><span class="s2">   Alt,Az </span><span class="si">%4.1f</span><span class="s2">, </span><span class="si">%4.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moonphasedescr</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">moonaltit</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">moonaz</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moonaltit</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="p">:</span>  <span class="c1"># give more detail on the moon if it&#39;s up.</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Moon ra and dec:  </span><span class="si">%s</span><span class="s2">  </span><span class="si">%s</span><span class="s2">  (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">moonpos</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">,</span>
                 <span class="n">precision</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">moonpos</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">fields</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                 <span class="n">pad</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">alwayssign</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span> <span class="n">eqout</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Illum. fract : </span><span class="si">%5.3f</span><span class="s2">   Moon-obj ang: </span><span class="si">%5.1f</span><span class="s2"> deg&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moonillumfrac</span><span class="p">,</span> 
                           <span class="bp">self</span><span class="o">.</span><span class="n">moonobjang</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lunsky</span> <span class="o">!=</span> <span class="mf">99.</span> <span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Lunar sky brightness </span><span class="si">%4.1f</span><span class="s2"> mag/sq arcsec&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lunsky</span><span class="p">))</span>

        <span class="k">else</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The moon is down. &quot;</span><span class="p">)</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sunaltit</span><span class="o">.</span><span class="n">deg</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">18.</span> <span class="p">:</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The sun is down; there is no twilight.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sunaltit</span><span class="o">.</span><span class="n">deg</span> <span class="o">&lt;</span> <span class="mf">0.</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;In twilight; sky </span><span class="si">%4.1f</span><span class="s2"> mag brighter than dark sky.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">twi</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;THE SUN IS UP.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sun RA and dec:  </span><span class="si">%s</span><span class="s2">  </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">);  AltAz </span><span class="si">%4.1f</span><span class="s2">, </span><span class="si">%5.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sunpos</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">,</span>
               <span class="n">precision</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pad</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sunpos</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">precision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
               <span class="n">pad</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">alwayssign</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span>
               <span class="n">eqout</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sunaltit</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sunaz</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Barycentric corrns: add </span><span class="si">%7.2f</span><span class="s2"> sec and </span><span class="si">%6.2f</span><span class="s2"> km/s to observed.&quot;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">barytcorr</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">baryvcorr</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Barycentric JD (UTC system): </span><span class="si">%14.5f</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tbary</span><span class="o">.</span><span class="n">jd</span><span class="p">))</span></div>

<div class="viewcode-block" id="Observation.printnight"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyclasses3.Observation.printnight">[docs]</a>    <span class="k">def</span> <span class="nf">printnight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_local_time</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Print a nicely formatted display of the rise/set times etc..&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setnightevents</span><span class="p">()</span> 
    
        <span class="k">if</span> <span class="n">use_local_time</span> <span class="p">:</span> 
           <span class="n">tz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">localtz</span>
           <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Night events; times listed are local.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
           <span class="n">tz</span> <span class="o">=</span> <span class="kc">None</span>
           <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Night events; times listed are UT.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sunset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsunset</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">timezone</span> <span class="o">=</span> <span class="n">tz</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;         Sunset:  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time_rounded_to_minute</span><span class="p">(</span><span class="n">sunset</span><span class="p">,</span> <span class="n">incl_date</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">incl_day</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)))</span>
        <span class="n">endtwi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tevetwi</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">timezone</span> <span class="o">=</span> <span class="n">tz</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Twilight Ends:  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time_rounded_to_minute</span><span class="p">(</span><span class="n">endtwi</span><span class="p">,</span> <span class="n">incl_date</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">incl_day</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)))</span>
        <span class="n">nghtctr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tnightcenter</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">timezone</span> <span class="o">=</span> <span class="n">tz</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Center of Night:  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time_rounded_to_minute</span><span class="p">(</span><span class="n">nghtctr</span><span class="p">,</span> <span class="n">incl_date</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">incl_day</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)))</span>
        <span class="n">begtwi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmorntwi</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">timezone</span> <span class="o">=</span> <span class="n">tz</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Twilight Begins:  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time_rounded_to_minute</span><span class="p">(</span><span class="n">begtwi</span><span class="p">,</span> <span class="n">incl_date</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">incl_day</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)))</span>
        <span class="n">sunrise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsunrise</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">timezone</span> <span class="o">=</span> <span class="n">tz</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;        Sunrise:  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time_rounded_to_minute</span><span class="p">(</span><span class="n">sunrise</span><span class="p">,</span> <span class="n">incl_date</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">incl_day</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="n">moonrise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmoonrise</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">timezone</span> <span class="o">=</span> <span class="n">tz</span><span class="p">)</span>
        <span class="n">moonset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmoonset</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">timezone</span> <span class="o">=</span> <span class="n">tz</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmoonrise</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmoonset</span> <span class="p">:</span>
           <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;       Moonrise:  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time_rounded_to_minute</span><span class="p">(</span><span class="n">moonrise</span><span class="p">,</span> <span class="n">incl_date</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">incl_day</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)))</span>
           <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;        Moonset:  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time_rounded_to_minute</span><span class="p">(</span><span class="n">moonset</span><span class="p">,</span> <span class="n">incl_date</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">incl_day</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)))</span>
        <span class="k">else</span> <span class="p">:</span> 
           <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;        Moonset:  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time_rounded_to_minute</span><span class="p">(</span><span class="n">moonset</span><span class="p">,</span> <span class="n">incl_date</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">incl_day</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)))</span>
           <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;       Moonrise:  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time_rounded_to_minute</span><span class="p">(</span><span class="n">moonrise</span><span class="p">,</span> <span class="n">incl_date</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">incl_day</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)))</span></div></div>

    
        
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span> <span class="p">:</span>

<span class="c1">#    sitedict = get_sites()</span>
<span class="c1">#    obsite = sitedict[&#39;mdm&#39;]</span>
   
<span class="c1">#    obgeo = obsite.location.to_geodetic()</span>
<span class="c1">#    print obgeo</span>

    <span class="c1"># cel = SkyCoord(&quot;21:29:36.2 -47:04:08&quot;,unit = (u.hourangle, u.deg), frame = &#39;icrs&#39;)</span>

<span class="c1">#    print &quot;year, month, day, hr, min&quot;</span>
<span class="c1">#</span>
<span class="c1">#    x = raw_input().split()</span>
<span class="c1">#    year = int(x[0])</span>
<span class="c1">#    month  = int(x[1])</span>
<span class="c1">#    day = int(x[2])</span>
<span class="c1">#    hr = int(x[3])</span>
<span class="c1">#    minute = int(x[4])</span>
<span class="c1">#    </span>
<span class="c1">#    dt = obsite.localtz.localize(datetime(year,month,day,hr,minute,0))</span>
<span class="c1">#    t = Time(dt)</span>
<span class="c1">#    print t.jd</span>
<span class="c1">#</span>
<span class="c1">#    dt2 = obsite.localtz.localize(datetime(2000,1,1,0,0,0)) </span>
<span class="c1">#    t2 = Time(dt2)</span>
<span class="c1">#    print t2.jd</span>
<span class="c1">#    </span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ra dec: &quot;</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">()</span>
    <span class="n">cel</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">unit</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span> <span class="n">frame</span> <span class="o">=</span> <span class="s1">&#39;icrs&#39;</span><span class="p">)</span>

    <span class="n">o</span> <span class="o">=</span> <span class="n">Observation</span><span class="p">(</span><span class="n">celest</span> <span class="o">=</span> <span class="n">cel</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;2018-07-22T23:00:00&quot;</span><span class="p">,</span> <span class="n">use_local_time</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
       <span class="n">site</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">default_site</span> <span class="o">=</span> <span class="s1">&#39;keck&#39;</span><span class="p">)</span> 

    <span class="n">obgeo</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">to_geodetic</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">obgeo</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span> <span class="n">o</span><span class="o">.</span><span class="n">celest</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span> <span class="n">o</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;lst: &quot;</span><span class="p">,</span><span class="n">o</span><span class="o">.</span><span class="n">lst</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;celnow: &quot;</span><span class="p">,</span><span class="n">o</span><span class="o">.</span><span class="n">celnow</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;hanow : &quot;</span><span class="p">,</span><span class="n">o</span><span class="o">.</span><span class="n">hanow</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;alt, az, parang &quot;</span><span class="p">,</span><span class="n">o</span><span class="o">.</span><span class="n">altit</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">az</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">parang</span><span class="p">)</span>
          
    <span class="n">o</span><span class="o">.</span><span class="n">setnightevents</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sunset:  &quot;</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">tsunset</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">timezone</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">localtz</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;eve twi: &quot;</span><span class="p">,</span><span class="n">o</span><span class="o">.</span><span class="n">tevetwi</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">timezone</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">localtz</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;night ctr:&quot;</span><span class="p">,</span><span class="n">o</span><span class="o">.</span><span class="n">tnightcenter</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">timezone</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">localtz</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;morn twi:&quot;</span><span class="p">,</span><span class="n">o</span><span class="o">.</span><span class="n">tmorntwi</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">timezone</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">localtz</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sunrise: &quot;</span><span class="p">,</span><span class="n">o</span><span class="o">.</span><span class="n">tsunrise</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">timezone</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">localtz</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;moonset: &quot;</span><span class="p">,</span><span class="n">o</span><span class="o">.</span><span class="n">tmoonset</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">timezone</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">localtz</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;moonrise:&quot;</span><span class="p">,</span><span class="n">o</span><span class="o">.</span><span class="n">tmoonrise</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">timezone</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">localtz</span><span class="p">))</span>

    <span class="n">o</span><span class="o">.</span><span class="n">computesunmoon</span><span class="p">()</span>
    
    <span class="n">o</span><span class="o">.</span><span class="n">computeplanets</span><span class="p">()</span>

    <span class="c1">#print &quot;c21:&quot;</span>
    <span class="c1">#print c2l</span>

    <span class="n">celnowxyz</span> <span class="o">=</span> <span class="n">cel2xyz</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">celnow</span><span class="p">)</span>
    <span class="c1">#print &quot;celnowxyz:&quot;</span>
    <span class="c1">#print celnowxyz</span>

    <span class="n">topoxyz</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">current2topoxyz</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">celnowxyz</span><span class="p">)</span>
 
    <span class="c1">#print &quot;topoxyz:&quot;</span>
    <span class="c1">#print topoxyz</span>
    <span class="c1"># print &quot;topoxyz[0]&quot;,topoxyz[0]</span>
    <span class="c1">#az = np.arctan2(topoxyz[0],topoxyz[1]) * thorconsts.DEG_IN_RADIAN</span>
    <span class="c1">#alt = np.arcsin(topoxyz[2]) * thorconsts.DEG_IN_RADIAN</span>
    <span class="c1">#print &quot;alt  az&quot;,alt,az</span>

    <span class="c1">#fullmat = c2l.dot(prec)   # both!</span>
    <span class="c1">#celxyz = cel2xyz(o.celest)   # icrs!</span>
    <span class="c1">#topo2 = fullmat.dot(celxyz)</span>
    <span class="c1">#print &quot;topo2:&quot;</span>
    <span class="c1">#print topo2</span>
    <span class="c1">#az2 = np.arctan2(topo2[0],topo2[1]) * thorconsts.DEG_IN_RADIAN</span>
    <span class="c1">#alt2 = np.arcsin(topo2[2]) * thorconsts.DEG_IN_RADIAN</span>
    <span class="c1">#print &quot;alt2  az2&quot;,alt2,az2</span>

    <span class="p">(</span><span class="n">bright2000</span><span class="p">,</span> <span class="n">brightmags</span><span class="p">,</span> <span class="n">brightcolors</span><span class="p">,</span> <span class="n">brightnames</span><span class="p">)</span> <span class="o">=</span> <span class="n">getbrightest</span><span class="p">(</span><span class="s2">&quot;cartesian_bright.dat&quot;</span><span class="p">)</span>
 
    <span class="p">(</span><span class="n">projectedx</span><span class="p">,</span><span class="n">projectedy</span><span class="p">)</span> <span class="o">=</span> <span class="n">skyproject</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">icrs2topoxyz</span><span class="p">,</span><span class="n">bright2000</span><span class="p">)</span>

    <span class="p">(</span><span class="n">objx</span><span class="p">,</span><span class="n">objy</span><span class="p">)</span> <span class="o">=</span> <span class="n">skyproject</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">current2topoxyz</span><span class="p">,</span><span class="n">celnowxyz</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">brightmags</span><span class="p">))</span> <span class="p">:</span> 
        <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mf">5.</span> <span class="o">-</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">brightmags</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> 
        <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span> 
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">projectedx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">projectedy</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;bo&#39;</span><span class="p">,</span><span class="n">markersize</span> <span class="o">=</span> <span class="n">size</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">objx</span><span class="p">,</span><span class="n">objy</span><span class="p">,</span><span class="s1">&#39;ro&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    
        
        
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">thorsky 0.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, John Thorstensen.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.6.
    </div>
  </body>
</html>