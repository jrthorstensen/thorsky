
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>thorsky.thorskyutil &#8212; thorsky 0.0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">thorsky 0.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for thorsky.thorskyutil</h1><div class="highlight"><pre>
<span></span><span class="ch">#! /usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;thorskyutil.py -- utility and miscellaneous time and the sky</span>
<span class="sd">   routines built mostly on astropy.  </span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Copyright John Thorstensen, 2018; offered under the GNU Public License 3.0</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="k">import</span> <span class="n">SkyCoord</span><span class="p">,</span> <span class="n">PrecessedGeocentric</span><span class="p">,</span> <span class="n">Angle</span><span class="p">,</span> <span class="n">Longitude</span><span class="p">,</span> <span class="n">Distance</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="k">import</span> <span class="n">GeocentricTrueEcliptic</span><span class="p">,</span> <span class="n">FK5</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="k">import</span> <span class="n">Time</span><span class="p">,</span> <span class="n">TimeDelta</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">pkgutil</span>

<div class="viewcode-block" id="thorconsts"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.thorconsts">[docs]</a><span class="k">class</span> <span class="nc">thorconsts</span> <span class="p">:</span>
   <span class="sd">&quot;&quot;&quot;Constants that are used here and there.  Some are Quantities, </span>
<span class="sd">   others are just floats. Not all are used. </span>

<span class="sd">   The planet-coefs are for series expansions for the phase functions</span>
<span class="sd">   of the planets, used in predicting apparent magnitude.  See code.&quot;&quot;&quot;</span>

   <span class="n">PI</span>              <span class="o">=</span>  <span class="mf">3.14159265358979</span>
   <span class="n">TWOPI</span>           <span class="o">=</span>  <span class="mf">6.28318530717959</span>
   <span class="n">PI_OVER_2</span>       <span class="o">=</span>  <span class="mf">1.57079632679490</span>  <span class="c1"># /* From Abramowitz &amp; Stegun */   </span>
   <span class="n">ARCSEC_IN_RADIAN</span><span class="o">=</span>  <span class="mf">206264.8062471</span>
   <span class="n">DEG_IN_RADIAN</span>   <span class="o">=</span>  <span class="mf">57.2957795130823</span>
   <span class="n">HRS_IN_RADIAN</span>   <span class="o">=</span>  <span class="mf">3.819718634205</span>
   <span class="n">KMS_AUDAY</span>       <span class="o">=</span>  <span class="mf">1731.45683633</span>  <span class="c1">#  /* km per sec in 1 AU/day */</span>
   <span class="n">SPEED_OF_LIGHT</span>  <span class="o">=</span>  <span class="mf">299792.458</span>     <span class="c1">#  /* in km per sec ... exact. */</span>
   <span class="n">SS_MASS</span>         <span class="o">=</span>  <span class="mf">1.00134198</span>     <span class="c1">#  /* solar system mass in solar units */</span>
   <span class="n">J2000</span>           <span class="o">=</span>  <span class="mf">2451545.</span>       <span class="c1">#  /* Julian date at standard epoch */</span>
   <span class="n">J2000_Time</span>      <span class="o">=</span>  <span class="n">Time</span><span class="p">(</span><span class="mf">2451545.</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;jd&#39;</span><span class="p">)</span> <span class="c1"># J2000 rendered as a Time</span>
   <span class="n">SEC_IN_DAY</span>      <span class="o">=</span>  <span class="mf">86400.</span>
   <span class="n">FLATTEN</span>         <span class="o">=</span>  <span class="mf">0.003352813</span>  <span class="c1">#  /* flattening of earth, 1/298.257 */</span>
   <span class="n">EQUAT_RAD</span>       <span class="o">=</span>  <span class="mf">6378137.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span>    <span class="c1"># /* equatorial radius of earth, meters */</span>
   <span class="n">EARTHRAD_IN_AU</span>  <span class="o">=</span>  <span class="mf">23454.7910556298</span> <span class="c1">#  /* number of earth rad in 1 au */</span>
   <span class="n">ASTRO_UNIT</span>      <span class="o">=</span>  <span class="mf">1.4959787066e11</span> <span class="c1"># /* 1 AU in meters */</span>
   <span class="n">RSUN</span>            <span class="o">=</span>  <span class="mf">6.96000e8</span>  <span class="c1"># /* IAU 1976 recom. solar radius, meters */</span>
   <span class="n">RMOON</span>           <span class="o">=</span>  <span class="mf">1.738e6</span>    <span class="c1"># /* IAU 1976 recom. lunar radius, meters */</span>
   <span class="n">PLANET_TOL</span>      <span class="o">=</span>  <span class="mf">3.</span>         <span class="c1">#  /* flag if nearer than 3 degrees </span>
   <span class="n">KZEN</span>            <span class="o">=</span> <span class="mf">0.172</span>       <span class="c1"># V-band zenith extinction for sky-brightness</span>

   <span class="n">ALT15</span>           <span class="o">=</span> <span class="mf">41.7291</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span> <span class="c1"># altitude at which true airm = 1.5</span>
   <span class="n">ALT20</span>           <span class="o">=</span> <span class="mf">29.8796</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span> <span class="c1"># same for 2.0</span>
   <span class="n">ALT30</span>           <span class="o">=</span> <span class="mf">19.278</span>  <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span> <span class="c1"># and 3.0</span>

   <span class="n">SIDRATE</span>         <span class="o">=</span> <span class="mf">1.0027379093</span>  <span class="c1"># ratio of sidereal to solar rate</span>
   <span class="n">SIDDAY</span>          <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;jd&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1.0027379093</span>
   <span class="n">ZERO_TIMEDELTA</span>  <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;jd&#39;</span><span class="p">)</span>

   <span class="c1"># list planets so dictionary entries can be called up in order.</span>
   <span class="n">PLANETNAMES</span>     <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mercury&#39;</span><span class="p">,</span><span class="s1">&#39;venus&#39;</span><span class="p">,</span><span class="s1">&#39;mars&#39;</span><span class="p">,</span><span class="s1">&#39;jupiter&#39;</span><span class="p">,</span><span class="s1">&#39;saturn&#39;</span><span class="p">,</span><span class="s1">&#39;uranus&#39;</span><span class="p">,</span><span class="s1">&#39;neptune&#39;</span><span class="p">]</span>
   <span class="c1"># Phase brightness coefficients for the inner planets.  </span>
   <span class="n">PLANETPHASECOEFS</span>  <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mercury&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mf">0.013363763741181076</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2480840022313796</span><span class="p">,</span>
             <span class="mf">1.6325515091649714</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.9390499605838665</span><span class="p">,</span> <span class="mf">7.718379797341275</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.131445146202686</span><span class="p">,</span>
             <span class="mf">3.7914559630732065</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.616</span><span class="p">),</span>    
             <span class="s1">&#39;venus&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mf">0.09632276402543158</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5292390263170846</span><span class="p">,</span> <span class="mf">1.2103116107350298</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05981450198047742</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.38394</span><span class="p">),</span>
             <span class="s1">&#39;mars&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.4274213867715291</span><span class="p">,</span> <span class="mf">1.2988953215615762</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.601</span><span class="p">),</span>
             <span class="s1">&#39;jupiter&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mf">9.40</span><span class="p">),</span> <span class="s1">&#39;saturn&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mf">9.22</span><span class="p">),</span> <span class="s1">&#39;uranus&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mf">7.19</span><span class="p">),</span> <span class="s1">&#39;neptune&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mf">6.87</span><span class="p">)}</span></div>
    <span class="c1"># These are adapted (converted to radian argument) from expressions given</span>
    <span class="c1"># by Mallama, A. Wang, D., and Howard, R. A., Icarus 155, 253 (2002) for Mercury,</span>
    <span class="c1"># Mallama, A. Wang, D., and Howard, R. A. Icarus 182, 10 (2005) for Venus, and</span>
    <span class="c1"># Mallama, A., Icarus 192, 404 (2007) for Mars.  For the outer planets the phase angle</span>
    <span class="c1"># is always nearly zero, so no phase angle correction is applied to Jupiter and further </span>
    <span class="c1"># planets -- their magnitudes are adjusted only for sun-planet and earth-planet inverse square </span>
    <span class="c1"># dimming. No attempt is made to account for the varying aspect of Saturn&#39;s rings.  </span>

<div class="viewcode-block" id="time_rounded_to_minute"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.time_rounded_to_minute">[docs]</a><span class="k">def</span> <span class="nf">time_rounded_to_minute</span><span class="p">(</span><span class="n">tm</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">incl_date</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">incl_day</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
         <span class="n">named_month</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">incl_year</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="p">:</span> 
    <span class="sd">&quot;&quot;&quot;Takes a datetime and returns a string giving the date correctly rounded to </span>
<span class="sd">    nearest minute.  Calls strftime.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tm : datetime</span>
<span class="sd">    sep : str, default = &#39; &#39;</span>
<span class="sd">         separator between output fields</span>
<span class="sd">    incl_date : boolean, default = False</span>
<span class="sd">         include calendar date in output</span>
<span class="sd">    incl_day : boolean, default = False</span>
<span class="sd">         include day of week in output string</span>
<span class="sd">    named_month : boolean, default = False</span>
<span class="sd">         output name of month instead of number</span>
<span class="sd">    incl_year : boolean, default = False</span>
<span class="sd">         include year in output string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># To get nearest minute, simply add half a minute to the time </span>
    <span class="c1"># and then format -- this works perfectly in edge cases (e.g.,</span>
    <span class="c1"># 2018-12-31  23:59:31  rounded to nearest minute gives 2019-01-01 00:00)</span>
     
    <span class="n">tm</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">incl_date</span> <span class="ow">and</span> <span class="n">incl_day</span> <span class="p">:</span>
        <span class="k">if</span> <span class="n">incl_year</span> <span class="p">:</span> 
            <span class="k">return</span> <span class="n">tm</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%a %Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">return</span> <span class="n">tm</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%a %m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">incl_date</span> <span class="p">:</span>
        <span class="k">if</span> <span class="n">incl_year</span> <span class="p">:</span> 
            <span class="k">return</span> <span class="n">tm</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span> 
            <span class="k">return</span> <span class="n">tm</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">incl_day</span> <span class="p">:</span>
        <span class="k">return</span> <span class="n">tm</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%a %H:%M&quot;</span><span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="k">return</span> <span class="n">tm</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H:%M&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="currentgeocentframe"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.currentgeocentframe">[docs]</a><span class="k">def</span> <span class="nf">currentgeocentframe</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="p">:</span> 
   <span class="sd">&quot;&quot;&quot;Returns a PrecessedGeocentric frame for the equinox </span>
<span class="sd">   spcified by the time.</span>
<span class="sd">   </span>
<span class="sd">   Parameters</span>
<span class="sd">   ----------</span>

<span class="sd">   time : astropy Time</span>
<span class="sd">   </span>
<span class="sd">   Returns </span>
<span class="sd"> </span>
<span class="sd">   an astropy PrecessedGeocentric time.</span>
<span class="sd">   &quot;&quot;&quot;</span>
<span class="c1"># Generate a PrecessedGeocentric frame for the current equinox.</span>
   <span class="n">time_ep</span> <span class="o">=</span> <span class="mf">2000.</span> <span class="o">+</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">jd</span> <span class="o">-</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">J2000</span><span class="p">)</span> <span class="o">/</span> <span class="mf">365.25</span>
   <span class="n">eq</span> <span class="o">=</span> <span class="s2">&quot;J</span><span class="si">%7.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time_ep</span><span class="p">)</span>
<span class="c1">#   print eq</span>
   <span class="k">return</span> <span class="n">PrecessedGeocentric</span><span class="p">(</span><span class="n">equinox</span> <span class="o">=</span> <span class="n">eq</span><span class="p">)</span></div>

<div class="viewcode-block" id="currentFK5frame"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.currentFK5frame">[docs]</a><span class="k">def</span> <span class="nf">currentFK5frame</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="p">:</span> 
   <span class="sd">&quot;&quot;&quot;Returns an FK5 frame for the equinox of the time.</span>
<span class="sd">   </span>
<span class="sd">   Parameters</span>
<span class="sd">   ----------</span>

<span class="sd">   time : astropy Time</span>
<span class="sd">   </span>
<span class="sd">   Returns: an astropy coordinate frame.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">time_ep</span> <span class="o">=</span> <span class="mf">2000.</span> <span class="o">+</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">jd</span> <span class="o">-</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">J2000</span><span class="p">)</span> <span class="o">/</span> <span class="mf">365.25</span>
   <span class="n">eq</span> <span class="o">=</span> <span class="s2">&quot;J</span><span class="si">%7.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time_ep</span><span class="p">)</span>
<span class="c1">#   print eq</span>
   <span class="k">return</span> <span class="n">FK5</span><span class="p">(</span><span class="n">equinox</span> <span class="o">=</span> <span class="n">eq</span><span class="p">)</span></div>

<div class="viewcode-block" id="min_max_alt"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.min_max_alt">[docs]</a><span class="k">def</span> <span class="nf">min_max_alt</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span><span class="n">dec</span><span class="p">)</span> <span class="p">:</span> 
   <span class="sd">&quot;&quot;&quot;Finds the mimimum and maximum altitudes of a celestial location.</span>
<span class="sd">   </span>
<span class="sd">   Parameters </span>
<span class="sd">   ----------</span>
<span class="sd">   lat : astropy Angle</span>
<span class="sd">        Latitude of site.</span>
<span class="sd">   dec : astropy Angle</span>
<span class="sd">        declination of the object.</span>

<span class="sd">   Returns :</span>

<span class="sd">   (minalt, maxalt) : both Astropy Angle</span>
<span class="sd">        tuple of minimum and maximum altitudes.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="c1"># arguments are Angles; returns (minalt, maxalt) as Angles</span>
   <span class="c1"># where min and max are the minimum and maximum altitude</span>
   <span class="c1"># an object at declination dec reaches at this latitude.</span>

   <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
   <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1.</span> <span class="p">:</span> 
      <span class="n">maxalt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> 
   <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">);</span>
   <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1.</span> <span class="p">:</span>
      <span class="n">minalt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> 
   <span class="k">return</span> <span class="p">(</span><span class="n">Angle</span><span class="p">(</span><span class="n">minalt</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">),</span> <span class="n">Angle</span><span class="p">(</span><span class="n">maxalt</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">))</span></div>

<div class="viewcode-block" id="ha_alt"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.ha_alt">[docs]</a><span class="k">def</span> <span class="nf">ha_alt</span><span class="p">(</span><span class="n">dec</span><span class="p">,</span><span class="n">lat</span><span class="p">,</span><span class="n">alt</span><span class="p">)</span> <span class="p">:</span>
   <span class="sd">&quot;&quot;&quot;Return an Angle giving the hour angle (from spherical astronomy, east</span>
<span class="sd">   or west of meridian, not the u.hourangle from astropy) at which </span>
<span class="sd">   the declination dec reaches altitute alt.</span>

<span class="sd">   If the object is always above alt, an Angle of +1000 radians is returned.</span>
<span class="sd">   If always below, -1000 radians.</span>
<span class="sd">   </span>
<span class="sd">   Parameters :</span>
<span class="sd">   dec : Angle</span>
<span class="sd">       Declination of source.</span>
<span class="sd">   lat : Angle</span>
<span class="sd">       Latitude of site.</span>
<span class="sd">   alt : Angle</span>
<span class="sd">       Height above horizon for computation.</span>
<span class="sd">   &quot;&quot;&quot;</span>

  <span class="c1"># Arguments are all angles.</span>
  <span class="c1"># returns hour angle at which object at dec is at altitude alt for a</span>
  <span class="c1"># latitude lat.</span>
    
   <span class="n">minalt</span><span class="p">,</span> <span class="n">maxalt</span> <span class="o">=</span>  <span class="n">min_max_alt</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span><span class="n">dec</span><span class="p">)</span> 
   <span class="k">if</span> <span class="n">alt</span> <span class="o">&lt;</span> <span class="n">minalt</span> <span class="p">:</span>  <span class="k">return</span> <span class="n">Angle</span><span class="p">(</span><span class="o">-</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">alt</span> <span class="o">&gt;</span> <span class="n">maxalt</span> <span class="p">:</span>  <span class="k">return</span> <span class="n">Angle</span><span class="p">(</span> <span class="mf">1000.</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span>
   <span class="n">rightang</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span>
   <span class="n">codec</span> <span class="o">=</span> <span class="n">rightang</span> <span class="o">-</span> <span class="n">dec</span>
   <span class="n">colat</span> <span class="o">=</span> <span class="n">rightang</span> <span class="o">-</span> <span class="n">lat</span> 
   <span class="n">zdist</span> <span class="o">=</span> <span class="n">rightang</span> <span class="o">-</span> <span class="n">alt</span> 
   <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">zdist</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">codec</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">colat</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">codec</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">colat</span><span class="p">));</span>
   <span class="k">return</span> <span class="n">Angle</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span></div>

<div class="viewcode-block" id="hrs_up"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.hrs_up">[docs]</a><span class="k">def</span> <span class="nf">hrs_up</span><span class="p">(</span><span class="n">timeup</span><span class="p">,</span> <span class="n">timedown</span><span class="p">,</span> <span class="n">evening</span><span class="p">,</span> <span class="n">morning</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;returns a TimeDelta giving how long an object is up during the </span>
<span class="sd">    night, basically the intersection between the interval is&#39;s &#39;up&#39; above</span>
<span class="sd">    a given altitude, and the interval when it&#39;s nighttime.</span>

<span class="sd">    Checks are implemented for circumpolar objects that can set and come back up.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    timeup : astropy Time </span>
<span class="sd">        Time at which the object rises above an altitude</span>
<span class="sd">    timedown : astropy Time </span>
<span class="sd">        Time at which an object sets below a given altitude</span>
<span class="sd">    evening : </span>
<span class="sd">        Time of the beginning of the night </span>
<span class="sd">    morning :  </span>
<span class="sd">        Time of the ending of the night</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
   <span class="c1"># all are Times.  </span>
   <span class="c1">#  timeup - when the object rises past a given altitle</span>
   <span class="c1">#  timedown - when the object sets past a given altitle</span>
   <span class="c1">#  evening - time of evening twiligt (however defined)</span>
   <span class="c1">#  morning - time of morning twiligt </span>
   <span class="c1"># return value will be a TimeDelta</span>

    <span class="k">if</span> <span class="n">timeup</span> <span class="o">&lt;</span> <span class="n">evening</span> <span class="p">:</span>  <span class="c1"># rises before evening</span>
        <span class="k">if</span> <span class="n">timedown</span> <span class="o">&gt;</span> <span class="n">morning</span> <span class="p">:</span>  <span class="c1"># up all night</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">morning</span> <span class="o">-</span> <span class="n">evening</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">timedown</span> <span class="o">&gt;</span> <span class="n">evening</span> <span class="p">:</span> 
            <span class="c1"># careful - circumpolar objects can come back up</span>
            <span class="c1"># a second time before morning.</span>
            <span class="n">timeup2</span> <span class="o">=</span> <span class="n">timeup</span> <span class="o">+</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">SIDDAY</span> 
            <span class="k">if</span> <span class="n">timeup2</span> <span class="o">&gt;</span> <span class="n">morning</span> <span class="p">:</span> <span class="c1"># usual case - doesn&#39;t rise again.</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">timedown</span> <span class="o">-</span> <span class="n">evening</span><span class="p">)</span> 
            <span class="k">else</span> <span class="p">:</span> 
                <span class="k">return</span> <span class="p">(</span><span class="n">timedown</span> <span class="o">-</span> <span class="n">evening</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">morning</span> <span class="o">-</span> <span class="n">timeup2</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">return</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">ZERO_TIMEDELTA</span>

    <span class="k">elif</span> <span class="n">timedown</span> <span class="o">&gt;</span> <span class="n">morning</span> <span class="p">:</span> <span class="c1"># still up at morning twi</span>
        <span class="k">if</span> <span class="n">timeup</span> <span class="o">&gt;</span> <span class="n">morning</span> <span class="p">:</span> <span class="k">return</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">ZERO_TIMEDELTA</span>
        <span class="k">else</span> <span class="p">:</span> 
            <span class="c1"># again an object can be up more than once per night </span>
            <span class="n">timedown0</span> <span class="o">=</span> <span class="n">timedown</span> <span class="o">-</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">SIDDAY</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">timedown0</span> <span class="o">&lt;</span> <span class="n">evening</span><span class="p">)</span> <span class="p">:</span> <span class="k">return</span> <span class="p">(</span><span class="n">morning</span> <span class="o">-</span> <span class="n">timeup</span><span class="p">)</span> 
            <span class="k">else</span> <span class="p">:</span> <span class="k">return</span> <span class="p">(</span><span class="n">timedown0</span> <span class="o">-</span> <span class="n">evening</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">morning</span> <span class="o">-</span> <span class="n">timeup</span><span class="p">)</span>

    <span class="k">else</span> <span class="p">:</span> <span class="k">return</span> <span class="p">(</span><span class="n">timedown</span> <span class="o">-</span> <span class="n">timeup</span><span class="p">)</span>   <span class="c1"># up and down the same night.</span></div>

<div class="viewcode-block" id="lpsidereal"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.lpsidereal">[docs]</a><span class="k">def</span> <span class="nf">lpsidereal</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span> <span class="p">:</span>
   <span class="sd">&quot;&quot;&quot;moderate-precision (1 sec) local sidereal time</span>

<span class="sd">   Adapted with minimal changes from skycalc routine. Native </span>
<span class="sd">   astropy routines are unnecessarily precise for our purposes and</span>
<span class="sd">   rather slow.</span>

<span class="sd">   Parameters : </span>
<span class="sd">      time : Time</span>
<span class="sd">      location : EarthLocation</span>
<span class="sd">   </span>
<span class="sd">   Returns: </span>
<span class="sd">      Angle   (sidereal time is the hour angle of the equinox.)</span>

<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">jdint</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">jd</span><span class="p">)</span>
   <span class="n">jdfrac</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">jd</span> <span class="o">-</span> <span class="n">jdint</span>
   <span class="k">if</span><span class="p">(</span><span class="n">jdfrac</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="p">:</span>
      <span class="n">jdmid</span> <span class="o">=</span> <span class="n">jdint</span> <span class="o">-</span> <span class="mf">0.5</span>
      <span class="n">ut</span> <span class="o">=</span> <span class="n">jdfrac</span> <span class="o">+</span> <span class="mf">0.5</span>  <span class="c1"># as fraction of a day.</span>

   <span class="k">else</span> <span class="p">:</span> 
      <span class="n">jdmid</span> <span class="o">=</span> <span class="n">jdint</span> <span class="o">+</span> <span class="mf">0.5</span>
      <span class="n">ut</span> <span class="o">=</span> <span class="n">jdfrac</span> <span class="o">-</span> <span class="mf">0.5</span>

   <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">jdmid</span> <span class="o">-</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">J2000</span><span class="p">)</span><span class="o">/</span><span class="mf">36525.</span><span class="p">;</span>
   
   <span class="n">sid</span> <span class="o">=</span> <span class="p">(</span><span class="mf">24110.54841</span><span class="o">+</span><span class="mf">8640184.812866</span><span class="o">*</span><span class="n">t</span><span class="o">+</span><span class="mf">0.093104</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">t</span><span class="o">-</span><span class="mf">6.2e-6</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">/</span><span class="mf">86400.</span>
   <span class="c1"># at Greenwich</span>
   <span class="n">sid_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
   <span class="n">sid</span> <span class="o">=</span> <span class="n">sid</span> <span class="o">-</span> <span class="n">sid_int</span>
   <span class="c1"># longitude is measured east so add.</span>
   <span class="n">sid</span> <span class="o">=</span> <span class="n">sid</span> <span class="o">+</span> <span class="mf">1.0027379093</span> <span class="o">*</span> <span class="n">ut</span> <span class="o">+</span> <span class="n">location</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">hour</span><span class="o">/</span><span class="mf">24.</span>
   <span class="n">sid_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
   <span class="n">sid</span> <span class="o">=</span> <span class="p">(</span><span class="n">sid</span> <span class="o">-</span> <span class="n">sid_int</span><span class="p">)</span> <span class="o">*</span> <span class="mf">24.</span>
   <span class="c1">#if(sid &lt; 0.) : sid = sid + 24.</span>
   <span class="n">sidout</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
   <span class="n">sidout</span><span class="o">.</span><span class="n">wrap_at</span><span class="p">(</span><span class="mf">24.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
   <span class="k">return</span> <span class="n">sidout</span></div>

<span class="c1"># In order to avoid having the altaz transformation look up </span>
<span class="c1"># the USNO database, we need our own altaz transformation.</span>

<div class="viewcode-block" id="altazparang"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.altazparang">[docs]</a><span class="k">def</span> <span class="nf">altazparang</span><span class="p">(</span><span class="n">dec</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span> <span class="p">:</span>  
   <span class="sd">&quot;&quot;&quot;Compute altitude above horizon, azimuth, and parallactic angle.</span>

<span class="sd">   The parallactic angle is the position angle of the arc between the </span>
<span class="sd">   object and the zenith, i.e. the position angle that points &#39;straight up&#39;</span>
<span class="sd">   when you&#39;re looking at an object.  It is important for atmospheric</span>
<span class="sd">   refraction and dispersion compensation, which Filippenko discusses</span>
<span class="sd">   ( 1982PASP...94..715F ).  Does not take small effects into</span>
<span class="sd">   account (polar motion, nutation, whatever) so is Lighter weight than </span>
<span class="sd">   the astropy equivalents.</span>

<span class="sd">   Filippenko&#39;s expression for the parallactic angle leaves it to the the user </span>
<span class="sd">   to select the correct root of an inverse trig function; this is handled </span>
<span class="sd">   automatically here by fully solving the astronomical triangle.</span>

<span class="sd">   Parameters</span>
<span class="sd">   ----------</span>
<span class="sd">   </span>
<span class="sd">   dec : Angle</span>
<span class="sd">       Declination </span>
<span class="sd">   ha : Angle </span>
<span class="sd">       Hour angle (spherical astronomy) of the position, positive westward</span>
<span class="sd">   lat : Angle</span>
<span class="sd">    Latitude of site.</span>

<span class="sd">   Returns</span>
<span class="sd">   </span>
<span class="sd">   tuple of (altitude, azimuth, parallactic), all of which are Angles.</span>

<span class="sd">   &quot;&quot;&quot;</span>
   <span class="c1"># The astropy altaz transformation depends on the 3 Mbyte</span>
   <span class="c1"># download from USNO to find the lst, so here is a stripped</span>
   <span class="c1"># down version. </span>
   <span class="c1"># Arguments are all assumed to be Angles so they don&#39;t need</span>
   <span class="c1"># to be converted to radians; the dec is assumed to be in</span>
   <span class="c1"># equinox of date to avoid </span>
   <span class="c1"># We get the parallactic angle almost for since we have </span>
   <span class="c1"># ha, colat, and altitude.</span>
   
   <span class="n">cosdec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
   <span class="n">sindec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
   <span class="n">cosha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span>
   <span class="n">sinha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span>
   <span class="n">coslat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
   <span class="n">sinlat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
   
   <span class="n">altit</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">cosdec</span> <span class="o">*</span> <span class="n">cosha</span> <span class="o">*</span> <span class="n">coslat</span> <span class="o">+</span> <span class="n">sindec</span> <span class="o">*</span> <span class="n">sinlat</span><span class="p">),</span><span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">radian</span><span class="p">)</span>

   <span class="n">y</span> <span class="o">=</span> <span class="n">sindec</span> <span class="o">*</span> <span class="n">coslat</span> <span class="o">-</span> <span class="n">cosdec</span> <span class="o">*</span> <span class="n">cosha</span> <span class="o">*</span> <span class="n">sinlat</span> <span class="c1"># due north component</span>
   <span class="n">z</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">cosdec</span> <span class="o">*</span> <span class="n">sinha</span>  <span class="c1"># due east component</span>
   <span class="n">az</span> <span class="o">=</span> <span class="n">Longitude</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">radian</span><span class="p">)</span>

   <span class="c1"># now solve the spherical trig to give parallactic angle</span>

   <span class="k">if</span> <span class="n">cosdec</span> <span class="o">!=</span> <span class="mf">0.</span> <span class="p">:</span> 
      <span class="n">sinp</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">az</span><span class="p">)</span> <span class="o">*</span> <span class="n">coslat</span> <span class="o">/</span> <span class="n">cosdec</span>
        <span class="c1"># spherical law of sines .. note cosdec = sin of codec,</span>
        <span class="c1"># coslat = sin of colat .... </span>
      <span class="n">cosp</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">az</span><span class="p">)</span> <span class="o">*</span> <span class="n">cosha</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">az</span><span class="p">)</span> <span class="o">*</span> <span class="n">sinha</span> <span class="o">*</span> <span class="n">sinlat</span>
        <span class="c1"># spherical law of cosines ... also expressed in </span>
        <span class="c1"># already computed variables.</span>
      <span class="n">parang</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">sinp</span><span class="p">,</span> <span class="n">cosp</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">radian</span><span class="p">)</span>
   <span class="k">else</span> <span class="p">:</span>   <span class="c1"># you&#39;re on the pole</span>
      <span class="n">parang</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">radian</span><span class="p">)</span>

   <span class="k">return</span><span class="p">(</span><span class="n">altit</span><span class="p">,</span> <span class="n">az</span><span class="p">,</span> <span class="n">parang</span><span class="p">)</span></div>

<div class="viewcode-block" id="angle_between"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.angle_between">[docs]</a><span class="k">def</span> <span class="nf">angle_between</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="p">:</span> 
    <span class="sd">&quot;&quot;&quot;Find the angle between two solar system body positions with</span>
<span class="sd">    the cartesian representation. &quot;&quot;&quot;</span>
    <span class="c1"># first draft used np.linalg but these cartesian representations are</span>
    <span class="c1"># not numpy arrays.</span>
    <span class="n">nra</span> <span class="o">=</span> <span class="n">a</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="n">y</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="n">z</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">nrb</span> <span class="o">=</span> <span class="n">b</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">y</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">z</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># the clip function avoids roundoffs outside of arccos domain.</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">nra</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">nrb</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">nra</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">nrb</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">nra</span><span class="o">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">nrb</span><span class="o">.</span><span class="n">z</span><span class="p">,</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">))</span>  </div>

<div class="viewcode-block" id="true_airmass"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.true_airmass">[docs]</a><span class="k">def</span> <span class="nf">true_airmass</span><span class="p">(</span><span class="n">altit</span><span class="p">)</span> <span class="p">:</span> 
    <span class="sd">&quot;&quot;&quot;true airmass for an altitude.</span>
<span class="sd"> </span>
<span class="sd">    Based on a fit to Kitt Peak airmass tables, C. M. Snell &amp; A. M. Heiser, 1968,</span>
<span class="sd">    PASP, 80, 336.  Valid to about airmass 12, and beyond that just returns </span>
<span class="sd">    secz minus 1.5, which won&#39;t be quite right.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    altit : Angle</span>
<span class="sd">        Altitude above horizon.</span>
<span class="sd">    </span>
<span class="sd">    Returns : float</span>
<span class="sd">    &quot;&quot;&quot;</span>
  <span class="c1"># takes an Angle and return the true airmass, based on </span>
<span class="c1"># 	 a tabulation of the mean KPNO </span>
<span class="c1">#            atmosphere given by C. M. Snell &amp; A. M. Heiser, 1968,</span>
<span class="c1"># 	   PASP, 80, 336.  They tabulated the airmass at 5 degr </span>
<span class="c1">#            intervals from z = 60 to 85 degrees; I fit the data with </span>
<span class="c1">#            a fourth order poly for (secz - airmass) as a function of</span>
<span class="c1">#            (secz - 1) using the IRAF curfit routine, then adjusted the</span>
<span class="c1">#            zeroth order term to force (secz - airmass) to zero at</span>
<span class="c1">#            z = 0.  The poly fit is very close to the tabulated points</span>
<span class="c1"># 	   (largest difference is 3.2e-4) and appears smooth.  </span>
<span class="c1">#            This 85-degree point is at secz = 11.47, so for secz &gt; 12</span>
<span class="c1">#            I just return secz - 1.5 ... about the largest offset </span>
<span class="c1">#            properly determined. */</span>
 
<span class="c1">#    coefs = [2.879465E-3,  3.033104E-3, 1.351167E-3, -4.716679E-5]</span>

    <span class="n">secz</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">altit</span><span class="p">)</span>   <span class="c1"># sec z = 1/sin (altit)</span>
    <span class="c1"># print &quot;sec z  &quot;,secz</span>
    <span class="k">if</span> <span class="n">secz</span> <span class="o">&lt;</span> <span class="mf">0.</span> <span class="p">:</span> <span class="k">return</span> <span class="o">-</span><span class="mf">1.</span>
    <span class="k">if</span> <span class="n">secz</span> <span class="o">&gt;</span> <span class="mf">12.</span> <span class="p">:</span> <span class="k">return</span> <span class="p">(</span><span class="n">secz</span> <span class="o">-</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="n">seczmin1</span> <span class="o">=</span> <span class="n">secz</span> <span class="o">-</span> <span class="mf">1.</span>
    <span class="n">coefs</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">4.716679E-5</span><span class="p">,</span> <span class="mf">1.351167E-3</span><span class="p">,</span>  <span class="mf">3.033104E-3</span><span class="p">,</span> <span class="mf">2.879465E-3</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>
    <span class="c1"># print &quot;poly gives&quot;,  np.polyval(coefs,seczmin1)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">secz</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">coefs</span><span class="p">,</span><span class="n">seczmin1</span><span class="p">))</span></div>

<div class="viewcode-block" id="geocent"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.geocent">[docs]</a><span class="k">def</span> <span class="nf">geocent</span><span class="p">(</span><span class="n">geolong</span><span class="p">,</span> <span class="n">geolat</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;geocentric XYZ coordinates for a location at a longitude,</span>
<span class="sd">        latitude and height above sea level.</span>

<span class="sd">        Retained because if one replaces the longitude input with the </span>
<span class="sd">        sidereal time, the return is the XYZ in the equatorial frame </span>
<span class="sd">        of date.  This is used in the lunar topocentric correction.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        geolong : Angle</span>
<span class="sd">            Geographic longitude, or LST to get celestial-aligned result</span>
<span class="sd">        geolat :  Angle</span>
<span class="sd">            Geographic latitude</span>
<span class="sd">        height :  float</span>
<span class="sd">            Height above sea level, which must be in meters.</span>

<span class="sd">        Returns: Tuple of astropy Quantities X, Y, Z, which </span>
<span class="sd">            are distances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        

<span class="c1"># computes the geocentric coordinates from the geodetic </span>
<span class="c1"># (standard map-type) longitude, latitude, and height. </span>
<span class="c1"># Notation generally follows 1992 Astr Almanac, p. K11 */</span>
<span class="c1"># NOTE that if you replace &quot;geolong&quot; with the local sidereal</span>
<span class="c1"># time, this automatically gives you XYZ in the equatorial frame</span>
<span class="c1"># of date.</span>
<span class="c1"># In this version, geolong and geolat are assumed to be </span>
<span class="c1"># Angles and height is assumed to be in meters; returns </span>
<span class="c1"># a triplet of explicit Distances.</span>

        <span class="n">denom</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">FLATTEN</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">geolat</span><span class="p">)</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">geolat</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">geolat</span><span class="p">)</span> <span class="o">+</span> <span class="n">denom</span><span class="o">*</span><span class="n">denom</span><span class="p">;</span>
        <span class="n">C_geo</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">denom</span><span class="p">);</span>
        <span class="n">S_geo</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">FLATTEN</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">FLATTEN</span><span class="p">)</span> <span class="o">*</span> <span class="n">C_geo</span><span class="p">;</span>
        <span class="n">C_geo</span> <span class="o">=</span> <span class="n">C_geo</span> <span class="o">+</span> <span class="n">height</span> <span class="o">/</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">EQUAT_RAD</span><span class="p">;</span>  
              <span class="c1">#  deviation from almanac notation -- include height here. </span>
        <span class="n">S_geo</span> <span class="o">=</span> <span class="n">S_geo</span> <span class="o">+</span> <span class="n">height</span> <span class="o">/</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">EQUAT_RAD</span><span class="p">;</span>
        <span class="n">distancemultiplier</span> <span class="o">=</span> <span class="n">Distance</span><span class="p">(</span><span class="n">thorconsts</span><span class="o">.</span><span class="n">EQUAT_RAD</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
        <span class="n">x_geo</span> <span class="o">=</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">EQUAT_RAD</span> <span class="o">*</span> <span class="n">C_geo</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">geolat</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">geolong</span><span class="p">)</span>
        <span class="n">y_geo</span> <span class="o">=</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">EQUAT_RAD</span> <span class="o">*</span> <span class="n">C_geo</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">geolat</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">geolong</span><span class="p">)</span>
        <span class="n">z_geo</span> <span class="o">=</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">EQUAT_RAD</span> <span class="o">*</span> <span class="n">S_geo</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">geolat</span><span class="p">)</span>
 
        <span class="k">return</span> <span class="n">x_geo</span><span class="p">,</span><span class="n">y_geo</span><span class="p">,</span><span class="n">z_geo</span></div>

<div class="viewcode-block" id="precessmatrix"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.precessmatrix">[docs]</a><span class="k">def</span> <span class="nf">precessmatrix</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create a matrix to transform celestial Cartesian coordinates from equinox t1 to equinox t2.</span>

<span class="sd">    The matrix is used for speed in precessing a large number of bright-star</span>
<span class="sd">    coordinates in the GUI program.</span>
<span class="sd">   </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    t1 : Time</span>
<span class="sd">       time to transform from</span>
<span class="sd">    t2 : Time</span>
<span class="sd">       time to transform to</span>
<span class="sd">    </span>
<span class="sd">    Returns: numpy 3x3 array</span>

<span class="sd">    &quot;&quot;&quot;</span> 
   <span class="c1"># Generates a matrix that transforms coordinates from equinox t1 to equinox </span>
   <span class="c1"># t2.  For fast precession of the background stars in display; the astropy</span>
   <span class="c1"># routines should be fast for everything else.</span>

    <span class="c1">#print &quot;t1.jd, thorconsts.J2000&quot;,t1.jd,thorconsts.J2000</span>

    <span class="n">ti</span> <span class="o">=</span> <span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">jd</span> <span class="o">-</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">J2000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">36525</span> <span class="c1"># * u.d)</span>
<span class="c1">#    print &quot;ti&quot;,ti</span>
    <span class="n">tf</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2</span><span class="o">.</span><span class="n">jd</span> <span class="o">-</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">J2000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">36525</span>  <span class="o">-</span> <span class="n">ti</span> <span class="c1"># * u.d)</span>
<span class="c1">#    print &quot;tf&quot;,tf</span>

    <span class="n">zeta</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2306.2181</span> <span class="o">+</span> <span class="mf">1.39656</span> <span class="o">*</span> <span class="n">ti</span> <span class="o">+</span> <span class="mf">0.000139</span> <span class="o">*</span> <span class="n">ti</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">tf</span> <span class="o">+</span> \
      <span class="p">(</span><span class="mf">0.30188</span> <span class="o">-</span> <span class="mf">0.000344</span> <span class="o">*</span> <span class="n">ti</span><span class="p">)</span> <span class="o">*</span> <span class="n">tf</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">0.017998</span> <span class="o">*</span> <span class="n">tf</span> <span class="o">**</span> <span class="mi">3</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">zeta</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.79280</span> <span class="o">+</span> <span class="mf">0.000410</span> <span class="o">*</span> <span class="n">ti</span><span class="p">)</span> <span class="o">*</span> <span class="n">tf</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.000205</span> <span class="o">*</span> <span class="n">tf</span> <span class="o">*</span> <span class="mi">3</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2004.3109</span> <span class="o">-</span> <span class="mf">0.8533</span> <span class="o">*</span> <span class="n">ti</span> <span class="o">-</span> <span class="mf">0.000217</span> <span class="o">*</span> <span class="n">ti</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">tf</span> \
     <span class="o">-</span> <span class="p">(</span><span class="mf">0.42665</span> <span class="o">+</span> <span class="mf">0.000217</span> <span class="o">*</span> <span class="n">ti</span><span class="p">)</span> <span class="o">*</span> <span class="n">tf</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">0.041833</span> <span class="o">*</span> <span class="n">tf</span> <span class="o">**</span> <span class="mi">3</span>
    
<span class="c1">#    print &quot;zeta, z, theta&quot;,zeta,z,theta</span>

    <span class="n">zeta</span> <span class="o">=</span> <span class="n">zeta</span> <span class="o">/</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">ARCSEC_IN_RADIAN</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">/</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">ARCSEC_IN_RADIAN</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">/</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">ARCSEC_IN_RADIAN</span>
 
    <span class="n">cosz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> 
    <span class="n">coszeta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">zeta</span><span class="p">)</span>
    <span class="n">costheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">sinz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">sinzeta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">zeta</span><span class="p">)</span>
    <span class="n">sintheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> 

<span class="c1">#    print &quot;cosz coszeta costheta&quot;,cosz, coszeta,costheta</span>
<span class="c1">#    print &quot;sinz sinzeta sintheta&quot;,sinz, sinzeta,sintheta</span>

<span class="c1"># compute the elements of the precession matrix -- set up</span>
<span class="c1">#      here as *from* standard epoch *to* input jd. </span>
<span class="c1"># build a list and then reshape into an array.</span>

    <span class="n">prow1</span>  <span class="o">=</span> <span class="p">[</span><span class="n">coszeta</span> <span class="o">*</span> <span class="n">cosz</span> <span class="o">*</span> <span class="n">costheta</span> <span class="o">-</span> <span class="n">sinzeta</span> <span class="o">*</span> <span class="n">sinz</span><span class="p">]</span>
    <span class="n">prow1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">sinzeta</span> <span class="o">*</span> <span class="n">cosz</span> <span class="o">*</span> <span class="n">costheta</span> <span class="o">-</span> <span class="n">coszeta</span> <span class="o">*</span> <span class="n">sinz</span><span class="p">)</span>
    <span class="n">prow1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">cosz</span> <span class="o">*</span> <span class="n">sintheta</span><span class="p">)</span>
 
    <span class="n">prow2</span> <span class="o">=</span> <span class="p">[</span><span class="n">coszeta</span> <span class="o">*</span> <span class="n">sinz</span> <span class="o">*</span> <span class="n">costheta</span> <span class="o">+</span> <span class="n">sinzeta</span> <span class="o">*</span> <span class="n">cosz</span><span class="p">]</span>
    <span class="n">prow2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">sinzeta</span> <span class="o">*</span> <span class="n">sinz</span> <span class="o">*</span> <span class="n">costheta</span> <span class="o">+</span> <span class="n">coszeta</span> <span class="o">*</span> <span class="n">cosz</span><span class="p">)</span>
    <span class="n">prow2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">sinz</span> <span class="o">*</span> <span class="n">sintheta</span><span class="p">)</span>
 
    <span class="n">prow3</span> <span class="o">=</span> <span class="p">[</span><span class="n">coszeta</span> <span class="o">*</span> <span class="n">sintheta</span><span class="p">]</span>
    <span class="n">prow3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">sinzeta</span> <span class="o">*</span> <span class="n">sintheta</span><span class="p">)</span>
    <span class="n">prow3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">costheta</span><span class="p">)</span>
 
    <span class="n">precessmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">prow1</span><span class="p">,</span> <span class="n">prow2</span><span class="p">,</span> <span class="n">prow3</span><span class="p">])</span>
<span class="c1">#    print precessmat</span>
 
    <span class="k">return</span> <span class="n">precessmat</span></div>

<div class="viewcode-block" id="cel2localmatrix"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.cel2localmatrix">[docs]</a><span class="k">def</span> <span class="nf">cel2localmatrix</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;compute matrix to take celestial cartesian coordinates to topocentric</span>
<span class="sd">    (local observer centered) coordinates.</span>

<span class="sd">    Celestial coordinates are :assumed to already be in </span>
<span class="sd">    equinox of date and have the standard definitions</span>

<span class="sd">  </span>
<span class="sd">    * X toward ra=0, dec=0</span>
<span class="sd">    * Y toward ra = 6 hr or 90 degrees, dec = 0</span>
<span class="sd">    * Z toward the north celestial pole;  </span>

<span class="sd">    Topocentric coordinates are a little unusual:</span>
<span class="sd">   </span>
<span class="sd">    * X toward due west</span>
<span class="sd">    * Y toward due south</span>
<span class="sd">    * Z toward the zenith.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    lst : Angle</span>
<span class="sd">         Local sidereal time</span>
<span class="sd">    lat : Angle</span>
<span class="sd">         Geographic latitude</span>

<span class="sd">    Returns: numpy 3x3 array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Generates the matrix to take celestial cartesian coordinates --</span>
    <span class="c1"># assumed to be a vector with </span>
    <span class="c1"># x toward (ra=0,dec=0),</span>
    <span class="c1"># y toward (ra = 6h, dec = 0),</span>
    <span class="c1"># z toward north celestial pole</span>
    <span class="c1"># and rotate them to a frame with</span>
    <span class="c1"># x = due W</span>
    <span class="c1"># y = due S</span>
    <span class="c1"># z = straight up.</span>
    <span class="c1"># lst and lat are Angles - local sidereal time and latitude.</span>

    <span class="n">coslst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
    <span class="n">sinlst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> 

    <span class="n">coscolat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
    <span class="n">sincolat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>

    <span class="c1"># rotates around polar axis so x axis points to merdian</span>
    <span class="n">mat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">coslst</span><span class="p">,</span><span class="n">sinlst</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="o">-</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">sinlst</span><span class="p">,</span> <span class="n">coslst</span><span class="p">,</span> <span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>

    <span class="c1"># rotates around east-west axis to rotate z axis to zenith </span>
    <span class="n">mat2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">coscolat</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="o">*</span><span class="n">sincolat</span><span class="p">],[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],[</span><span class="n">sincolat</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">coscolat</span><span class="p">]])</span>
   
    <span class="k">return</span> <span class="n">mat2</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat1</span><span class="p">)</span></div>

<div class="viewcode-block" id="cel2xyz"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.cel2xyz">[docs]</a><span class="k">def</span> <span class="nf">cel2xyz</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return normalized cartesian coordinates (direction cosines).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    coord : SkyCoord</span>

<span class="sd">    Returns: </span>
<span class="sd">    numpy array of length three.</span>
<span class="sd">    &quot;&quot;&quot;</span>
  <span class="c1"># Returns direction cosines of a SkyCoord.  Weirdly, this does not seem</span>
  <span class="c1"># to be included in the SkyCoord class.</span>
  <span class="c1"># As is standard, X is toward ra,dec = 0,0; Y toward ra = 6h, dec=0; </span>
  <span class="c1"># and Z toward the north celestial pole.</span>

    <span class="n">cosalpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">ra</span><span class="p">)</span>
    <span class="n">cosdec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span>
    <span class="n">sinalpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">ra</span><span class="p">)</span>
    <span class="n">sindec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">cosalpha</span> <span class="o">*</span> <span class="n">cosdec</span><span class="p">],[</span><span class="n">sinalpha</span> <span class="o">*</span> <span class="n">cosdec</span><span class="p">],</span> <span class="p">[</span><span class="n">sindec</span><span class="p">]])</span></div>

<div class="viewcode-block" id="skyproject"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.skyproject">[docs]</a><span class="k">def</span> <span class="nf">skyproject</span><span class="p">(</span><span class="n">rotmat</span><span class="p">,</span><span class="n">cartesian</span><span class="p">)</span> <span class="p">:</span> 
    <span class="sd">&quot;&quot;&quot;Rotate an array of cartesian coordinates and do a stereographic projection</span>
<span class="sd">    around the resulting Z-axis.</span>

<span class="sd">    Used to figure out where to plot the bright stars on a map of the sky </span>
<span class="sd">    above you at a given moment.  The rotation matrix is meant to transform</span>
<span class="sd">    from the input ICRS coordinates of the stars directly to the topocentric</span>
<span class="sd">    coordinates; the stereographic projection can then be done using array</span>
<span class="sd">    arithmetic without trig functions.  Use of numpy array operations makes this</span>
<span class="sd">    ridiculously fast.</span>

<span class="sd">    Parameters </span>
<span class="sd">    ----------</span>

<span class="sd">    rotmat : numpy 3x3 array</span>
<span class="sd">       the rotation matrix, usually from ICRS directly to topocentric XYZ</span>
<span class="sd">    cartesian : numpy array 3 x N (or is it N x 3?) </span>
<span class="sd">       array of cartesian (usually ICRS) coordinates to be transformed and projected.</span>

<span class="sd">    Returns </span>

<span class="sd">    tuple of numpy array of x coordinates, and numpy array of y coordinates</span>
<span class="sd">       projected onto a plane.  I believe x = 0, y = 1 is the north horizon point, </span>
<span class="sd">       x = 1 and y = 0 is the east horizon point.</span>
<span class="sd">   </span>
<span class="sd">    &quot;&quot;&quot;</span>
   
   <span class="c1"># rotmat is a rotation matrix -- possibly including precession --</span>
   <span class="c1"># to transform cartesian unit vector(s) to topocentric frame.</span>
   <span class="c1"># cartesian is one or more column vectors in an np array.</span>
   <span class="c1"># Does the rotation, and then the stereographic projection for </span>
   <span class="c1"># plotting.</span>

    <span class="n">topocentric</span> <span class="o">=</span> <span class="n">rotmat</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cartesian</span><span class="p">)</span>   <span class="c1"># rotate into place</span>

    <span class="n">projectedx</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">topocentric</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">topocentric</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>   <span class="c1"># stereographic projection</span>
    <span class="n">projectedy</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">topocentric</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">topocentric</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">projectedx</span><span class="p">,</span> <span class="n">projectedy</span><span class="p">)</span></div>

<div class="viewcode-block" id="getbrightest"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.getbrightest">[docs]</a><span class="k">def</span> <span class="nf">getbrightest</span><span class="p">()</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Internal package routine to read the provided bright-star list for use</span>
<span class="sd">    in displays.  </span>

<span class="sd">    The bright star list is an ascii list with one line per star.  It includes</span>
<span class="sd">    the J2000 coordinates as Cartesian triplets, which is useful later, the </span>
<span class="sd">    V magnitude, the name, and a hexadecimal string that encodes an RGB color</span>
<span class="sd">    used to render the star.  This was crudely computed from the spectral type</span>
<span class="sd">    listed in the bright star catalog.</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="c1"># read brightest star info from a fixed-name file included in the package.</span>
    <span class="c1"># modified from a routine that took a file path as the argument.</span>
    
    <span class="c1"># positions are stored as Cartesian unit vectors.  Build</span>
    <span class="c1"># arrays of each coord to make into a big numpy array.</span>

    <span class="n">X</span> <span class="o">=</span> <span class="p">[]</span>   
    <span class="n">Y</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">mags</span> <span class="o">=</span> <span class="p">[]</span>      <span class="c1"># V magnitudes.</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[]</span>    <span class="c1"># RGB strings for rending, precomputed.</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">bytestr</span> <span class="o">=</span> <span class="n">pkgutil</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;cartesian_bright.dat&#39;</span><span class="p">)</span>
    <span class="n">inf</span> <span class="o">=</span> <span class="n">bytestr</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ASCII&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>  <span class="c1"># this reads similarly to a file.</span>
    
    <span class="c1"># inf = open(path,&quot;r&quot;)</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">inf</span> <span class="p">:</span> 
        <span class="n">x</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>       
        <span class="n">Y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>       
        <span class="n">Z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>       
        <span class="n">mags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>

    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">])</span>
    <span class="c1"># print positions.shape</span>
    <span class="c1"># print positions</span>

    <span class="k">return</span> <span class="n">positions</span><span class="p">,</span> <span class="n">mags</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">names</span></div>
 
<div class="viewcode-block" id="flmoon"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.flmoon">[docs]</a><span class="k">def</span> <span class="nf">flmoon</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">nph</span><span class="p">)</span> <span class="p">:</span>
   <span class="sd">&quot;&quot;&quot;Compute the julian day at which moon phase nph occurs in lunation n</span>

<span class="sd">   Good to about 2 minutes, from Jean Meeus&#39; &quot;Astronomical Formulae for</span>
<span class="sd">   Calculators&quot;, 2nd edition, Willman-Bell.</span>

<span class="sd">   Parameters :</span>
<span class="sd">   n : int </span>
<span class="sd">       lunation number</span>
<span class="sd">   nph : int</span>
<span class="sd">       phase to compute; 0 = new, 1 = 1st quarter, 2 = full, 3 = last quarter</span>
<span class="sd">  </span>
<span class="sd">   Returns:  Julian date as a float (not a Time)</span>
<span class="sd">   &quot;&quot;&quot;</span>

<span class="c1"># Gives jd (+- 2 min) of phase nph on lunation n.</span>
<span class="c1"># Implements formulae found in Jean Meeus&#39; *Astronomical Formulae</span>
<span class="c1">#f or Calculators*, 2nd edition, Willman-Bell.  </span>

<span class="c1">#  n, nph lunation and phase; nph = 0 new, 1 1st, 2 full, 3 last </span>
<span class="c1">#  returns jd or requested phase.</span>

   <span class="n">lun</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">nph</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4.</span><span class="p">;</span>
   <span class="n">T</span> <span class="o">=</span> <span class="n">lun</span> <span class="o">/</span> <span class="mf">1236.85</span><span class="p">;</span>
   <span class="n">jd</span> <span class="o">=</span> <span class="mf">2415020.75933</span> <span class="o">+</span> <span class="mf">29.53058868</span> <span class="o">*</span> <span class="n">lun</span> \
           <span class="o">+</span> <span class="mf">0.0001178</span> <span class="o">*</span> <span class="n">T</span> <span class="o">*</span> <span class="n">T</span>  \
           <span class="o">-</span> <span class="mf">0.000000155</span> <span class="o">*</span> <span class="n">T</span> <span class="o">*</span> <span class="n">T</span> <span class="o">*</span> <span class="n">T</span>  \
           <span class="o">+</span> <span class="mf">0.00033</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">166.56</span> <span class="o">+</span> <span class="mf">132.87</span> <span class="o">*</span> <span class="n">T</span> <span class="o">-</span> <span class="mf">0.009173</span> <span class="o">*</span> <span class="n">T</span> <span class="o">*</span> <span class="n">T</span><span class="p">))</span>
   <span class="n">M</span> <span class="o">=</span> <span class="mf">359.2242</span> <span class="o">+</span> <span class="mf">29.10535608</span> <span class="o">*</span> <span class="n">lun</span> <span class="o">-</span> <span class="mf">0.0000333</span> <span class="o">*</span> <span class="n">T</span> <span class="o">*</span> <span class="n">T</span> <span class="o">-</span> <span class="mf">0.00000347</span> <span class="o">*</span> <span class="n">T</span> <span class="o">*</span> <span class="n">T</span> <span class="o">*</span> <span class="n">T</span>
   <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
   <span class="n">Mpr</span> <span class="o">=</span> <span class="mf">306.0253</span> <span class="o">+</span> <span class="mf">385.81691806</span> <span class="o">*</span> <span class="n">lun</span> <span class="o">+</span> <span class="mf">0.0107306</span> <span class="o">*</span> <span class="n">T</span> <span class="o">*</span> <span class="n">T</span> <span class="o">+</span> <span class="mf">0.00001236</span> <span class="o">*</span> <span class="n">T</span> <span class="o">*</span> <span class="n">T</span> <span class="o">*</span> <span class="n">T</span><span class="p">;</span>
   <span class="n">Mpr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">Mpr</span><span class="p">)</span> 
   <span class="n">F</span> <span class="o">=</span> <span class="mf">21.2964</span> <span class="o">+</span> <span class="mf">390.67050646</span> <span class="o">*</span> <span class="n">lun</span> <span class="o">-</span> <span class="mf">0.0016528</span> <span class="o">*</span> <span class="n">T</span> <span class="o">*</span> <span class="n">T</span> <span class="o">-</span> <span class="mf">0.00000239</span> <span class="o">*</span> <span class="n">T</span> <span class="o">*</span> <span class="n">T</span> <span class="o">*</span> <span class="n">T</span><span class="p">;</span>
   <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">F</span><span class="p">)</span> 
   <span class="k">if</span> <span class="p">(</span><span class="n">nph</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">nph</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">:</span>  <span class="c1"># /* new or full */</span>
           <span class="n">cor</span> <span class="o">=</span>   <span class="p">(</span><span class="mf">0.1734</span> <span class="o">-</span> <span class="mf">0.000393</span><span class="o">*</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">M</span><span class="p">)</span> \
                   <span class="o">+</span> <span class="mf">0.0021</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">M</span><span class="p">)</span> \
                   <span class="o">-</span> <span class="mf">0.4068</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Mpr</span><span class="p">)</span> \
                  <span class="o">+</span> <span class="mf">0.0161</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span><span class="p">)</span> \
                   <span class="o">-</span> <span class="mf">0.0004</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">Mpr</span><span class="p">)</span> \
                   <span class="o">+</span> <span class="mf">0.0104</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">F</span><span class="p">)</span> \
                   <span class="o">-</span> <span class="mf">0.0051</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">M</span> <span class="o">+</span> <span class="n">Mpr</span><span class="p">)</span> \
                   <span class="o">-</span> <span class="mf">0.0074</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">M</span> <span class="o">-</span> <span class="n">Mpr</span><span class="p">)</span> \
                   <span class="o">+</span> <span class="mf">0.0004</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">F</span><span class="o">+</span><span class="n">M</span><span class="p">)</span> \
                   <span class="o">-</span> <span class="mf">0.0004</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">F</span><span class="o">-</span><span class="n">M</span><span class="p">)</span> \
                   <span class="o">-</span> <span class="mf">0.0006</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">F</span><span class="o">+</span><span class="n">Mpr</span><span class="p">)</span> \
                   <span class="o">+</span> <span class="mf">0.0010</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">F</span><span class="o">-</span><span class="n">Mpr</span><span class="p">)</span> \
                   <span class="o">+</span> <span class="mf">0.0005</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">M</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span><span class="p">)</span>
           <span class="n">jd</span> <span class="o">=</span> <span class="n">jd</span> <span class="o">+</span> <span class="n">cor</span>
   
   <span class="k">else</span> <span class="p">:</span> 
           <span class="n">cor</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.1721</span> <span class="o">-</span> <span class="mf">0.0004</span><span class="o">*</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">M</span><span class="p">)</span> \
                   <span class="o">+</span> <span class="mf">0.0021</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">M</span><span class="p">)</span> \
                   <span class="o">-</span> <span class="mf">0.6280</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Mpr</span><span class="p">)</span> \
                   <span class="o">+</span> <span class="mf">0.0089</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Mpr</span><span class="p">)</span> \
                   <span class="o">-</span> <span class="mf">0.0004</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">Mpr</span><span class="p">)</span> \
                   <span class="o">+</span> <span class="mf">0.0079</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">F</span><span class="p">)</span> \
                   <span class="o">-</span> <span class="mf">0.0119</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">M</span> <span class="o">+</span> <span class="n">Mpr</span><span class="p">)</span> \
                   <span class="o">-</span> <span class="mf">0.0047</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">M</span> <span class="o">-</span> <span class="n">Mpr</span><span class="p">)</span> \
                   <span class="o">+</span> <span class="mf">0.0003</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">F</span> <span class="o">+</span> <span class="n">M</span><span class="p">)</span> \
                   <span class="o">-</span> <span class="mf">0.0004</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">F</span> <span class="o">-</span> <span class="n">M</span><span class="p">)</span> \
                   <span class="o">-</span> <span class="mf">0.0006</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">F</span> <span class="o">+</span> <span class="n">Mpr</span><span class="p">)</span> \
                   <span class="o">+</span> <span class="mf">0.0021</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">F</span> <span class="o">-</span> <span class="n">Mpr</span><span class="p">)</span> \
                   <span class="o">+</span> <span class="mf">0.0003</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">M</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">Mpr</span><span class="p">)</span> \
                   <span class="o">+</span> <span class="mf">0.0004</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">M</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">Mpr</span><span class="p">)</span> \
                   <span class="o">-</span> <span class="mf">0.0003</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">M</span> <span class="o">+</span> <span class="n">Mpr</span><span class="p">)</span>
           <span class="k">if</span> <span class="n">nph</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">cor</span> <span class="o">=</span> <span class="n">cor</span> <span class="o">+</span> <span class="mf">0.0028</span> <span class="o">-</span> \
                           <span class="mf">0.0004</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">M</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.0003</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Mpr</span><span class="p">)</span>
           <span class="k">if</span> <span class="n">nph</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">:</span> <span class="n">cor</span> <span class="o">=</span> <span class="n">cor</span> <span class="o">-</span> <span class="mf">0.0028</span> <span class="o">+</span> \
                           <span class="mf">0.0004</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">M</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.0003</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Mpr</span><span class="p">)</span>
           <span class="n">jd</span> <span class="o">=</span> <span class="n">jd</span> <span class="o">+</span> <span class="n">cor</span>
    
   <span class="k">return</span> <span class="n">jd</span></div>

<div class="viewcode-block" id="phase_descr"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.phase_descr">[docs]</a><span class="k">def</span> <span class="nf">phase_descr</span><span class="p">(</span><span class="n">jd</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;a human-readable string describing the phase of the moon.</span>

<span class="sd">    Given an input julian date, this determines interval to nearest </span>
<span class="sd">    moon phase and writes a description.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    jd : float  (not a Time)</span>
<span class="sd">         Julian date.</span>

<span class="sd">    Returns a string, e.g. &quot;2.8 days before last quarter&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nlast</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">jd</span> <span class="o">-</span> <span class="mf">2415020.5</span><span class="p">)</span> <span class="o">/</span> <span class="mf">29.5307</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">#  /* find current lunation */</span>

<span class="c1">#    print &quot;nlast = &quot;,nlast</span>

    <span class="n">lastnewjd</span> <span class="o">=</span> <span class="n">flmoon</span><span class="p">(</span><span class="n">nlast</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">newjd</span> <span class="o">=</span> <span class="n">flmoon</span><span class="p">(</span><span class="n">nlast</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">kount</span> <span class="o">=</span> <span class="mi">0</span>  
    <span class="c1"># count up to find appropriate lunation</span>
    <span class="k">while</span> <span class="n">newjd</span> <span class="o">&lt;</span> <span class="n">jd</span> <span class="ow">and</span> <span class="n">kount</span> <span class="o">&lt;</span> <span class="mi">40</span> <span class="p">:</span>
       <span class="n">lastnewjd</span> <span class="o">=</span> <span class="n">newjd</span>
       <span class="n">nlast</span> <span class="o">=</span> <span class="n">nlast</span> <span class="o">+</span> <span class="mi">1</span>
       <span class="n">newjd</span> <span class="o">=</span> <span class="n">flmoon</span><span class="p">(</span><span class="n">nlast</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
       <span class="n">kount</span> <span class="o">=</span> <span class="n">kount</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">kount</span> <span class="o">&gt;</span> <span class="mi">35</span> <span class="p">:</span>   <span class="c1"># /* oops ... didn&#39;t find it ... */</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;Didn&#39;t find phase in print_phase!&quot;</span><span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">jd</span> <span class="o">-</span> <span class="n">lastnewjd</span><span class="p">;</span>
        <span class="n">lunage</span> <span class="o">=</span> <span class="n">x</span>  
        <span class="n">nlast</span> <span class="o">=</span> <span class="n">nlast</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">lunation</span> <span class="o">=</span> <span class="n">nlast</span>
        <span class="n">noctiles</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mf">3.69134</span><span class="p">)</span> <span class="c1">#  3.69134 = 1/8 month; truncate. </span>
        <span class="k">if</span> <span class="n">noctiles</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>  <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%3.1f</span><span class="s2"> days since new moon&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="p">,</span> <span class="n">lunage</span><span class="p">,</span> <span class="n">lunation</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">noctiles</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="p">:</span> <span class="c1"># /* nearest first quarter */</span>
           <span class="n">fqjd</span> <span class="o">=</span> <span class="n">flmoon</span><span class="p">(</span><span class="n">nlast</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
           <span class="n">x</span> <span class="o">=</span> <span class="n">jd</span> <span class="o">-</span> <span class="n">fqjd</span>
           <span class="k">if</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">)</span> <span class="p">:</span>
               <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%3.1f</span><span class="s2"> days before first quarter&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="o">*</span><span class="n">x</span><span class="p">),</span> <span class="n">lunage</span><span class="p">,</span> <span class="n">lunation</span><span class="p">)</span>
           <span class="k">else</span> <span class="p">:</span> 
               <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%3.1f</span><span class="s2"> days since first quarter&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="p">,</span> <span class="n">lunage</span><span class="p">,</span> <span class="n">lunation</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">noctiles</span> <span class="o">&lt;=</span> <span class="mi">4</span> <span class="p">:</span> <span class="c1">#   /* nearest full */</span>
           <span class="n">fljd</span> <span class="o">=</span> <span class="n">flmoon</span><span class="p">(</span><span class="n">nlast</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> 
           <span class="n">x</span> <span class="o">=</span> <span class="n">jd</span> <span class="o">-</span> <span class="n">fljd</span><span class="p">;</span>
           <span class="k">if</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">)</span> <span class="p">:</span>
              <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%3.1f</span><span class="s2"> days until full moon&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="o">*</span><span class="n">x</span><span class="p">),</span> <span class="n">lunage</span><span class="p">,</span> <span class="n">lunation</span><span class="p">)</span>
           <span class="k">else</span> <span class="p">:</span>
              <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%3.1f</span><span class="s2"> days after full moon&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="p">,</span> <span class="n">lunage</span><span class="p">,</span> <span class="n">lunation</span><span class="p">)</span>
             
        <span class="k">elif</span> <span class="p">(</span><span class="n">noctiles</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">:</span>
           <span class="n">lqjd</span> <span class="o">=</span> <span class="n">flmoon</span><span class="p">(</span><span class="n">nlast</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> 
           <span class="n">x</span> <span class="o">=</span> <span class="n">jd</span> <span class="o">-</span> <span class="n">lqjd</span><span class="p">;</span>
           <span class="k">if</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">)</span> <span class="p">:</span>
              <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%3.1f</span><span class="s2"> days before last quarter&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="o">*</span><span class="n">x</span><span class="p">),</span> <span class="n">lunage</span><span class="p">,</span> <span class="n">lunation</span><span class="p">)</span>
           <span class="k">else</span> <span class="p">:</span>
              <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%3.1f</span><span class="s2"> days after last quarter&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="p">,</span> <span class="n">lunage</span><span class="p">,</span> <span class="n">lunation</span><span class="p">)</span>
           
        <span class="k">else</span> <span class="p">:</span> <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%3.1f</span><span class="s2"> days before new moon&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">newjd</span> <span class="o">-</span> <span class="n">jd</span><span class="p">),</span> <span class="n">lunage</span><span class="p">,</span> <span class="n">lunation</span><span class="p">)</span></div>


<span class="c1"># def lpmoon(time,lat,sid) : </span>
<div class="viewcode-block" id="lpmoon"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.lpmoon">[docs]</a><span class="k">def</span> <span class="nf">lpmoon</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="n">obs</span><span class="p">)</span> <span class="p">:</span> 
   <span class="sd">&quot;&quot;&quot;low-precision moon position.</span>
<span class="sd">    </span>
<span class="sd">   Good to about 0.1 deg, from the 1992 Astronomical Almanac, p. D46.</span>
<span class="sd">   Note that input time is a float.</span>

<span class="sd">   Parameters</span>
<span class="sd">   ----------</span>
<span class="sd">   time : float</span>
<span class="sd">        Time expressed as a Julian Date</span>
<span class="sd">   obs :  EarthLocation</span>
<span class="sd">        location of observatory.</span>

<span class="sd">   Returns</span>

<span class="sd">   SkyCoord with a distance set, topocentric.</span>

<span class="sd">   &quot;&quot;&quot;</span>

<span class="c1"># jd is a number; lat and sid are Angles.</span>
<span class="c1"># hands back topocentric RA, dec (radians) and distance</span>
<span class="c1"># (earth radii).  </span>

<span class="c1">#  Implements &quot;low precision&quot; moon algorithms from</span>
<span class="c1">#  Astronomical Almanac (p. D46 in 1992 version).  Does</span>
  
   <span class="n">T</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">jd</span> <span class="o">-</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">J2000</span><span class="p">)</span> <span class="o">/</span> <span class="mf">36525.</span><span class="p">;</span>  <span class="c1"># jul cent. since J2000.0 </span>

   <span class="n">sid</span> <span class="o">=</span> <span class="n">lpsidereal</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>
   <span class="n">lat</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">lat</span>


   <span class="n">lambd</span> <span class="o">=</span> <span class="mf">218.32</span> <span class="o">+</span> <span class="mf">481267.883</span> <span class="o">*</span> <span class="n">T</span> \
	   <span class="o">+</span> <span class="mf">6.29</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">134.9</span> <span class="o">+</span> <span class="mf">477198.85</span> <span class="o">*</span> <span class="n">T</span><span class="p">))</span> \
	   <span class="o">-</span> <span class="mf">1.27</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">259.2</span> <span class="o">-</span> <span class="mf">413335.38</span> <span class="o">*</span> <span class="n">T</span><span class="p">))</span> \
	   <span class="o">+</span> <span class="mf">0.66</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">235.7</span> <span class="o">+</span> <span class="mf">890534.23</span> <span class="o">*</span> <span class="n">T</span><span class="p">))</span> \
	   <span class="o">+</span> <span class="mf">0.21</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">269.9</span> <span class="o">+</span> <span class="mf">954397.70</span> <span class="o">*</span> <span class="n">T</span><span class="p">))</span> \
	   <span class="o">-</span> <span class="mf">0.19</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">357.5</span> <span class="o">+</span> <span class="mf">35999.05</span> <span class="o">*</span> <span class="n">T</span><span class="p">))</span> \
	   <span class="o">-</span> <span class="mf">0.11</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">186.6</span> <span class="o">+</span> <span class="mf">966404.05</span> <span class="o">*</span> <span class="n">T</span><span class="p">))</span> 
   <span class="n">lambd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">lambd</span><span class="p">)</span>
   <span class="n">beta</span> <span class="o">=</span> <span class="mf">5.13</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">93.3</span> <span class="o">+</span> <span class="mf">483202.03</span> <span class="o">*</span> <span class="n">T</span><span class="p">))</span> \
	   <span class="o">+</span> <span class="mf">0.28</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">228.2</span> <span class="o">+</span> <span class="mf">960400.87</span> <span class="o">*</span> <span class="n">T</span><span class="p">))</span> \
	   <span class="o">-</span> <span class="mf">0.28</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">318.3</span> <span class="o">+</span> <span class="mf">6003.18</span> <span class="o">*</span> <span class="n">T</span><span class="p">))</span> \
	   <span class="o">-</span> <span class="mf">0.17</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">217.6</span> <span class="o">-</span> <span class="mf">407332.20</span> <span class="o">*</span> <span class="n">T</span><span class="p">))</span> 
   <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
   <span class="n">pie</span> <span class="o">=</span> <span class="mf">0.9508</span> <span class="o">+</span> <span class="mf">0.0518</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">134.9</span> <span class="o">+</span> <span class="mf">477198.85</span> <span class="o">*</span> <span class="n">T</span><span class="p">))</span> \
	   <span class="o">+</span> <span class="mf">0.0095</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">259.2</span> <span class="o">-</span> <span class="mf">413335.38</span> <span class="o">*</span> <span class="n">T</span><span class="p">))</span> \
	   <span class="o">+</span> <span class="mf">0.0078</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">235.7</span> <span class="o">+</span> <span class="mf">890534.23</span> <span class="o">*</span> <span class="n">T</span><span class="p">))</span> \
	   <span class="o">+</span> <span class="mf">0.0028</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">269.9</span> <span class="o">+</span> <span class="mf">954397.70</span> <span class="o">*</span> <span class="n">T</span><span class="p">))</span> 
   <span class="n">pie</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">pie</span><span class="p">)</span>
   <span class="n">distance</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pie</span><span class="p">)</span>

   <span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lambd</span><span class="p">)</span>
   <span class="n">m</span> <span class="o">=</span> <span class="mf">0.9175</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lambd</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.3978</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
   <span class="n">n</span> <span class="o">=</span> <span class="mf">0.3978</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lambd</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.9175</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>

   <span class="n">x</span> <span class="o">=</span> <span class="n">l</span> <span class="o">*</span> <span class="n">distance</span> 
   <span class="n">y</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">distance</span> 
   <span class="n">z</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="n">distance</span>  <span class="c1"># /* for topocentric correction */</span>
    <span class="c1"># these are Angles so no need.</span>
	<span class="c1"># rad_lat = lat / DEG_IN_RADIAN</span>
	<span class="c1"># rad_lst = sid / HRS_IN_RADIAN</span>
   <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
   <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
   <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>

   <span class="n">topo_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="n">z</span><span class="p">)</span>

   <span class="n">l</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">topo_dist</span>
   <span class="n">m</span> <span class="o">=</span> <span class="n">y</span> <span class="o">/</span> <span class="n">topo_dist</span> 
   <span class="n">n</span> <span class="o">=</span> <span class="n">z</span> <span class="o">/</span> <span class="n">topo_dist</span>

   <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">l</span><span class="p">)</span>
   <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
   <span class="n">distancemultiplier</span> <span class="o">=</span> <span class="n">Distance</span><span class="p">(</span><span class="n">thorconsts</span><span class="o">.</span><span class="n">EQUAT_RAD</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>

   <span class="n">fr</span> <span class="o">=</span> <span class="n">currentgeocentframe</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
   <span class="k">return</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">topo_dist</span> <span class="o">*</span> <span class="n">distancemultiplier</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">fr</span><span class="p">)</span> </div>
<span class="c1"># </span>
<div class="viewcode-block" id="accumoon"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.accumoon">[docs]</a><span class="k">def</span> <span class="nf">accumoon</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span> <span class="p">:</span> <span class="c1"># ,geolat,lst) :</span>
        <span class="sd">&quot;&quot;&quot;compute topocentric location and distance of moon to better accuracy.</span>
<span class="sd"> </span>
<span class="sd">        This is good to about 0.01 degrees</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        time : Time</span>
<span class="sd">            An astropy Time.  This is converted to TT (terrestrial time) internally</span>
<span class="sd">            for the computations.</span>
<span class="sd">        obs : EarthLocation</span>
<span class="sd">            location on earth.</span>

<span class="sd">        Returns: </span>

<span class="sd">        tuple of a SkyCoord and a distance.</span>

<span class="sd">        &quot;&quot;&quot;</span>

<span class="c1">#  More accurate (but more elaborate and slower) lunar </span>
<span class="c1">#   ephemeris, from Jean Meeus&#39; *Astronomical Formulae For Calculators*,</span>
<span class="c1">#   pub. Willman-Bell.  Includes all the terms given there. */</span>

<span class="c1"># a run of comparisons every 3 days through 2018 shows that this</span>
<span class="c1"># agrees with the more accurate astropy positions with an RMS of </span>
<span class="c1"># 0.007 degrees.  </span>

        <span class="n">time_tt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">tt</span>  <span class="c1"># important to use correct time argument for this!!</span>

        <span class="n">T</span> <span class="o">=</span> <span class="p">(</span><span class="n">time_tt</span><span class="o">.</span><span class="n">jd</span> <span class="o">-</span> <span class="mf">2415020.</span><span class="p">)</span> <span class="o">/</span> <span class="mf">36525.</span> <span class="c1">#    this based around 1900 ... */</span>
        <span class="n">Tsq</span> <span class="o">=</span> <span class="n">T</span> <span class="o">*</span> <span class="n">T</span><span class="p">;</span>
        <span class="n">Tcb</span> <span class="o">=</span> <span class="n">Tsq</span> <span class="o">*</span> <span class="n">T</span><span class="p">;</span>

        <span class="n">Lpr</span> <span class="o">=</span> <span class="mf">270.434164</span> <span class="o">+</span> <span class="mf">481267.8831</span> <span class="o">*</span> <span class="n">T</span> <span class="o">-</span> <span class="mf">0.001133</span> <span class="o">*</span> <span class="n">Tsq</span> <span class="o">+</span> <span class="mf">0.0000019</span> <span class="o">*</span> <span class="n">Tcb</span>
        <span class="n">M</span> <span class="o">=</span> <span class="mf">358.475833</span> <span class="o">+</span> <span class="mf">35999.0498</span><span class="o">*</span><span class="n">T</span> <span class="o">-</span> <span class="mf">0.000150</span><span class="o">*</span><span class="n">Tsq</span> <span class="o">-</span> <span class="mf">0.0000033</span><span class="o">*</span><span class="n">Tcb</span>
        <span class="n">Mpr</span> <span class="o">=</span> <span class="mf">296.104608</span> <span class="o">+</span> <span class="mf">477198.8491</span><span class="o">*</span><span class="n">T</span> <span class="o">+</span> <span class="mf">0.009192</span><span class="o">*</span><span class="n">Tsq</span> <span class="o">+</span> <span class="mf">0.0000144</span><span class="o">*</span><span class="n">Tcb</span>
        <span class="n">D</span> <span class="o">=</span> <span class="mf">350.737486</span> <span class="o">+</span> <span class="mf">445267.1142</span><span class="o">*</span><span class="n">T</span> <span class="o">-</span> <span class="mf">0.001436</span> <span class="o">*</span> <span class="n">Tsq</span> <span class="o">+</span> <span class="mf">0.0000019</span><span class="o">*</span><span class="n">Tcb</span>
        <span class="n">F</span> <span class="o">=</span> <span class="mf">11.250889</span> <span class="o">+</span> <span class="mf">483202.0251</span><span class="o">*</span><span class="n">T</span> <span class="o">-</span><span class="mf">0.003211</span> <span class="o">*</span> <span class="n">Tsq</span> <span class="o">-</span> <span class="mf">0.0000003</span><span class="o">*</span><span class="n">Tcb</span>
        <span class="n">Om</span> <span class="o">=</span> <span class="mf">259.183275</span> <span class="o">-</span> <span class="mf">1934.1420</span><span class="o">*</span><span class="n">T</span> <span class="o">+</span> <span class="mf">0.002078</span><span class="o">*</span><span class="n">Tsq</span> <span class="o">+</span> <span class="mf">0.0000022</span><span class="o">*</span><span class="n">Tcb</span>

        <span class="n">Lpr</span> <span class="o">=</span> <span class="n">Lpr</span> <span class="o">%</span> <span class="mf">360.</span>
        <span class="n">Mpr</span> <span class="o">=</span> <span class="n">Mpr</span> <span class="o">%</span> <span class="mf">360.</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">M</span> <span class="o">%</span> <span class="mf">360.</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">D</span> <span class="o">%</span> <span class="mf">360.</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">F</span> <span class="o">%</span> <span class="mf">360.</span>
        <span class="n">Om</span> <span class="o">=</span> <span class="n">Om</span> <span class="o">%</span> <span class="mf">360.</span>

        <span class="n">sinx</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">51.2</span> <span class="o">+</span> <span class="mf">20.2</span> <span class="o">*</span> <span class="n">T</span><span class="p">))</span>
        <span class="n">Lpr</span> <span class="o">=</span> <span class="n">Lpr</span> <span class="o">+</span> <span class="mf">0.000233</span> <span class="o">*</span> <span class="n">sinx</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">M</span> <span class="o">-</span> <span class="mf">0.001778</span> <span class="o">*</span> <span class="n">sinx</span>
        <span class="n">Mpr</span> <span class="o">=</span> <span class="n">Mpr</span> <span class="o">+</span> <span class="mf">0.000817</span> <span class="o">*</span> <span class="n">sinx</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">D</span> <span class="o">+</span> <span class="mf">0.002011</span> <span class="o">*</span> <span class="n">sinx</span>
        
        <span class="n">sinx</span> <span class="o">=</span> <span class="mf">0.003964</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">346.560</span><span class="o">+</span><span class="mf">132.870</span><span class="o">*</span><span class="n">T</span> <span class="o">-</span><span class="mf">0.0091731</span><span class="o">*</span><span class="n">Tsq</span><span class="p">))</span>

        <span class="n">Lpr</span> <span class="o">=</span> <span class="n">Lpr</span> <span class="o">+</span> <span class="n">sinx</span><span class="p">;</span>
        <span class="n">Mpr</span> <span class="o">=</span> <span class="n">Mpr</span> <span class="o">+</span> <span class="n">sinx</span><span class="p">;</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">D</span> <span class="o">+</span> <span class="n">sinx</span><span class="p">;</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">F</span> <span class="o">+</span> <span class="n">sinx</span><span class="p">;</span>

        <span class="n">sinx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">Om</span><span class="p">))</span>
        <span class="n">Lpr</span> <span class="o">=</span> <span class="n">Lpr</span> <span class="o">+</span> <span class="mf">0.001964</span> <span class="o">*</span> <span class="n">sinx</span>
        <span class="n">Mpr</span> <span class="o">=</span> <span class="n">Mpr</span> <span class="o">+</span> <span class="mf">0.002541</span> <span class="o">*</span> <span class="n">sinx</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">D</span> <span class="o">+</span> <span class="mf">0.001964</span> <span class="o">*</span> <span class="n">sinx</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">F</span> <span class="o">-</span> <span class="mf">0.024691</span> <span class="o">*</span> <span class="n">sinx</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">F</span> <span class="o">-</span> <span class="mf">0.004328</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">Om</span> <span class="o">+</span> <span class="mf">275.05</span> <span class="o">-</span><span class="mf">2.30</span><span class="o">*</span><span class="n">T</span><span class="p">))</span>

        <span class="n">e</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">0.002495</span> <span class="o">*</span> <span class="n">T</span> <span class="o">-</span> <span class="mf">0.00000752</span> <span class="o">*</span> <span class="n">Tsq</span><span class="p">;</span>

        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>  <span class="c1"># these will all be arguments ... */</span>
        <span class="n">Mpr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">Mpr</span><span class="p">)</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">D</span><span class="p">)</span> 
        <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">F</span><span class="p">)</span> 
 
        <span class="n">lambd</span> <span class="o">=</span> <span class="n">Lpr</span> <span class="o">+</span> <span class="mf">6.288750</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">1.274018</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.658309</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.213616</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">-</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.185596</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>  \
                <span class="o">-</span> <span class="mf">0.114336</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">F</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.058793</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.057212</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">M</span> <span class="o">-</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.053320</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">+</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.045874</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">M</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.041024</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Mpr</span> <span class="o">-</span> <span class="n">M</span><span class="p">)</span> \
                <span class="o">-</span> <span class="mf">0.034718</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">D</span><span class="p">)</span> \
                <span class="o">-</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.030465</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">M</span><span class="o">+</span><span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.015326</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">F</span><span class="p">)</span> \
                <span class="o">-</span> <span class="mf">0.012528</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">F</span> <span class="o">+</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">-</span> <span class="mf">0.010980</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">F</span> <span class="o">-</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.010674</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.010034</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.008548</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">-</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.007910</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">M</span> <span class="o">-</span> <span class="n">Mpr</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">D</span><span class="p">)</span> \
                <span class="o">-</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.006783</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">+</span> <span class="n">M</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.005162</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Mpr</span> <span class="o">-</span> <span class="n">D</span><span class="p">)</span>

        <span class="c1">#       /* And furthermore.....*/</span>
 
        <span class="n">lambd</span> <span class="o">=</span> <span class="n">lambd</span> <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.005000</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">M</span> <span class="o">+</span> <span class="n">D</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.004049</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Mpr</span> <span class="o">-</span> <span class="n">M</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">D</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.003996</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">D</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.003862</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">D</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.003665</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.002695</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span> <span class="o">-</span> <span class="n">M</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.002602</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Mpr</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">F</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">D</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.002396</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">M</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">-</span> <span class="mf">0.002349</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Mpr</span> <span class="o">+</span> <span class="n">D</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.002249</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">M</span><span class="p">)</span> \
                <span class="o">-</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.002125</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span> <span class="o">+</span> <span class="n">M</span><span class="p">)</span> \
                <span class="o">-</span> <span class="n">e</span> <span class="o">*</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.002079</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">M</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.002059</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">Mpr</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">M</span><span class="p">)</span> \
                <span class="o">-</span> <span class="mf">0.001773</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Mpr</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">F</span><span class="p">)</span> \
                <span class="o">-</span> <span class="mf">0.001595</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">F</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">D</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.001220</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">M</span> <span class="o">-</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">-</span> <span class="mf">0.001110</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">F</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.000892</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Mpr</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">D</span><span class="p">)</span> \
                <span class="o">-</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.000811</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">M</span> <span class="o">+</span> <span class="n">Mpr</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">D</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.000761</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">M</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.000717</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Mpr</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">M</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.000704</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Mpr</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">M</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">D</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.000693</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">M</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">D</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.000598</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">M</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">F</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.000550</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Mpr</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">D</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.000538</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.000521</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">M</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.000486</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span> <span class="o">-</span> <span class="n">D</span><span class="p">)</span>
        
        <span class="n">B</span> <span class="o">=</span> <span class="mf">5.128189</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">F</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.280606</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Mpr</span> <span class="o">+</span> <span class="n">F</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.277693</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Mpr</span> <span class="o">-</span> <span class="n">F</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.173238</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">F</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.055413</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">+</span> <span class="n">F</span> <span class="o">-</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.046272</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">F</span> <span class="o">-</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.032573</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">+</span> <span class="n">F</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.017198</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span> <span class="o">+</span> <span class="n">F</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.009267</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">+</span> <span class="n">Mpr</span> <span class="o">-</span> <span class="n">F</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.008823</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span> <span class="o">-</span> <span class="n">F</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.008247</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">M</span> <span class="o">-</span> <span class="n">F</span><span class="p">)</span>  \
                <span class="o">+</span> <span class="mf">0.004323</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">F</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.004200</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">+</span> <span class="n">F</span> <span class="o">+</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.003372</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">F</span> <span class="o">-</span> <span class="n">M</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">D</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.002472</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">+</span> <span class="n">F</span> <span class="o">-</span> <span class="n">M</span> <span class="o">-</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.002222</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">+</span> <span class="n">F</span> <span class="o">-</span> <span class="n">M</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.002072</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">F</span> <span class="o">-</span> <span class="n">M</span> <span class="o">-</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.001877</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">F</span> <span class="o">-</span> <span class="n">M</span> <span class="o">+</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.001828</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">F</span> <span class="o">-</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">-</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.001803</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">F</span> <span class="o">+</span> <span class="n">M</span><span class="p">)</span> \
                <span class="o">-</span> <span class="mf">0.001750</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">F</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.001570</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Mpr</span> <span class="o">-</span> <span class="n">M</span> <span class="o">-</span> <span class="n">F</span><span class="p">)</span> \
                <span class="o">-</span> <span class="mf">0.001487</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">F</span> <span class="o">+</span> <span class="n">D</span><span class="p">)</span> \
                <span class="o">-</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.001481</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">F</span> <span class="o">+</span> <span class="n">M</span> <span class="o">+</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.001417</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">F</span> <span class="o">-</span> <span class="n">M</span> <span class="o">-</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.001350</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">F</span> <span class="o">-</span> <span class="n">M</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.001330</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">F</span> <span class="o">-</span> <span class="n">D</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.001106</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">F</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.001020</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">F</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.000833</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">F</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">Mpr</span><span class="p">)</span>
<span class="c1">#     /* not only that, but */</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">B</span> <span class="o">+</span> <span class="mf">0.000781</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Mpr</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">F</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.000670</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">F</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.000606</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">F</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.000597</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span> <span class="o">-</span> <span class="n">F</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.000492</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">+</span> <span class="n">Mpr</span> <span class="o">-</span> <span class="n">M</span> <span class="o">-</span> <span class="n">F</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.000450</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span> <span class="o">-</span> <span class="n">F</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">D</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.000439</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">Mpr</span> <span class="o">-</span> <span class="n">F</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.000423</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">F</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.000422</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">F</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">-</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.000367</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">M</span> <span class="o">+</span> <span class="n">F</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">-</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.000353</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">M</span> <span class="o">+</span> <span class="n">F</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">D</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.000331</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">F</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">D</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.000317</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">+</span> <span class="n">F</span> <span class="o">-</span> <span class="n">M</span> <span class="o">+</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.000306</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">M</span> <span class="o">-</span> <span class="n">F</span><span class="p">)</span> \
                <span class="o">-</span> <span class="mf">0.000283</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Mpr</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">F</span><span class="p">)</span>
         
        
        <span class="n">om1</span> <span class="o">=</span> <span class="mf">0.0004664</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">Om</span><span class="p">))</span>
        <span class="n">om2</span> <span class="o">=</span> <span class="mf">0.0000754</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">Om</span> <span class="o">+</span> <span class="mf">275.05</span> <span class="o">-</span> <span class="mf">2.30</span><span class="o">*</span><span class="n">T</span><span class="p">))</span>
        
        <span class="n">beta</span> <span class="o">=</span> <span class="n">B</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">om1</span> <span class="o">-</span> <span class="n">om2</span><span class="p">);</span>
         
        <span class="n">pie</span> <span class="o">=</span> <span class="mf">0.950724</span> <span class="o">+</span> <span class="mf">0.051818</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.009531</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.007843</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.002824</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.000857</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">+</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.000533</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">M</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.000401</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">M</span> <span class="o">-</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.000320</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Mpr</span> <span class="o">-</span> <span class="n">M</span><span class="p">)</span> \
                <span class="o">-</span> <span class="mf">0.000271</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">D</span><span class="p">)</span> \
                <span class="o">-</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.000264</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">M</span> <span class="o">+</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">-</span> <span class="mf">0.000198</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">F</span> <span class="o">-</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.000173</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.000167</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">-</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.000111</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">M</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.000103</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">-</span> <span class="mf">0.000084</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">D</span><span class="p">)</span> \
                <span class="o">-</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.000083</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">+</span> <span class="n">M</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.000079</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">0.000072</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">D</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.000064</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">M</span> <span class="o">+</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">-</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.000063</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">+</span> <span class="n">M</span> <span class="o">-</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.000041</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">M</span> <span class="o">+</span> <span class="n">D</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.000035</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span> <span class="o">-</span> <span class="n">M</span><span class="p">)</span> \
                <span class="o">-</span> <span class="mf">0.000033</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">Mpr</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">D</span><span class="p">)</span> \
                <span class="o">-</span> <span class="mf">0.000030</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Mpr</span> <span class="o">+</span> <span class="n">D</span><span class="p">)</span> \
                <span class="o">-</span> <span class="mf">0.000029</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">F</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">D</span><span class="p">)</span> \
                <span class="o">-</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.000029</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Mpr</span> <span class="o">+</span> <span class="n">M</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.000026</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">M</span><span class="p">)</span> \
                <span class="o">-</span> <span class="mf">0.000023</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">F</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">D</span> <span class="o">+</span> <span class="n">Mpr</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">0.000019</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">D</span> <span class="o">-</span> <span class="n">M</span> <span class="o">-</span> <span class="n">Mpr</span><span class="p">);</span>

        <span class="n">beta</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span> 
        <span class="n">lambd</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">lambd</span><span class="p">),</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span> 

        <span class="n">dist</span> <span class="o">=</span> <span class="n">Distance</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">pie</span><span class="p">))</span> <span class="o">*</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">EQUAT_RAD</span><span class="p">)</span>

<span class="c1"># place these in a skycoord in ecliptic coords of date.  Handle distance</span>
<span class="c1"># separately since it does not transform properly for some reason.</span>

        <span class="n">eq</span> <span class="o">=</span> <span class="s1">&#39;J</span><span class="si">%7.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">2000.</span> <span class="o">+</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">jd</span> <span class="o">-</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">J2000</span><span class="p">)</span> <span class="o">/</span> <span class="mf">365.25</span><span class="p">)</span>
        <span class="n">fr</span> <span class="o">=</span> <span class="n">GeocentricTrueEcliptic</span><span class="p">(</span><span class="n">equinox</span> <span class="o">=</span> <span class="n">eq</span><span class="p">)</span> 
        <span class="n">inecl</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">lon</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="n">lambd</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">),</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">),</span> <span class="n">frame</span><span class="o">=</span><span class="n">fr</span><span class="p">)</span>

<span class="c1"># Transform into geocentric equatorial.</span>

        <span class="n">geocen</span> <span class="o">=</span> <span class="n">inecl</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">currentgeocentframe</span><span class="p">(</span><span class="n">time</span><span class="p">))</span>

<span class="c1"># Do the topo correction yourself. First form xyz coords in equatorial syst of date</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">dist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">geocen</span><span class="o">.</span><span class="n">ra</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">geocen</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">dist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">geocen</span><span class="o">.</span><span class="n">ra</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">geocen</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">dist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">geocen</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span>

<span class="c1"># Now compute geocentric location of the observatory in a frame aligned with the </span>
<span class="c1"># equatorial system of date, which one can do simply by replacing the west longitude</span>
<span class="c1"># with the sidereal time</span>

        <span class="p">(</span><span class="n">xobs</span><span class="p">,</span> <span class="n">yobs</span><span class="p">,</span> <span class="n">zobs</span><span class="p">)</span> <span class="o">=</span> <span class="n">geocent</span><span class="p">(</span><span class="n">lpsidereal</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="n">obs</span><span class="p">),</span><span class="n">obs</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span><span class="mf">2000.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span> <span class="c1"># don&#39;t have obs.height yet</span>

<span class="c1"># recenter moon&#39;s cartesian coordinates on position of obs</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">xobs</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">yobs</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="n">zobs</span>

<span class="c1"># form the toposcentric ra and dec and bundle them into a skycoord of epoch of date.</span>

        <span class="n">topodist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 

        <span class="n">raout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
        <span class="n">decout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">z</span> <span class="o">/</span> <span class="n">topodist</span><span class="p">)</span>
        <span class="n">topocen</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">raout</span><span class="p">,</span> <span class="n">decout</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">currentgeocentframe</span><span class="p">(</span><span class="n">time</span><span class="p">))</span> 

        <span class="k">return</span> <span class="n">topocen</span><span class="p">,</span><span class="n">topodist</span></div>

<div class="viewcode-block" id="lpsun"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.lpsun">[docs]</a><span class="k">def</span> <span class="nf">lpsun</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="p">:</span>

   <span class="sd">&quot;&quot;&quot;low-precision position of the sun.</span>

<span class="sd">   Good to about 0.01 degree, from the 1990 Astronomical Almanac p. C24.</span>
<span class="sd">   At this level topocentric correction is not needed.</span>

<span class="sd">   Paramters</span>
<span class="sd">   ---------</span>
<span class="sd">   time : astropy Time</span>
<span class="sd">        </span>
<span class="sd">   Returns</span>

<span class="sd">   a SkyCoord in the geocentric frame of epoch of date.</span>

<span class="sd">   &quot;&quot;&quot;</span>

<span class="c1"># Low precision formulae for the sun, from Almanac p. C24 (1990) */</span>
<span class="c1"># said to be good to about a hundredth of a degree.</span>

   <span class="n">n</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">jd</span> <span class="o">-</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">J2000</span> <span class="p">;</span>   <span class="c1"># referred to J2000</span>
   <span class="n">L</span> <span class="o">=</span> <span class="mf">280.460</span> <span class="o">+</span> <span class="mf">0.9856474</span> <span class="o">*</span> <span class="n">n</span><span class="p">;</span>
   <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">357.528</span> <span class="o">+</span> <span class="mf">0.9856003</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
   <span class="n">lambd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">L</span> <span class="o">+</span> <span class="mf">1.915</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.020</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">g</span><span class="p">))</span>
   <span class="n">epsilon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">23.439</span> <span class="o">-</span> <span class="mf">0.0000004</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>

   <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lambd</span><span class="p">)</span>
   <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">epsilon</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lambd</span><span class="p">)</span>
   <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">epsilon</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lambd</span><span class="p">)</span>

   <span class="n">ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
   <span class="n">dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

   <span class="n">fr</span> <span class="o">=</span> <span class="n">currentgeocentframe</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
   <span class="k">return</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span><span class="n">dec</span><span class="p">,</span><span class="n">frame</span><span class="o">=</span><span class="n">fr</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="s1">&#39;radian&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="jd_sun_alt"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.jd_sun_alt">[docs]</a><span class="k">def</span> <span class="nf">jd_sun_alt</span><span class="p">(</span><span class="n">alt</span><span class="p">,</span><span class="n">tguess</span><span class="p">,</span><span class="n">location</span><span class="p">)</span> <span class="p">:</span>
   <span class="sd">&quot;&quot;&quot;time at which the sun crosses a given elevation.</span>

<span class="sd">   Parameters:</span>
<span class="sd">   </span>
<span class="sd">   alt : Angle</span>
<span class="sd">       Desired altitude.</span>
<span class="sd">   tguess : Time </span>
<span class="sd">       Starting time for iteration.  This must be fairly </span>
<span class="sd">       close so that the iteration coverges on the correct</span>
<span class="sd">       phenomenon (e.g., rise time, not set time).</span>
<span class="sd">   location : EarthLocation</span>
<span class="sd">       </span>
<span class="sd">   Returns: Time if convergent</span>
<span class="sd">            None if non-convergent</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="c1"># returns the Time at which the sun crosses a </span>
   <span class="c1"># particular altitude alt, which is an Angle, </span>
   <span class="c1"># for an EarthLocation location.</span>

   <span class="c1"># This of course happens twice a day (or not at </span>
   <span class="c1"># all); tguess is a Time approximating the answer.</span>
   <span class="c1"># The usual use case will be to compute roughly when</span>
   <span class="c1"># sunset or twilight occurs, and hand the result to this</span>
   <span class="c1"># routine to get a more exact answer.</span>

   <span class="c1"># This uses the low-precision sun &quot;lpsun&quot;, which is </span>
   <span class="c1"># typically good to 0.01 degree.  That&#39;s plenty good </span>
   <span class="c1"># enough for computing rise, set, and twilight times.</span>
           
   <span class="n">sunpos</span> <span class="o">=</span> <span class="n">lpsun</span><span class="p">(</span><span class="n">tguess</span><span class="p">)</span>
   <span class="c1">#print &quot;sunpos entering&quot;,sunpos</span>
   <span class="c1">#print &quot;tguess.jd, longit:&quot;,tguess.jd, location.lon.hour</span>
   <span class="n">tolerance</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="mf">1.0e-4</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;rad&#39;</span><span class="p">)</span>

   <span class="n">delt</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="mf">0.002</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span><span class="p">)</span>   <span class="c1"># timestep</span>
   <span class="c1">#print &quot;sidereal: &quot;,lpsidereal(tguess, location)</span>
   <span class="c1">#print &quot;sunpos.ra: &quot;,sunpos.ra</span>

   <span class="n">ha</span> <span class="o">=</span> <span class="n">lpsidereal</span><span class="p">(</span><span class="n">tguess</span><span class="p">,</span><span class="n">location</span><span class="p">)</span> <span class="o">-</span> <span class="n">sunpos</span><span class="o">.</span><span class="n">ra</span>
   <span class="c1">#print &quot;ha entering&quot;,ha</span>
   <span class="n">alt2</span><span class="p">,</span><span class="n">az</span><span class="p">,</span><span class="n">parang</span> <span class="o">=</span> <span class="n">altazparang</span><span class="p">(</span><span class="n">sunpos</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span><span class="n">Angle</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">),</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
   <span class="c1">#print &quot;alt2&quot;,alt2</span>
   <span class="n">tguess</span> <span class="o">=</span> <span class="n">tguess</span> <span class="o">+</span> <span class="n">delt</span>
   <span class="n">sunpos</span> <span class="o">=</span> <span class="n">lpsun</span><span class="p">(</span><span class="n">tguess</span><span class="p">)</span>
   <span class="c1">#print &quot;sunpos with delt&quot;,sunpos</span>
   <span class="n">alt3</span><span class="p">,</span><span class="n">az</span><span class="p">,</span><span class="n">parang</span> <span class="o">=</span> <span class="n">altazparang</span><span class="p">(</span><span class="n">sunpos</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span><span class="n">lpsidereal</span><span class="p">(</span><span class="n">tguess</span><span class="p">,</span><span class="n">location</span><span class="p">)</span> <span class="o">-</span> <span class="n">sunpos</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span>
            <span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
   <span class="n">err</span> <span class="o">=</span> <span class="n">alt3</span> <span class="o">-</span> <span class="n">alt</span><span class="p">;</span>
   <span class="c1">#print &quot;alt3, alt, err&quot;,alt3,alt,err</span>
   <span class="n">deriv</span> <span class="o">=</span> <span class="p">(</span><span class="n">alt3</span> <span class="o">-</span> <span class="n">alt2</span><span class="p">)</span> <span class="o">/</span> <span class="n">delt</span><span class="p">;</span>
   <span class="c1">#print &quot;deriv&quot;,deriv</span>
   <span class="n">kount</span> <span class="o">=</span> <span class="mi">0</span>
   <span class="k">while</span> <span class="nb">abs</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tolerance</span> <span class="ow">and</span> <span class="n">kount</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="p">:</span>
     <span class="n">tguess</span> <span class="o">=</span> <span class="n">tguess</span> <span class="o">-</span> <span class="n">err</span><span class="o">/</span><span class="n">deriv</span><span class="p">;</span>
     <span class="n">sunpos</span> <span class="o">=</span> <span class="n">lpsun</span><span class="p">(</span><span class="n">tguess</span><span class="p">)</span> 
     <span class="n">alt3</span><span class="p">,</span><span class="n">az</span><span class="p">,</span><span class="n">parang</span> <span class="o">=</span> <span class="n">altazparang</span><span class="p">(</span><span class="n">sunpos</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span><span class="n">lpsidereal</span><span class="p">(</span><span class="n">tguess</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span> <span class="o">-</span> <span class="n">sunpos</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span>
         <span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
     <span class="n">err</span> <span class="o">=</span> <span class="n">alt3</span> <span class="o">-</span> <span class="n">alt</span><span class="p">;</span>
     <span class="n">kount</span> <span class="o">=</span> <span class="n">kount</span> <span class="o">+</span> <span class="mi">1</span>
     <span class="k">if</span> <span class="n">kount</span> <span class="o">&gt;=</span> <span class="mi">9</span> <span class="p">:</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sunrise, set, or twilight calculation not converging!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
   <span class="k">return</span> <span class="n">tguess</span></div>

<div class="viewcode-block" id="jd_moon_alt"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.jd_moon_alt">[docs]</a><span class="k">def</span> <span class="nf">jd_moon_alt</span><span class="p">(</span><span class="n">alt</span><span class="p">,</span><span class="n">tguess</span><span class="p">,</span><span class="n">location</span><span class="p">)</span> <span class="p">:</span>
   <span class="sd">&quot;&quot;&quot;Time at which moon passes a given altitude.</span>

<span class="sd">   This really does have to be iterated since the moon moves fairly </span>
<span class="sd">   quickly.</span>

<span class="sd">   Parameters</span>
<span class="sd">   ----------</span>
<span class="sd">   alt : Angle</span>
<span class="sd">       desired altitude.</span>
<span class="sd">   tguess : Time</span>
<span class="sd">       initial guess; this needs to be fairly close.</span>
<span class="sd">   location : EarthLocation</span>

<span class="sd">   Returns </span>
<span class="sd">       a Time, or None if non-convergent.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="c1"># tguess is a Time, location is an EarthLocation </span>
           
   <span class="n">moonpos</span><span class="p">,</span> <span class="n">topodist</span> <span class="o">=</span> <span class="n">accumoon</span><span class="p">(</span><span class="n">tguess</span><span class="p">,</span><span class="n">location</span><span class="p">)</span>
   <span class="c1">#print &quot;npos entering&quot;,moonpos</span>
   <span class="c1">#print &quot;tguess.jd, longit:&quot;,tguess.jd, location.lon.hour</span>
   <span class="n">tolerance</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="mf">1.0e-4</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;rad&#39;</span><span class="p">)</span>

   <span class="n">delt</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="mf">0.002</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span><span class="p">)</span>   <span class="c1"># timestep</span>
   <span class="c1">#print &quot;sidereal: &quot;,lpsidereal(tguess, location)</span>
   <span class="c1">#print &quot;moonpos.ra: &quot;,moonpos.ra</span>

   <span class="n">ha</span> <span class="o">=</span> <span class="n">lpsidereal</span><span class="p">(</span><span class="n">tguess</span><span class="p">,</span><span class="n">location</span><span class="p">)</span> <span class="o">-</span> <span class="n">moonpos</span><span class="o">.</span><span class="n">ra</span>
   <span class="c1">#print &quot;ha entering&quot;,ha</span>
   <span class="n">alt2</span><span class="p">,</span><span class="n">az</span><span class="p">,</span><span class="n">parang</span> <span class="o">=</span> <span class="n">altazparang</span><span class="p">(</span><span class="n">moonpos</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span><span class="n">Angle</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">),</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
   <span class="c1">#print &quot;alt2&quot;,alt2</span>
   <span class="n">tguess</span> <span class="o">=</span> <span class="n">tguess</span> <span class="o">+</span> <span class="n">delt</span>
   <span class="n">moonpos</span><span class="p">,</span> <span class="n">topodist</span> <span class="o">=</span> <span class="n">accumoon</span><span class="p">(</span><span class="n">tguess</span><span class="p">,</span><span class="n">location</span><span class="p">)</span>
   <span class="c1">#print &quot;moonpos with delt&quot;,moonpos</span>
   <span class="n">alt3</span><span class="p">,</span><span class="n">az</span><span class="p">,</span><span class="n">parang</span> <span class="o">=</span> <span class="n">altazparang</span><span class="p">(</span><span class="n">moonpos</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span><span class="n">lpsidereal</span><span class="p">(</span><span class="n">tguess</span><span class="p">,</span><span class="n">location</span><span class="p">)</span> <span class="o">-</span> <span class="n">moonpos</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span>
            <span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
   <span class="n">err</span> <span class="o">=</span> <span class="n">alt3</span> <span class="o">-</span> <span class="n">alt</span><span class="p">;</span>
   <span class="c1">#print &quot;alt3, alt, err&quot;,alt3,alt,err</span>
   <span class="n">deriv</span> <span class="o">=</span> <span class="p">(</span><span class="n">alt3</span> <span class="o">-</span> <span class="n">alt2</span><span class="p">)</span> <span class="o">/</span> <span class="n">delt</span><span class="p">;</span>
   <span class="c1">#print &quot;deriv&quot;,deriv</span>
   <span class="n">kount</span> <span class="o">=</span> <span class="mi">0</span>
   <span class="k">while</span> <span class="nb">abs</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tolerance</span> <span class="ow">and</span> <span class="n">kount</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="p">:</span>
     <span class="c1">#print &quot;iterating: err = &quot;,err,&quot; kount = &quot;,kount</span>
     <span class="n">tguess</span> <span class="o">=</span> <span class="n">tguess</span> <span class="o">-</span> <span class="n">err</span><span class="o">/</span><span class="n">deriv</span><span class="p">;</span>
     <span class="n">moonpos</span><span class="p">,</span><span class="n">topodist</span> <span class="o">=</span> <span class="n">accumoon</span><span class="p">(</span><span class="n">tguess</span><span class="p">,</span><span class="n">location</span><span class="p">)</span> 
     <span class="n">alt3</span><span class="p">,</span><span class="n">az</span><span class="p">,</span><span class="n">parang</span> <span class="o">=</span> <span class="n">altazparang</span><span class="p">(</span><span class="n">moonpos</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span><span class="n">lpsidereal</span><span class="p">(</span><span class="n">tguess</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span> <span class="o">-</span> <span class="n">moonpos</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span>
         <span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
     <span class="n">err</span> <span class="o">=</span> <span class="n">alt3</span> <span class="o">-</span> <span class="n">alt</span><span class="p">;</span>
     <span class="n">kount</span> <span class="o">=</span> <span class="n">kount</span> <span class="o">+</span> <span class="mi">1</span>
     <span class="k">if</span> <span class="n">kount</span> <span class="o">&gt;=</span> <span class="mi">9</span> <span class="p">:</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;moonrise or set calculation not converging!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
   <span class="c1">#print &quot;out, err = &quot;,err</span>
   <span class="k">return</span> <span class="n">tguess</span></div>

<div class="viewcode-block" id="local_midnight_Time"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.local_midnight_Time">[docs]</a><span class="k">def</span> <span class="nf">local_midnight_Time</span><span class="p">(</span><span class="n">aTime</span><span class="p">,</span><span class="n">localtzone</span><span class="p">)</span> <span class="p">:</span>
   <span class="sd">&quot;&quot;&quot;find nearest local midnight.</span>

<span class="sd">   If it&#39;s before noon local time, returns previous midnight; </span>
<span class="sd">   if after noon, return next midnight.</span>

<span class="sd">   Parameters :  </span>
<span class="sd">   </span>
<span class="sd">   aTime : astropy Time</span>

<span class="sd">   localtzone : timezone object.</span>

<span class="sd">   Returns</span>
<span class="sd"> </span>
<span class="sd">   Time.  This is not zone-aware, but should be correct.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="c1"># takes an astropy Time and the local time zone and </span>
   <span class="c1"># generates another Time which is the nearest local</span>
   <span class="c1"># clock-time midnight.  The returned Time is unaware </span>
   <span class="c1"># of the timezone but should be correct.</span>
  
   <span class="n">datet</span> <span class="o">=</span> <span class="n">aTime</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">timezone</span> <span class="o">=</span> <span class="n">localtzone</span><span class="p">)</span> 
  
   <span class="c1"># if before midnight, add 12 hours </span>
   <span class="k">if</span> <span class="n">datet</span><span class="o">.</span><span class="n">hour</span> <span class="o">&gt;=</span> <span class="mi">12</span> <span class="p">:</span>
       <span class="n">datet</span> <span class="o">=</span> <span class="n">datet</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span> <span class="o">=</span> <span class="mf">12.</span><span class="p">)</span>

   <span class="n">datetmid</span> <span class="o">=</span> <span class="n">localtzone</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="n">datet</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">datet</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">datet</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

   <span class="k">return</span> <span class="n">Time</span><span class="p">(</span><span class="n">datetmid</span><span class="p">)</span></div>

<div class="viewcode-block" id="ztwilight"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.ztwilight">[docs]</a><span class="k">def</span> <span class="nf">ztwilight</span><span class="p">(</span><span class="n">alt</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Estimate twilight contribution to zenith sky brightness, in magnitudes</span>
<span class="sd">    per square arcsecond.  </span>

<span class="sd">    Evaluates a polynomial approximation to observational data (see source for </span>
<span class="sd">    reference) of zenith sky brightness (blue) as a function of the sun&#39;s elevation</span>
<span class="sd">    from -0.9 degrees to -18 degrees.  For reference, 3 mag is roughly Nautical</span>
<span class="sd">    twilight and looks &#39;pretty dark&#39;; something like 10 mag is about the maximum</span>
<span class="sd">    for broadband sky flats in many cases.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    alt : Angle</span>
<span class="sd">        Sun&#39;s elevation.  Meaningful range is -0.9 to -18 degrees.    </span>

<span class="sd">    Returns </span>
<span class="sd">        float.  If the sun is up, returns 20; if the sun below -18, returns 0.</span>

<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1"># Given an Angle alt in the range -0.9 to -18 degrees, </span>
<span class="c1"># evaluates a polynomial expansion for the approximate brightening</span>
<span class="c1"># in magnitudes of the zenith in twilight compared to its </span>
<span class="c1"># value at full night, as function of altitude of the sun (in degrees).</span>
<span class="c1"># To get this expression I looked in Meinel, A.,</span>
<span class="c1"># &amp; Meinel, M., &quot;Sunsets, Twilight, &amp; Evening Skies&quot;, Cambridge U.</span>
<span class="c1"># Press, 1983; there&#39;s a graph on p. 38 showing the decline of </span>
<span class="c1"># zenith twilight.  I read points off this graph and fit them with a</span>
<span class="c1"># polynomial.</span>
<span class="c1"># Comparison with Ashburn, E. V. 1952, JGR, v.57, p.85 shows that this</span>
<span class="c1"># is a good fit to his B-band measurements.  </span>

    <span class="k">if</span> <span class="n">alt</span><span class="o">.</span><span class="n">deg</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">0.9</span> <span class="p">:</span> <span class="k">return</span> <span class="mf">20.</span>  <span class="c1"># flag for sun up, also not grossly wrong.</span>
    <span class="k">if</span> <span class="n">alt</span><span class="o">.</span><span class="n">deg</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">18.</span> <span class="p">:</span> <span class="k">return</span> <span class="mf">0.</span>   <span class="c1"># fully dark, no contrib to zenith skyglow.</span>

    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">alt</span><span class="o">.</span><span class="n">deg</span> <span class="o">-</span> <span class="mf">9.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">9.0</span>  <span class="c1"># my polynomial&#39;s argument</span>
    <span class="k">return</span> <span class="p">((</span><span class="mf">2.0635175</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="mf">1.246602</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span> <span class="o">-</span> <span class="mf">9.4084495</span><span class="p">)</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="mf">6.132725</span></div>

<div class="viewcode-block" id="nightevents"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.nightevents">[docs]</a><span class="k">def</span> <span class="nf">nightevents</span><span class="p">(</span><span class="n">aTime</span><span class="p">,</span><span class="n">location</span><span class="p">,</span><span class="n">localtzone</span><span class="p">)</span> <span class="p">:</span>
   <span class="sd">&quot;&quot;&quot;Compute phenomena for a given night.</span>

<span class="sd">   This is mostly a testbed that prints results directly.</span>

<span class="sd">   Parameters</span>
<span class="sd">   ----------</span>
<span class="sd">   aTime : astropy TIme</span>
<span class="sd">        input time; if before noon, events of previous night are computed.</span>
<span class="sd">   location : EarthLocation</span>
<span class="sd">   localtzone : timezone object.</span>
<span class="sd">   &quot;&quot;&quot;</span>
<span class="c1"># prototype for the events of a single night -- sunset and rise,</span>
<span class="c1"># twilights, and moonrise and set.</span>

   <span class="n">midnight</span> <span class="o">=</span> <span class="n">local_midnight_Time</span><span class="p">(</span><span class="n">aTime</span><span class="p">,</span> <span class="n">localtzone</span><span class="p">)</span> <span class="c1"># nearest clock-time midnight</span>
   <span class="n">lstmid</span> <span class="o">=</span> <span class="n">lpsidereal</span><span class="p">(</span><span class="n">midnight</span><span class="p">,</span><span class="n">location</span><span class="p">)</span>
  
   <span class="n">sunmid</span> <span class="o">=</span> <span class="n">lpsun</span><span class="p">(</span><span class="n">midnight</span><span class="p">)</span>

   <span class="c1"># allow separate rise and set altitudes for horizon effects</span>
   <span class="n">setalt</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="o">-</span><span class="mf">0.833</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>  <span class="c1"># zd = 90 deg 50 arcmin</span>
   <span class="n">risealt</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="o">-</span><span class="mf">0.833</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>  <span class="c1"># zd = 90 deg 50 arcmin</span>
   <span class="n">twialt</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="o">-</span><span class="mf">18.</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>     <span class="c1"># 18 degree twilight</span>

   <span class="n">sunsetha</span> <span class="o">=</span> <span class="n">ha_alt</span><span class="p">(</span><span class="n">sunmid</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span><span class="n">setalt</span><span class="p">)</span>  <span class="c1"># corresponding hr angles </span>
   <span class="n">sunrisea</span> <span class="o">=</span> <span class="n">ha_alt</span><span class="p">(</span><span class="n">sunmid</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span><span class="n">risealt</span><span class="p">)</span>  <span class="c1"># corresponding hr angles </span>
   <span class="n">twilightha</span> <span class="o">=</span> <span class="n">ha_alt</span><span class="p">(</span><span class="n">sunmid</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span><span class="n">twialt</span><span class="p">)</span>  

   <span class="n">hasunmid</span> <span class="o">=</span> <span class="n">lstmid</span> <span class="o">-</span> <span class="n">sunmid</span><span class="o">.</span><span class="n">ra</span>  
   <span class="n">nightcenter</span> <span class="o">=</span> <span class="n">midnight</span> <span class="o">-</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="n">hasunmid</span><span class="o">.</span><span class="n">hour</span> <span class="o">/</span> <span class="mf">24.</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span><span class="p">)</span>
   <span class="c1"># print &quot;nightcenter&quot;, nightcenter</span>

   <span class="n">sunsetguess</span> <span class="o">=</span> <span class="p">(</span><span class="n">hasunmid</span> <span class="o">-</span> <span class="n">sunsetha</span><span class="p">)</span>      <span class="c1"># angles away from midnight</span>
   <span class="n">sunriseguess</span> <span class="o">=</span> <span class="p">(</span><span class="n">hasunmid</span> <span class="o">+</span> <span class="n">sunsetha</span><span class="p">)</span> 
   <span class="n">evetwiguess</span> <span class="o">=</span> <span class="p">(</span><span class="n">hasunmid</span> <span class="o">-</span> <span class="n">twilightha</span><span class="p">)</span>
   <span class="n">morntwiguess</span> <span class="o">=</span> <span class="p">(</span><span class="n">hasunmid</span> <span class="o">+</span> <span class="n">twilightha</span><span class="p">)</span>
   
   <span class="c1">#print &quot;setguess: &quot;,setguess</span>
   <span class="c1">#print &quot;twiguess: &quot;, twiguess</span>

   <span class="c1"># convert to time deltas</span>
   <span class="n">TDsunset</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="n">sunsetguess</span><span class="o">.</span><span class="n">hour</span> <span class="o">/</span> <span class="mf">24.</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span><span class="p">)</span>
   <span class="n">TDsunrise</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="n">sunriseguess</span><span class="o">.</span><span class="n">hour</span> <span class="o">/</span> <span class="mf">24.</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span><span class="p">)</span>
   <span class="n">TDevetwi</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="n">evetwiguess</span><span class="o">.</span><span class="n">hour</span> <span class="o">/</span> <span class="mf">24.</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span><span class="p">)</span>
   <span class="n">TDmorntwi</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="n">morntwiguess</span><span class="o">.</span><span class="n">hour</span> <span class="o">/</span> <span class="mf">24.</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span><span class="p">)</span>

   <span class="c1"># form into times and iterate to accurate answer.</span>

   <span class="n">tsunset</span> <span class="o">=</span> <span class="n">midnight</span> <span class="o">-</span> <span class="n">TDsunset</span>  <span class="c1"># first approx</span>
   <span class="n">tsunset</span> <span class="o">=</span> <span class="n">jd_sun_alt</span><span class="p">(</span><span class="n">setalt</span><span class="p">,</span> <span class="n">tsunset</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>

   <span class="n">tsunrise</span> <span class="o">=</span> <span class="n">midnight</span> <span class="o">-</span> <span class="n">TDsunrise</span>  <span class="c1"># first approx</span>
   <span class="n">tsunrise</span> <span class="o">=</span> <span class="n">jd_sun_alt</span><span class="p">(</span><span class="n">risealt</span><span class="p">,</span> <span class="n">tsunrise</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>

   <span class="n">tevetwi</span> <span class="o">=</span> <span class="n">midnight</span> <span class="o">-</span> <span class="n">TDevetwi</span>
   <span class="n">tevetwi</span> <span class="o">=</span> <span class="n">jd_sun_alt</span><span class="p">(</span><span class="n">twialt</span><span class="p">,</span> <span class="n">tevetwi</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>
  
   <span class="n">tmorntwi</span> <span class="o">=</span> <span class="n">midnight</span> <span class="o">-</span> <span class="n">TDmorntwi</span>
   <span class="n">tmorntwi</span> <span class="o">=</span> <span class="n">jd_sun_alt</span><span class="p">(</span><span class="n">twialt</span><span class="p">,</span> <span class="n">tmorntwi</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>

   <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;sunset: &quot;</span><span class="p">,</span><span class="n">tsunset</span><span class="p">)</span>
   <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;sunrise: &quot;</span><span class="p">,</span> <span class="n">tsunrise</span><span class="p">)</span>
   <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;eve twi: &quot;</span><span class="p">,</span> <span class="n">tevetwi</span><span class="p">)</span>
   <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;morn twi:&quot;</span><span class="p">,</span><span class="n">tmorntwi</span><span class="p">)</span>
   
   <span class="n">moonmid</span> <span class="o">=</span> <span class="n">lpmoon</span><span class="p">(</span><span class="n">midnight</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span> 
   <span class="n">hamoonmid</span> <span class="o">=</span> <span class="n">lstmid</span> <span class="o">-</span> <span class="n">moonmid</span><span class="o">.</span><span class="n">ra</span>
   <span class="n">hamoonmid</span> <span class="o">=</span> <span class="n">lstmid</span> <span class="o">-</span> <span class="n">moonmid</span><span class="o">.</span><span class="n">ra</span>
   <span class="n">hamoonmid</span><span class="o">.</span><span class="n">wrap_at</span><span class="p">(</span><span class="mf">12.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
 
   <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;moon at midnight: &quot;</span><span class="p">,</span><span class="n">moonmid</span><span class="p">)</span>
   <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;hamoonmid: &quot;</span><span class="p">,</span><span class="n">hamoonmid</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="s1">&#39;hr&#39;</span><span class="p">)</span>
 
   <span class="n">roughlunarday</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="mf">1.0366</span><span class="p">,</span><span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span><span class="p">)</span>  

   <span class="n">moonsetha</span> <span class="o">=</span> <span class="n">ha_alt</span><span class="p">(</span><span class="n">moonmid</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span><span class="n">setalt</span><span class="p">)</span>  <span class="c1"># corresponding hr angles </span>
   <span class="n">moonsetdiff</span> <span class="o">=</span> <span class="n">moonsetha</span> <span class="o">-</span> <span class="n">hamoonmid</span>  <span class="c1"># how far from setting point at midn.</span>
   <span class="c1"># find nearest setting point </span>
   <span class="k">if</span> <span class="n">moonsetdiff</span><span class="o">.</span><span class="n">hour</span> <span class="o">&gt;=</span> <span class="mf">12.</span> <span class="p">:</span> <span class="n">moonsetdiff</span> <span class="o">=</span> <span class="n">moonsetdiff</span> <span class="o">-</span> <span class="n">Angle</span><span class="p">(</span><span class="mf">24.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">moonsetdiff</span><span class="o">.</span><span class="n">hour</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">12.</span> <span class="p">:</span> <span class="n">moonsetdiff</span> <span class="o">=</span> <span class="n">moonsetdiff</span> <span class="o">+</span> <span class="n">Angle</span><span class="p">(</span><span class="mf">24.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
   <span class="n">TDmoonset</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="n">moonsetdiff</span><span class="o">.</span><span class="n">hour</span> <span class="o">/</span> <span class="mf">24.</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span><span class="p">)</span>
   <span class="n">tmoonset</span> <span class="o">=</span> <span class="n">midnight</span> <span class="o">+</span> <span class="n">TDmoonset</span>
   <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;moonset first approx:&quot;</span><span class="p">,</span><span class="n">tmoonset</span><span class="p">)</span>
   <span class="n">tmoonset</span> <span class="o">=</span> <span class="n">jd_moon_alt</span><span class="p">(</span><span class="n">setalt</span><span class="p">,</span> <span class="n">tmoonset</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>
   <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;moonset: &quot;</span><span class="p">,</span><span class="n">tmoonset</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">timezone</span> <span class="o">=</span> <span class="n">localtzone</span><span class="p">))</span>

   <span class="n">moonriseha</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">ha_alt</span><span class="p">(</span><span class="n">moonmid</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span><span class="n">risealt</span><span class="p">)</span> <span class="c1"># signed </span>
   <span class="n">moonrisediff</span> <span class="o">=</span> <span class="n">moonriseha</span> <span class="o">-</span> <span class="n">hamoonmid</span>  <span class="c1"># how far from riseting point at midn.</span>
   <span class="c1"># find nearest riseting point </span>
   <span class="k">if</span> <span class="n">moonrisediff</span><span class="o">.</span><span class="n">hour</span> <span class="o">&gt;=</span> <span class="mf">12.</span> <span class="p">:</span> <span class="n">moonrisediff</span> <span class="o">=</span> <span class="n">moonrisediff</span> <span class="o">-</span> <span class="n">Angle</span><span class="p">(</span><span class="mf">24.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">moonrisediff</span><span class="o">.</span><span class="n">hour</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">12.</span> <span class="p">:</span> <span class="n">moonrisediff</span> <span class="o">=</span> <span class="n">moonrisediff</span> <span class="o">+</span> <span class="n">Angle</span><span class="p">(</span><span class="mf">24.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
   <span class="n">TDmoonrise</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="n">moonrisediff</span><span class="o">.</span><span class="n">hour</span> <span class="o">/</span> <span class="mf">24.</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span><span class="p">)</span>
   <span class="n">tmoonrise</span> <span class="o">=</span> <span class="n">midnight</span> <span class="o">+</span> <span class="n">TDmoonrise</span>
   <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;moonrise first approx:&quot;</span><span class="p">,</span><span class="n">tmoonrise</span><span class="p">)</span>
   <span class="n">tmoonrise</span> <span class="o">=</span> <span class="n">jd_moon_alt</span><span class="p">(</span><span class="n">risealt</span><span class="p">,</span> <span class="n">tmoonrise</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>
   <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;moonrise: &quot;</span><span class="p">,</span><span class="n">tmoonrise</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">timezone</span> <span class="o">=</span> <span class="n">localtzone</span><span class="p">))</span></div>
 
<div class="viewcode-block" id="lunskybright"><a class="viewcode-back" href="../../source/thorsky.html#thorsky.thorskyutil.lunskybright">[docs]</a><span class="k">def</span> <span class="nf">lunskybright</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span><span class="n">rho</span><span class="p">,</span><span class="n">kzen</span><span class="p">,</span><span class="n">altmoon</span><span class="p">,</span><span class="n">alt</span><span class="p">,</span> <span class="n">moondist</span><span class="p">,</span> <span class="n">sunalt</span><span class="p">)</span> <span class="p">:</span>
     <span class="sd">&quot;&quot;&quot;Evaluate sky brightness due to the moon, in V mag per square</span>
<span class="sd">     arcsec.</span>
<span class="sd">  </span>
<span class="sd">     Expressions are from  K. Krisciunas and B. E. Schaeffer (1991) </span>
<span class="sd">     PASP 103, 1033.</span>
<span class="sd">     For comparison, &#39;dark&#39; night sky is about 21.5 mag per square </span>
<span class="sd">     arcsec.  Looking well away from the moon on a clear night with  </span>
<span class="sd">     full moon, one can expect roughly 18th mag per square arcsec.</span>
<span class="sd">     </span>
<span class="sd">     Parameters</span>
<span class="sd">     ----------</span>
<span class="sd">     alpha : Angle</span>
<span class="sd">         angle subtended by sun and moon at observer, converted</span>
<span class="sd">         internally to its supplement.</span>
<span class="sd">     rho : Angle</span>
<span class="sd">         angular distance of object from the moon.</span>
<span class="sd">     kzen : float</span>
<span class="sd">         zenight extinction coefficient (typically 0.15 or so for V)</span>
<span class="sd">     altmoon : Angle </span>
<span class="sd">         altitude of moon above horizon</span>
<span class="sd">     alt : Angle </span>
<span class="sd">         altitude of object above horizon</span>
<span class="sd">     moondist : Quantity</span>
<span class="sd">         distance to moon as an astropy Quantity</span>
<span class="sd">  </span>
<span class="sd">     Returns</span>
<span class="sd">  </span>
<span class="sd">     float</span>
<span class="sd">  </span>
<span class="sd">     &quot;&quot;&quot;</span>
  
 
<span class="c1">#  Evaluates predicted LUNAR part of sky brightness, in </span>
<span class="c1">#  V magnitudes per square arcsecond, following K. Krisciunas</span>
<span class="c1">#  and B. E. Schaeffer (1991) PASP 103, 1033.</span>
<span class="c1">#</span>
<span class="c1">#  alpha = separation of sun and moon as seen from earth,</span>
<span class="c1">#  converted internally to its supplement,</span>
<span class="c1">#  rho = separation of moon and object,</span>
<span class="c1">#  kzen = zenith extinction coefficient, </span>
<span class="c1">#  altmoon = altitude of moon above horizon,</span>
<span class="c1">#  alt = altitude of object above horizon </span>
<span class="c1">#  moondist = distance to moon, in earth radii</span>
<span class="c1">#</span>
<span class="c1">#  all the angles are Angles.</span>
 
     <span class="c1"># Will avoid this calculation if inappropriate, but for safety</span>
     <span class="c1"># return nonsense values if </span>
     <span class="k">if</span> <span class="n">altmoon</span> <span class="o">&lt;</span> <span class="mf">0.</span> <span class="p">:</span> <span class="k">return</span> <span class="mf">99.</span>              <span class="c1"># moon is down</span>
     <span class="k">if</span> <span class="n">alt</span> <span class="o">&lt;</span> <span class="mf">0.</span> <span class="p">:</span> <span class="k">return</span> <span class="mf">99.</span>           <span class="c1"># object is down</span>
     <span class="k">if</span> <span class="n">sunalt</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">10.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span> <span class="p">:</span> <span class="k">return</span> <span class="mf">99.</span>  <span class="c1"># bright twilight or daylight.</span>
 
     <span class="n">alpha</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="mf">180.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span> <span class="o">-</span> <span class="n">alpha</span> 
     <span class="n">Zmoon</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="mf">90.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span> <span class="o">-</span> <span class="n">altmoon</span>
     <span class="n">Z</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="mf">90.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span> <span class="o">-</span> <span class="n">alt</span>
     <span class="n">norm_moondist</span> <span class="o">=</span> <span class="n">moondist</span><span class="o">/</span><span class="p">(</span><span class="mf">60.27</span> <span class="o">*</span> <span class="n">thorconsts</span><span class="o">.</span><span class="n">EQUAT_RAD</span><span class="p">)</span>   <span class="c1"># divide by mean distance </span>
 
     <span class="n">istar</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.4</span><span class="o">*</span><span class="p">(</span><span class="mf">3.84</span> <span class="o">+</span> <span class="mf">0.026</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">alpha</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span> <span class="o">+</span> <span class="mf">4.0e-9</span><span class="o">*</span><span class="n">alpha</span><span class="o">.</span><span class="n">deg</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># eqn 20</span>
<span class="c1">#     print &quot;istar&quot;,istar, &quot;norm_moondist&quot;,norm_moondist</span>
     <span class="n">istar</span> <span class="o">=</span>  <span class="p">(</span><span class="mf">10.</span> <span class="o">**</span> <span class="n">istar</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">norm_moondist</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)</span>
<span class="c1">#     print &quot;istar post exp&quot;,istar,&quot;alpha_deg&quot;,alpha.deg</span>
     <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">alpha</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">7.</span> <span class="p">:</span>   <span class="c1"># crude accounting for opposition effect </span>
         <span class="n">istar</span> <span class="o">=</span> <span class="n">istar</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.35</span> <span class="o">-</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">istar</span><span class="p">))</span>
 	<span class="c1"># 35 per cent brighter at full, effect tapering linearly to </span>
 	<span class="c1">#   zero at 7 degrees away from full. mentioned peripherally in </span>
 	<span class="c1">#   Krisciunas and Scheafer, p. 1035. */</span>
   
     <span class="c1"># print &quot;rho, cos(rho)&quot;,rho.rad,np.cos(rho)</span>

     <span class="n">fofrho</span> <span class="o">=</span> <span class="mf">229087.</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.06</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)</span>
     <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rho</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">10.</span><span class="p">:</span>
         <span class="n">fofrho</span> <span class="o">=</span> <span class="n">fofrho</span> <span class="o">+</span> <span class="mf">10.</span> <span class="o">**</span> <span class="p">(</span><span class="mf">6.15</span> <span class="o">-</span> <span class="n">rho</span><span class="o">.</span><span class="n">deg</span><span class="o">/</span><span class="mf">40.</span><span class="p">)</span> <span class="c1">#            /* eqn 21 */</span>
     <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rho</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.25</span> <span class="p">:</span>
         <span class="n">fofrho</span> <span class="o">=</span> <span class="n">fofrho</span> <span class="o">+</span> <span class="mf">6.2e7</span> <span class="o">/</span> <span class="p">(</span><span class="n">rho</span><span class="o">.</span><span class="n">deg</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># eqn 19 </span>
     <span class="k">else</span> <span class="p">:</span> <span class="n">fofrho</span> <span class="o">=</span> <span class="n">fofrho</span><span class="o">+</span><span class="mf">9.9e8</span>                   <span class="c1"># for 1/4 degree -- radius of moon! */</span>

     <span class="c1"># print &quot;fofrho&quot;,fofrho</span>

     <span class="n">Xzm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">0.96</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Zmoon</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)</span>
     <span class="k">if</span> <span class="n">Xzm</span> <span class="o">!=</span> <span class="mf">0.</span> <span class="p">:</span> 
         <span class="n">Xzm</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">Xzm</span><span class="p">;</span> 
     <span class="k">else</span> <span class="p">:</span> 
         <span class="n">Xzm</span> <span class="o">=</span> <span class="mf">10000.</span>     


     <span class="c1"># print &quot;Xzm&quot;,Xzm</span>

     <span class="n">Xo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">0.96</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> 
     <span class="k">if</span> <span class="n">Xo</span> <span class="o">!=</span> <span class="mf">0.</span> <span class="p">:</span> 
         <span class="n">Xo</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">Xo</span>
     <span class="k">else</span> <span class="p">:</span> 
         <span class="n">Xo</span> <span class="o">=</span> <span class="mf">10000.</span> 

     <span class="c1"># print &quot;Xo&quot;,Xo</span>

     <span class="n">Bmoon</span> <span class="o">=</span> <span class="n">fofrho</span> <span class="o">*</span> <span class="n">istar</span> <span class="o">*</span> <span class="mf">10.</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.4</span><span class="o">*</span><span class="n">kzen</span><span class="o">*</span><span class="n">Xzm</span><span class="p">)</span>  \
 	  <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="mf">10.</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.4</span><span class="o">*</span><span class="n">kzen</span><span class="o">*</span><span class="n">Xo</span><span class="p">))</span> <span class="c1">#   /* nanoLamberts */</span>

     <span class="c1"># print &quot;Bmoon&quot;,Bmoon</span>

     <span class="k">if</span> <span class="n">Bmoon</span> <span class="o">&gt;</span> <span class="mf">0.001</span> <span class="p">:</span>
        <span class="k">return</span>  <span class="mf">22.50</span> <span class="o">-</span> <span class="mf">1.08574</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Bmoon</span><span class="o">/</span><span class="mf">34.08</span><span class="p">)</span> <span class="c1"># /* V mag per sq arcs-eqn 1 */</span>
     <span class="k">else</span> <span class="p">:</span> <span class="k">return</span> <span class="mf">99.</span>                                     </div>
   
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span> <span class="p">:</span>

    <span class="n">jd</span> <span class="o">=</span> <span class="mf">2458297.75694</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="n">phase_descr</span><span class="p">(</span><span class="n">jd</span><span class="p">))</span>

    <span class="n">time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;jd&#39;</span><span class="p">)</span>
    <span class="n">accumoontest</span> <span class="o">=</span> <span class="n">lpsun</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;accumoon gives:&quot;</span><span class="p">,</span> <span class="n">lpsuntest</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="s1">&#39;hmsdms&#39;</span><span class="p">))</span>


</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">thorsky 0.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, John Thorstensen.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.6.
    </div>
  </body>
</html>